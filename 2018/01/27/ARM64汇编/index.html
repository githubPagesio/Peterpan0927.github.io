<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ARM64汇编 | Peterpan&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="上一次我们说过了ARM32，只是用来过渡，对于iOS来说，从iPhone5之后用的就已经全部都是ARM64了，因为每一种 CPU 的机器指令都是不一样的，因此对应的汇编语言也不一样，那么就来看看过渡之后的ARM有什么区别。">
<meta property="og:type" content="article">
<meta property="og:title" content="ARM64汇编">
<meta property="og:url" content="http://yoursite.com/2018/01/27/ARM64汇编/index.html">
<meta property="og:site_name" content="Peterpan's Blog">
<meta property="og:description" content="上一次我们说过了ARM32，只是用来过渡，对于iOS来说，从iPhone5之后用的就已经全部都是ARM64了，因为每一种 CPU 的机器指令都是不一样的，因此对应的汇编语言也不一样，那么就来看看过渡之后的ARM有什么区别。">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-01-27%20%E4%B8%8B%E5%8D%884.22.55.png">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-01-30%20%E4%B8%8B%E5%8D%881.56.34.png">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-01-30%20%E4%B8%8B%E5%8D%882.05.00.png">
<meta property="og:updated_time" content="2018-03-13T16:00:22.820Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ARM64汇编">
<meta name="twitter:description" content="上一次我们说过了ARM32，只是用来过渡，对于iOS来说，从iPhone5之后用的就已经全部都是ARM64了，因为每一种 CPU 的机器指令都是不一样的，因此对应的汇编语言也不一样，那么就来看看过渡之后的ARM有什么区别。">
<meta name="twitter:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-01-27%20%E4%B8%8B%E5%8D%884.22.55.png">
  
    <link rel="alternate" href="/atom.xml" title="Peterpan&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/p1.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/plugin/bganimation/bg.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <div class="outer">
        <div class="widget-wrap mobile-header">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="https://avatars0.githubusercontent.com/u/20333903?v=3&amp;s=460">
    <h2 class="author">Peter pan</h2>
    <h3 class="description">the mark of an educated mind is to be able to entertain a thought without accepting it</h3>
    <div class="count-box">
      <a href="/archives"><div><strong>82</strong><br>文章</div></a>
      <a href="/categories"><div><strong>79</strong><br>分类</div></a>
      <a href="/tags"><div><strong>14</strong><br>标签</div></a>
    </div>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
    </ul>
  </div>
</div>

        <section id="main"><article id="post-ARM64汇编" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/27/ARM64汇编/" class="article-date">
  <time class="post-time" datetime="2018-01-27T08:16:09.000Z" itemprop="datePublished">
    <span class="post-month">1月</span><br/>
    <span class="post-day">27</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ARM64汇编
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/ARM64/">ARM64</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-01-27%20%E4%B8%8B%E5%8D%884.22.55.png" alt=""></p>
<p>上一次我们说过了ARM32，只是用来过渡，对于iOS来说，从iPhone5之后用的就已经全部都是ARM64了，因为每一种 CPU 的机器指令都是不一样的，因此对应的汇编语言也不一样，那么就来看看过渡之后的ARM有什么区别。</p>
<a id="more"></a>
<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>首先要来扫一扫盲，我们生活中所说的arm64,armv7,i386这些分别对应着我们生活中的哪些设备呢？我以Apple系列来举个例子：</p>
<ul>
<li>armv7｜armv7s｜arm64都是ARM处理器的指令集</li>
<li>i386｜x86_64 是Mac处理器的指令集</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">arm64：iPhone6s | iphone6s plus｜iPhone6｜ iPhone6 plus｜iPhone5S | iPad Air｜ iPad mini2(iPad mini with Retina Display)</div><div class="line">armv7s：iPhone5｜iPhone5C｜iPad4(iPad with Retina Display)</div><div class="line">armv7：iPhone4｜iPhone4S｜iPad｜iPad2｜iPad3(The New iPad)｜iPad mini｜iPod Touch 3G｜iPod Touch4</div><div class="line"></div><div class="line">i386是针对intel通用微处理器32位处理器</div><div class="line">x86_64是针对x86架构的64位处理器</div><div class="line"></div><div class="line">模拟器32位处理器测试需要i386架构，</div><div class="line">模拟器64位处理器测试需要x86_64架构，</div><div class="line">真机32位处理器需要armv7,或者armv7s架构，</div><div class="line">真机64位处理器需要arm64架构。</div></pre></td></tr></table></figure>
<p>比如说我用5s来作为我的工程测试机，那么我在写MakeFile的之后指定其CPU架构的时候就会做一个兼容(ARCHS)：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">THEOS_DEVICE_IP = <span class="number">192.168</span><span class="number">.1</span><span class="number">.129</span></div><div class="line">ARCHS = armv7 arm64</div><div class="line">TARGET = iphone:latest:<span class="number">7.0</span></div><div class="line"></div><div class="line">include /opt/theos/makefiles/common.mk</div><div class="line"></div><div class="line">TWEAK_NAME = ios_test</div><div class="line">ios_test_FILES = Tweak.xm</div><div class="line">ios_test_FRAMEWORKS = UIKit</div><div class="line"></div><div class="line">include $(THEOS_MAKE_PATH)/tweak.mk</div><div class="line"></div><div class="line">after-install::</div><div class="line">	install.exec <span class="string">"killall -9 SpringBoard"</span></div></pre></td></tr></table></figure>
<p>这其中在第二行的时候指定了是兼容armv7和arm64架构的CPU</p>
<h1 id="寄存器的变化"><a href="#寄存器的变化" class="headerlink" title="寄存器的变化"></a>寄存器的变化</h1><p>从ARM32到ARM64的过程中，寄存器的变化其实是很大的，在ARM32中，我们使用的是R0～R14和一个PC寄存器：</p>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-01-30%20%E4%B8%8B%E5%8D%881.56.34.png" alt=""></p>
<p>但是在ARM64中，事情似乎变的不一样了(在ARMv7中使用的仍然还是ARM32)</p>
<ol>
<li>arm64有32个64bit长度的通用寄存器x0～x30，sp，可以只使用其中的32bit w0～w30。 </li>
<li>arm32只有16个32bit的通用寄存器r0~r12, lr, pc, sp. arm64有32个128bit SIMD寄存器v0～v31，arm32有16个128bit SIMD寄存器Q0～Q15，又可细分为32个64bit SIMD寄存器D0～D31。</li>
<li>对于函数调用来说，arm64前面8个参数都是通过寄存器来传递x0～x7， arm32前面4个参数通过寄存器来传递r0～r3，其他通过栈传递。</li>
<li>ARM64模式下，通用寄存器X18、X30不能被使用。而需要被自己写的过程所保护的是：X19、X20、X21、X22、X23、X24、X25、X26、X27、X28、X29寄存器；而SIMD寄存器需要保护的是V8、V9、V10、V11、V12、V13、V14、V15。</li>
</ol>
<h1 id="常用的汇编指令"><a href="#常用的汇编指令" class="headerlink" title="常用的汇编指令"></a>常用的汇编指令</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">MOV X1, X0  ;寄存器X0的值传给X1</div><div class="line">ADD X0, X1, X2  ;寄存器X1和X2的值相加后给X0</div><div class="line">SUB X0, X1, X2  ;寄存器X1和X2的值相减后给X0</div><div class="line"></div><div class="line">AND X0, X0, #0xF    ;X0和0xF相与后的值给X0</div><div class="line">ORR X0, X0, #0x10   ;X0和0x10相或后的值给X0</div><div class="line">EOR X0, X0, #0x11   ;X0和0x11相异或后的值给X0</div><div class="line"></div><div class="line">LDR(LDUR) X5, [X6, #0x8]  ;X6寄存器的值(地址)加0x8的地址内的值给X5</div><div class="line">STR(STUR) X0, [SP, #0x8]  ;X0的值给(SP+0x8)地址指向的空间</div><div class="line"></div><div class="line">STP X29, X30, [SP, #0x1]    ;入栈操作</div><div class="line">LDP X29, X30, [SP, #0x1]    ;出栈操作</div><div class="line"></div><div class="line">CBZ     比较，如果结果为0，就跳转到后面的指令</div><div class="line">CBNZ    比较，如果结果非0，就跳转到后面的指令</div><div class="line"></div><div class="line">CMP     比较指令，结果影响CSPR状态</div><div class="line"></div><div class="line">B/BL    绝对跳转,无返回值/绝对跳转,返回值地址保存到LR(X30)</div><div class="line">RET     子程序返回，返回地址保存到LR(X30)</div><div class="line"></div><div class="line">ADRP    用来定位数据段中的数据, 因为ASLR会导致代码及数据的地址随机化, 用ADRP来根据PC做辅助定位</div></pre></td></tr></table></figure>
<p>因为我们只是做一个基本的了解，只是为了可以大概的看懂反编译之后的汇编代码，所以只需要简单的介绍一下，知道意思即可，在上面的指令中我们尤其需要关注的就是BL指令了，作为逆向人员，需要对任何的跳转保持敏锐。</p>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-01-30%20%E4%B8%8B%E5%8D%882.05.00.png" alt=""></p>
<p>例如在上面的SpringBoard刷新函数中，我们去分析刷新到底干了什么重要的突破口也是跳转。</p>
<p>还有一个小点也需要注意的就是我们在指令中经常会看到三个操作数，如果是8086中的写法，我们将eax中的值加上20：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">add		eax, 20</div></pre></td></tr></table></figure>
<p>但是在ARM中，我们会采用将<code>eax</code>中的值加上20再赋值给<code>eax</code>这样的思想，所以也就是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">add		X0, X0, 20</div></pre></td></tr></table></figure>
<h1 id="OC反汇编测试"><a href="#OC反汇编测试" class="headerlink" title="OC反汇编测试"></a>OC反汇编测试</h1><p>简单的C语言反汇编我们在之前的过程中就已经很熟悉了，基本看到如下的代码开头我们就知道接下来是要干什么了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">push	ebp</div><div class="line">mov		ebp, esp</div><div class="line">...</div><div class="line">pop 	ebp</div></pre></td></tr></table></figure>
<p>那么我们在反汇编OC的程序的时候，情况是不是也是类似的呢？我们就来看看一个简单的类声明和实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">#import &quot;AppDelegate.h&quot;</div><div class="line"></div><div class="line">@interface Person : NSObject</div><div class="line">@property (nonatomic, copy) NSString *name;</div><div class="line">@property (nonatomic, assign) NSInteger age;</div><div class="line">- (instancetype)initWithName:(NSString *)name age:(NSInteger)age;</div><div class="line">@end</div><div class="line"></div><div class="line">@implementation Person</div><div class="line"></div><div class="line">- (instancetype)initWithName:(NSString *)name age:(NSInteger)age &#123;</div><div class="line">    </div><div class="line">    if (self = [super init]) &#123;</div><div class="line">        _name = name;</div><div class="line">        _age = age;</div><div class="line">    &#125;</div><div class="line">    return self;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div><div class="line"></div><div class="line">@implementation AppDelegate</div><div class="line"></div><div class="line">- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions &#123;</div><div class="line">    </div><div class="line">    [self personTestCode];</div><div class="line">    return YES;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)personTestCode &#123;</div><div class="line">    </div><div class="line">    Person *xiaoming = [[Person alloc] initWithName:@&quot;xiaoming&quot; age:20];</div><div class="line">    xiaoming.age = 21;</div><div class="line">    Person *zhangfei = [[Person alloc] init];</div><div class="line">    zhangfei.name = @&quot;zhangfei&quot;;</div><div class="line">    zhangfei.age = 24;</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>上面是一个Person类的简单实例化并赋值的代码，从ARM汇编的角度来分析一下吧，这里我们使用工具是Hopper：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div></pre></td><td class="code"><pre><div class="line">================ B E G I N N I N G   O F   P R O C E D U R E ================</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">                     -[Person initWithName:age:]:</div><div class="line">0000000100006584         sub        sp, sp, #0x60                               ; Objective C Implementation defined at 0x1000081f8 (instance)  0x1000081f8 是数据段的地址，Person类的实现</div><div class="line">0000000100006588         stp        x29, x30, [sp, #0x50]</div><div class="line">000000010000658c         add        x29, sp, #0x50 ;x29=sp+0x50</div><div class="line">0000000100006590         sub        x8, x29, #0x18 ;x8 = x29-0x18</div><div class="line">0000000100006594         movz       x9, #0x0        ;x9 = 0</div><div class="line">0000000100006598         stur       x0, [x29, #0xfffffff8] ;(x29+0xfffffff8) = x0</div><div class="line">000000010000659c         stur       x1, [x29, #0xfffffff0] </div><div class="line">00000001000065a0         stur       x9, [x29, #0xffffffe8] </div><div class="line">00000001000065a4         mov        x0, x8</div><div class="line">00000001000065a8         mov        x1, x2</div><div class="line">00000001000065ac         str        x3, [sp, #0x18] ;(sp+0x18)=x3 传进来的age参数</div><div class="line">00000001000065b0         bl         imp___stubs__objc_storeStrong</div><div class="line">00000001000065b4         add        x0, sp, #0x20   ;x0 = sp+0x20</div><div class="line">00000001000065b8         adrp       x8, #0x100008000 ;地址生成指令 代表Person(声明)这个类，和类实现地址差不多0x1000081f8</div><div class="line">00000001000065bc         add        x8, x8, #0xe30    ; @selector(init) x8 = x8+0xe30 即：x8 = [Super init] </div><div class="line">00000001000065c0         adrp       x9, #0x100008000 ;x9 = Person</div><div class="line">00000001000065c4         add        x9, x9, #0xe78  ; 0x100008e78</div><div class="line">00000001000065c8         movz       x1, #0x0    ;x1 = 0</div><div class="line">00000001000065cc         ldr        x2, [sp, #0x18] = x2 = (sp+0x18)</div><div class="line">00000001000065d0         stur       x2, [x29, #0xffffffe0] ;(x29+0xffffffe0) = x2</div><div class="line">00000001000065d4         ldur       x3, [x29, #0xfffffff8] ;(x29+0xfffffff8) = x3</div><div class="line">00000001000065d8         stur       x1, [x29, #0xfffffff8] ;x1 = x3</div><div class="line">00000001000065dc         str        x3, [sp, #0x20] ;(sp+0x20) = x3</div><div class="line">00000001000065e0         ldr        x9, [x9]    ;（x9) = x9 x9指向的地址里的值，赋值x9</div><div class="line">00000001000065e4         str        x9, [sp, #0x28] ;(sp+0x28) = x9</div><div class="line">00000001000065e8         ldr        x1, [x8] ;x1 = (x8)</div><div class="line">00000001000065ec         bl         imp___stubs__objc_msgSendSuper2</div><div class="line">00000001000065f0         sub        x8, x29, #0x8 ;x8 = x29+0x8</div><div class="line">00000001000065f4         mov        x9, x0</div><div class="line">00000001000065f8         stur       x9, [x29, #0xfffffff8]</div><div class="line">00000001000065fc         mov        x1, x0</div><div class="line">0000000100006600         str        x0, [sp, #0x10]</div><div class="line">0000000100006604         mov        x0, x8</div><div class="line">0000000100006608         bl         imp___stubs__objc_storeStrong self = [super init] 赋值存储完成</div><div class="line">000000010000660c         ldr        x8, [sp, #0x10]</div><div class="line">0000000100006610         cbz        x8, 0x100006654 ;如果x8==0，跳转到0x100006654</div><div class="line"></div><div class="line">0000000100006614         adrp       x8, #0x100008000 ;x8 = self</div><div class="line">0000000100006618         add        x8, x8, #0xe80   ;地址 x8 = x8+0xe80=_name _OBJC_IVAR_$_Person._name</div><div class="line">000000010000661c         ldur       x9, [x29, #0xffffffe8] ; x9 = (x29+0xffffffe8)</div><div class="line">0000000100006620         ldur       x10, [x29, #0xfffffff8];x10 = (x29+0xfffffff8)</div><div class="line">0000000100006624         ldrsw      x8, [x8] ;x8 = (x8) </div><div class="line">0000000100006628         add        x8, x10, x8 ;x8 = x10+x8</div><div class="line">000000010000662c         mov        x0, x8 ;x0 = x8</div><div class="line">0000000100006630         mov        x1, x9 ;x1 = x9</div><div class="line">0000000100006634         bl         imp___stubs__objc_storeStrong ;存储name完成</div><div class="line"></div><div class="line">0000000100006638         adrp       x8, #0x100008000 ;x8=self</div><div class="line">000000010000663c         add        x8, x8, #0xe84   ;_age = age    _OBJC_IVAR_$_Person._age</div><div class="line">0000000100006640         ldur       x9, [x29, #0xffffffe0]</div><div class="line">0000000100006644         ldur       x10, [x29, #0xfffffff8]</div><div class="line">0000000100006648         ldrsw      x8, [x8]</div><div class="line">000000010000664c         add        x8, x10, x8</div><div class="line">0000000100006650         str        x9, [x8] ;存储age完成</div><div class="line"></div><div class="line">0000000100006654         ldur       x8, [x29, #0xfffffff8]                      ; XREF=-[Person initWithName:age:]+140</div><div class="line">0000000100006658         mov        x0, x8</div><div class="line">000000010000665c         bl         imp___stubs__objc_retain</div><div class="line">0000000100006660         movz       x8, #0x0</div><div class="line">0000000100006664         sub        x30, x29, #0x18</div><div class="line">0000000100006668         str        x0, [sp, #0x8]</div><div class="line">000000010000666c         mov        x0, x30</div><div class="line">0000000100006670         mov        x1, x8</div><div class="line">0000000100006674         bl         imp___stubs__objc_storeStrong</div><div class="line">0000000100006678         movz       x8, #0x0</div><div class="line">000000010000667c         sub        x0, x29, #0x8</div><div class="line">0000000100006680         mov        x1, x8</div><div class="line">0000000100006684         bl         imp___stubs__objc_storeStrong</div><div class="line">0000000100006688         ldr        x0, [sp, #0x8]</div><div class="line">000000010000668c         ldp        x29, x30, [sp, #0x50]</div><div class="line">0000000100006690         add        sp, sp, #0x60</div><div class="line">0000000100006694         ret        </div><div class="line">                        ; endp</div><div class="line"></div><div class="line"></div><div class="line">================ B E G I N N I N G   O F   P R O C E D U R E ================</div><div class="line"></div><div class="line">                     -[AppDelegate personTestCode]:</div><div class="line">0000000100006860         sub        sp, sp, #0x30                               ; Objective C Implementation defined at 0x100008cf0 (instance)</div><div class="line">0000000100006864         stp        x29, x30, [sp, #0x20]</div><div class="line">0000000100006868         add        x29, sp, #0x20</div><div class="line">000000010000686c         adrp       x8, #0x100008000  ;x8为Person类</div><div class="line">0000000100006870         add        x8, x8, #0xe40                              ; @selector(alloc) x8 = [Person alloc]</div><div class="line">0000000100006874         adrp       x9, #0x100008000</div><div class="line">0000000100006878         add        x9, x9, #0xe68                              ; objc_cls_ref_Person  x9为person对象</div><div class="line">000000010000687c         stur       x0, [x29, #0xfffffff8]</div><div class="line">0000000100006880         str        x1, [sp, #0x10]</div><div class="line">0000000100006884         ldr        x9, [x9]</div><div class="line">0000000100006888         ldr        x1, [x8]</div><div class="line">000000010000688c         mov        x0, x9</div><div class="line">0000000100006890         bl         imp___stubs__objc_msgSend ;调用init</div><div class="line">0000000100006894         adrp       x8, #0x100008000</div><div class="line">0000000100006898         add        x8, x8, #0x70                               ; @&quot;xiaoming&quot;  ;参数name</div><div class="line">000000010000689c         movz       x3, #0x14 ;参数age=20</div><div class="line">00000001000068a0         adrp       x9, #0x100008000</div><div class="line">00000001000068a4         add        x9, x9, #0xe48                              ; @selector(initWithName:age:) ;x9为初始化方法的地址</div><div class="line">00000001000068a8         ldr        x1, [x9]</div><div class="line">00000001000068ac         mov        x2, x8</div><div class="line">00000001000068b0         bl         imp___stubs__objc_msgSend ;调用initWithName:age:</div><div class="line">00000001000068b4         movz       x2, #0x15 ; 参数x2=age=21</div><div class="line">00000001000068b8         adrp       x8, #0x100008000</div><div class="line">00000001000068bc         add        x8, x8, #0xe50                              ; @selector(setAge:) ;x8为setAge:方法地址</div><div class="line">00000001000068c0         str        x0, [sp, #0x8]</div><div class="line">00000001000068c4         ldr        x9, [sp, #0x8]</div><div class="line">00000001000068c8         ldr        x1, [x8]</div><div class="line">00000001000068cc         mov        x0, x9</div><div class="line">00000001000068d0         bl         imp___stubs__objc_msgSend ;调用setAge:</div><div class="line"></div><div class="line"></div><div class="line">00000001000068d4         adrp       x8, #0x100008000</div><div class="line">00000001000068d8         add        x8, x8, #0xe40   ; @selector(alloc) [Person alloc]</div><div class="line">00000001000068dc         adrp       x9, #0x100008000</div><div class="line">00000001000068e0         add        x9, x9, #0xe68                              ; objc_cls_ref_Person</div><div class="line">00000001000068e4         ldr        x9, [x9]</div><div class="line">00000001000068e8         ldr        x1, [x8]</div><div class="line">00000001000068ec         mov        x0, x9</div><div class="line">00000001000068f0         bl         imp___stubs__objc_msgSend ;调用alloc</div><div class="line"></div><div class="line">00000001000068f4         adrp       x8, #0x100008000</div><div class="line">00000001000068f8         add        x8, x8, #0xe30                              ; @selector(init)</div><div class="line">00000001000068fc         ldr        x1, [x8]</div><div class="line">0000000100006900         bl         imp___stubs__objc_msgSend ;调用init</div><div class="line"></div><div class="line">0000000100006904         adrp       x8, #0x100008000</div><div class="line">0000000100006908         add        x8, x8, #0x90                               ; @&quot;zhangfei&quot; ;参数name</div><div class="line">000000010000690c         adrp       x9, #0x100008000</div><div class="line">0000000100006910         add        x9, x9, #0xe58  ; @selector(setName:) ;person setName: 方法地址</div><div class="line">0000000100006914         str        x0, [sp]</div><div class="line">0000000100006918         ldr        x0, [sp]</div><div class="line">000000010000691c         ldr        x1, [x9]</div><div class="line">0000000100006920         mov        x2, x8</div><div class="line">0000000100006924         bl         imp___stubs__objc_msgSend ; 调用setName: </div><div class="line"></div><div class="line">0000000100006928         orr        x2, xzr, #0x18 ;参数age=24</div><div class="line">000000010000692c         adrp       x8, #0x100008000</div><div class="line">0000000100006930         add        x8, x8, #0xe50                              ; @selector(setAge:) ;setAge:方法地址</div><div class="line">0000000100006934         ldr        x9, [sp]</div><div class="line">0000000100006938         ldr        x1, [x8]</div><div class="line">000000010000693c         mov        x0, x9</div><div class="line">0000000100006940         bl         imp___stubs__objc_msgSend ;调用setAge:</div><div class="line"></div><div class="line">0000000100006944         movz       x8, #0x0</div><div class="line">0000000100006948         mov        x9, sp</div><div class="line">000000010000694c         mov        x0, x9</div><div class="line">0000000100006950         mov        x1, x8</div><div class="line">0000000100006954         bl         imp___stubs__objc_storeStrong</div><div class="line">0000000100006958         movz       x8, #0x0</div><div class="line">000000010000695c         add        x9, sp, #0x8</div><div class="line">0000000100006960         mov        x0, x9</div><div class="line">0000000100006964         mov        x1, x8</div><div class="line">0000000100006968         bl         imp___stubs__objc_storeStrong</div><div class="line"></div><div class="line">000000010000696c         ldp        x29, x30, [sp, #0x20]</div><div class="line">0000000100006970         add        sp, sp, #0x30</div><div class="line">0000000100006974         ret        </div><div class="line">                        ; endp</div></pre></td></tr></table></figure>
<p>看到上面的代码千万不要头痛，其实过程没有想象中的那么复杂，只需要了解大致的意思即可，从我们的目的角度出发，并不是为了写这样子的汇编代码，仅仅是读懂罢了，整个的难度骤然降低，只不过当整个工程很大的时候，如果我们不能准确的定位目标函数，可能就会非常的头痛了！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/01/27/ARM64汇编/" data-id="cjesc0hs0000fvmbr3fv420vq" class="article-share-link">Partager</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/汇编/">汇编</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/02/02/iOS逆向学习-三/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Récent</strong>
      <div class="article-nav-title">
        
          iOS逆向学习(三)
        
      </div>
    </a>
  
  
    <a href="/2018/01/25/蓝桥杯java习题解读/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Ancien</strong>
      <div class="article-nav-title">蓝桥杯java习题解读</div>
    </a>
  
</nav>

  
</article>



</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <h1 class="blog-title">Peterpan&#39;s Blog</h1>
    <h2 class="blog-subtitle">Mind over muscle.</h2>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
    </ul>
  </div>
</div>

  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="https://avatars0.githubusercontent.com/u/20333903?v=3&amp;s=460">
    <h2 class="author">Peter pan</h2>
    <h3 class="description">the mark of an educated mind is to be able to entertain a thought without accepting it</h3>
    <div class="count-box">
      <a href="/archives"><div><strong>82</strong><br>文章</div></a>
      <a href="/categories"><div><strong>79</strong><br>分类</div></a>
      <a href="/tags"><div><strong>14</strong><br>标签</div></a>
    </div>



    <div class="social-link">
      
        <a class="hvr-bounce-in" href="http://github.com/Peterpan0927" target="_blank" title="Github">
          Github
        </a>
      
    </div>

    <div class="friend-link">
      <h2>友情链接</h2>
      
        <a class="hvr-bounce-in" href="imbajin.com" target="_blank" title="Jin">
          Jin
        </a>
      
    </div>
  </div>
</div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy;2017 - 2018 Peter pan<br>
      由<a href="http://hexo.io/" target="_blank">Hexo</a>强力驱动 | 
      主题-<a href="https://github.com/ShanaMaid/hexo-theme-shana">Shana</a>
      
    </div>
    
  </div>
</footer>
    </div>
    

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//apps.bdimg.com/libs/wow/0.1.6/wow.min.js"></script>
<script>
new WOW().init();
</script>   


  <link rel="stylesheet" href="/plugin/fancybox/jquery.fancybox.css">
  <script src="/plugin/fancybox/jquery.fancybox.pack.js"></script>



  <link rel="stylesheet" href="/plugin/galmenu/GalMenu.css">
  <script src="/plugin/galmenu/GalMenu.js"></script>
  <div class="GalMenu GalDropDown">
      <div class="circle" id="gal">
        <div class="ring">
          
            <a href="/" title="" class="menuItem">首页</a>
          
            <a href="/tags" title="" class="menuItem">标签</a>
          
            <a href="/about" title="" class="menuItem">音乐</a>
          
            <a href="/archives" title="" class="menuItem">归档</a>
          
            <a href="https://github.com/Peterpan0927" title="" class="menuItem">Github</a>
          
            <a href="ftp://118.89.38.168" title="" class="menuItem">FTP</a>
          
        </div>
        
          <audio id="audio" src="plugin/galmenu/wulusai.mp3"></audio>
        
      </div> 
</div>
<div id="overlay" style="opacity: 1; cursor: pointer;"></div>
  <script type="text/javascript">var items = document.querySelectorAll('.menuItem');
    for (var i = 0,
    l = items.length; i < l; i++) {
      items[i].style.left = (50 - 35 * Math.cos( - 0.5 * Math.PI - 2 * (1 / l) * i * Math.PI)).toFixed(4) + "%";
      items[i].style.top = (50 + 35 * Math.sin( - 0.5 * Math.PI - 2 * (1 / l) * i * Math.PI)).toFixed(4) + "%"
    }</script>
<script type="text/javascript">
  $(document).ready(function() {
    $('body').GalMenu({
      'menu': 'GalDropDown'
    })
  });
</script>

  <section class="hidden-xs"> 
  <ul class="cb-slideshow"> 
    <li><span>苟利</span></li> 
    <li><span>国家</span></li> 
    <li><span>生死以</span></li> 
    <li><span>岂能</span></li> 
    <li><span>祸福</span></li> 
    <li><span>趋避之</span></li> 
  </ul>
</section>
<script src="/js/script.js"></script>



  </div>
</body>
</html>