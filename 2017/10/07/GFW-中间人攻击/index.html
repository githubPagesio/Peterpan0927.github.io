<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>GFW&amp;中间人攻击 | Peterpan&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="网络安全一直是一个非常重要的领域，但是想要在这个领域有所作为的同学必定要有一些必备的基础知识，不然只会寸步难行。这里就来普及一些在安全领域中一些基础知识和有趣的攻击手段">
<meta property="og:type" content="article">
<meta property="og:title" content="GFW&中间人攻击">
<meta property="og:url" content="http://yoursite.com/2017/10/07/GFW-中间人攻击/index.html">
<meta property="og:site_name" content="Peterpan's Blog">
<meta property="og:description" content="网络安全一直是一个非常重要的领域，但是想要在这个领域有所作为的同学必定要有一些必备的基础知识，不然只会寸步难行。这里就来普及一些在安全领域中一些基础知识和有趣的攻击手段">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%8812.22.30.png">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%8812.23.42.png">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%8812.35.22.png">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%8812.36.06.png">
<meta property="og:image" content="https://liweitianux.files.wordpress.com/2011/04/ovpn-logo.png?w=135&h=25">
<meta property="og:image" content="https://liweitianux.files.wordpress.com/2011/04/5stars.png?w=130&h=25">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%881.04.43.png">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%881.08.55.png">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%881.41.22.png">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%881.43.19.png">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%881.57.08.png">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%882.08.36.png">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%882.09.32.png">
<meta property="og:updated_time" content="2018-03-13T16:00:22.792Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="GFW&中间人攻击">
<meta name="twitter:description" content="网络安全一直是一个非常重要的领域，但是想要在这个领域有所作为的同学必定要有一些必备的基础知识，不然只会寸步难行。这里就来普及一些在安全领域中一些基础知识和有趣的攻击手段">
<meta name="twitter:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%8812.22.30.png">
  
    <link rel="alternate" href="/atom.xml" title="Peterpan&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/p1.png">
  
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/plugin/bganimation/bg.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <div class="outer">
        <div class="widget-wrap mobile-header">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-03-22%20%E4%B8%8B%E5%8D%8811.42.23.png">
    <h2 class="author">Peter pan</h2>
    <h3 class="description">the mark of an educated mind is to be able to entertain a thought without accepting it</h3>
    <div class="count-box">
      <a href="/archives"><div><strong>99</strong><br>文章</div></a>
      <a href="/categories"><div><strong>91</strong><br>分类</div></a>
      <a href="/tags"><div><strong>14</strong><br>标签</div></a>
    </div>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
    </ul>
  </div>
</div>

        <section id="main"><article id="post-GFW-中间人攻击" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/10/07/GFW-中间人攻击/" class="article-date">
  <time class="post-time" datetime="2017-10-07T05:56:52.000Z" itemprop="datePublished">
    <span class="post-month">10月</span><br/>
    <span class="post-day">07</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      GFW&amp;中间人攻击
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/GFW封锁机制-中间人攻击-数字签名/">GFW封锁机制 中间人攻击 数字签名</a>
  </div>

          
              
  &nbsp; | &nbsp;
  <div class="view-box">
    <span id="/2017/10/07/GFW-中间人攻击/" class="leancloud_visitors" data-flag-title="GFW&amp;中间人攻击">
      &nbsp;阅读次数<span class="leancloud-visitors-count"></span>
    </span>
  </div>


          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>网络安全一直是一个非常重要的领域，但是想要在这个领域有所作为的同学必定要有一些必备的基础知识，不然只会寸步难行。这里就来普及一些在安全领域中一些基础知识和有趣的攻击手段</p>
<a id="more"></a>
<h1 id="安全知识小杂烩"><a href="#安全知识小杂烩" class="headerlink" title="安全知识小杂烩"></a>安全知识小杂烩</h1><h2 id="the-Great-Fire-Wall"><a href="#the-Great-Fire-Wall" class="headerlink" title="the Great Fire Wall"></a>the Great Fire Wall</h2><p>大天朝的GFW广为人知，GFW主要是指天朝政府监控和过滤互联网国际出口上的内容的软硬件集合，作用想必也不用多说。首先要扫盲一下GFW的部署位置，天朝的互联网国际出口都集中在北京、上海、广州等几个少数区域，而这些位置也就是GFW的设备所在处。目前在国内基本访问不了Google或者youtube之类的站点，就算是要从github上下一个东西都需要等很久。</p>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%8812.22.30.png" alt=""></p>
<h3 id="GFW清扫手段"><a href="#GFW清扫手段" class="headerlink" title="GFW清扫手段"></a>GFW清扫手段</h3><h4 id="1-DNS污染和劫持"><a href="#1-DNS污染和劫持" class="headerlink" title="1. DNS污染和劫持"></a>1. DNS污染和劫持</h4><blockquote>
<p>某些<a href="http://baike.baidu.com/view/1383414.htm" target="_blank" rel="external">网络运营商</a>为了某些目的，对<a href="http://baike.baidu.com/subview/22276/15346050.htm" target="_blank" rel="external">DNS</a>进行了某些操作，导致使用<a href="http://baike.baidu.com/subview/855/5889203.htm" target="_blank" rel="external">ISP</a>的正常上网设置无法通过域名取得正确的IP地址。</p>
<p>某些国家或地区出于某些目的为了防止某网站被访问，而且其又掌握部分国际DNS根目录服务器或镜像，也会利用此方法进行屏蔽。</p>
</blockquote>
<p>目前我们访问网站主要都是通过域名进行访问，而真正访问这个网站前需要通过DNS服务器把域名解析为IP地址。而普通的DNS服务使用UDP协议，没有任何的认证机制。DNS劫持是指返回给你一个伪造页面的IP地址，DNS污染是返回给你一个不存在的页面的IP地址。DNS污染又分为了直接污染和间接污染，这个可以之后自己查询。</p>
<p>比如你使用电信、联通、移动的宽带，默认你是不需要设置任何DNS服务器的。这些DNS服务器由他们提供。一旦检测到你访问的网页是不允许的访问的，就会返回一个不存在的网页。而很多运营商也会使用DNS劫持来投放一些广告。比如某些ISP和xx合作，篡改了域名记录将谷歌的流量导向百度，也就是说你在浏览器中输入www.google.com，浏览器却打开了xx的主页。</p>
<h4 id="解决方式："><a href="#解决方式：" class="headerlink" title="解决方式："></a>解决方式：</h4><ol>
<li>使用<a href="https://www.opendns.com/setupguide/" target="_blank" rel="external">OpenDNS</a>（208.67.222.222）或<a href="https://developers.google.com/speed/public-dns/" target="_blank" rel="external">GoogleDNS</a>（8.8.8.8）（现在不太好用，被封锁，速度慢）</li>
<li>使用一些第三方的DNS服务器</li>
<li>自己用VPS搭建DNS服务器</li>
<li>使用/etc/hosts文件，直接IP访问,本地DNS缓存</li>
</ol>
<h4 id="2-IP路由劫持"><a href="#2-IP路由劫持" class="headerlink" title="2. IP路由劫持"></a>2. IP路由劫持</h4><p>通过上面一些方式，可以绕过DNS污染，通过IP地址访问无法访问的网页。但是目前针对IP进行大范围的封锁。虽然google这种大公司有很多镜像IP地址，但是目前基本全部被封锁掉，有漏网的可能也坚持不了多久。而且很多小公司的服务是部署在一些第三方的主机上，所以封锁IP有时会误伤，封锁一个IP导致主机上本来可以使用的页面也无法访问了。</p>
<p>不过目前不可能把所有国外的IP全部封锁掉，所以我们采用机会从国内连接到国外的VPS，进行翻墙。</p>
<h4 id="解决办法："><a href="#解决办法：" class="headerlink" title="解决办法："></a>解决办法：</h4><ol>
<li>使用VPS搭建代理</li>
<li>使用IPV6 （IPV6地址巨大，采用封地址不现实，但是目前国内只有部分高校部署了IPV6）</li>
</ol>
<p>ps:只有全国前二十的高校的才开放了部分部署了IPv6的，咸鱼们还是老老实实磨练自己的技术吧</p>
<h4 id="3-封锁HTTP代理"><a href="#3-封锁HTTP代理" class="headerlink" title="3. 封锁HTTP代理"></a>3. 封锁HTTP代理</h4><p>如果不想搭建VPS的话，最好的方法就是使用HTTP代理(最后同时配置http和https代理)。客户端不再直接请求目标服务器，而是请求代理服务器，然后返回结果。</p>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%8812.23.42.png" alt=""></p>
<p>对于这种http代理封锁起来是非常简单的，因为http协议是明文，请求头部信息中就会包含请求的url或IP地址，一下就被检测到了。有人就会说那我就用https好了，加密一下你总检测不大了吧，但是然并卵啊，虽然通信被加密了，但是在建立连接之前会给代理服务器发送CONNECT方法，这里会带上要访问的远端服务器地址，然后，然后就没有然后了。</p>
<h4 id="解决方法："><a href="#解决方法：" class="headerlink" title="解决方法："></a>解决方法：</h4><ol>
<li>使用VPS搭建VPN</li>
<li>自己不会搭建就用别人的吧</li>
</ol>
<h3 id="4-封锁VPN"><a href="#4-封锁VPN" class="headerlink" title="4.封锁VPN"></a>4.封锁VPN</h3><blockquote>
<p><strong>虚拟专用网</strong>（英语：<strong>Virtual Private Network</strong>，简称<strong>VPN</strong>），是一种常用于连接中、大型企业或团体与团体间的私人网络的通讯方法。虚拟私人网络的讯息透过公用的网络架构（例如：<a href="https://zh.wikipedia.org/wiki/%E4%BA%92%E8%81%94%E7%BD%91" target="_blank" rel="external">互联网</a>）来传送<a href="https://zh.wikipedia.org/wiki/%E5%85%A7%E8%81%AF%E7%B6%B2" target="_blank" rel="external">内联网</a>的网络讯息。它利用已加密的<a href="https://zh.wikipedia.org/wiki/%E9%80%9A%E9%81%93%E5%8D%94%E8%AD%B0" target="_blank" rel="external">通道协议</a>（Tunneling Protocol）来达到保密、发送端认证、消息准确性等私人消息安全效果。</p>
</blockquote>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%8812.35.22.png" alt=""></p>
<p>正常网络通信时，所有网络请求都是通过我们的物理网卡直接发送出去。而VPN是客户端使用相应的VPN协议先与VPN服务器进行通信，成功连接后就在操作系统内建立一个虚拟网卡，一般来说默认PC上所有网络通信都从这虚拟网卡上进出，经过VPN服务器中转之后再到达目的地（VPN相当于我们走了一个专线，一般是用作加速）。</p>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%8812.36.06.png" alt=""></p>
<p>通常VPN协议都会对数据流进行强加密处理，从而使得第三方无法知道数据内容，这样就实现了翻墙。翻墙时VPN服务器知道你干的所有事情（HTTP，对于HTTPS，它知道你去了哪）。</p>
<p>VPN有多种协议：OPENVPN、PPTP、L2TP/IPSec、SSLVPN、IKEv2 VPN，Cisco VPN等。其中的PPTP和L2TP是明文传输协议。只负责传输，不负责加密。分别利用了MPPE和IPSec进行加密。</p>
<table>
<thead>
<tr>
<th></th>
<th>[<img src="https://liweitianux.files.wordpress.com/2011/04/ovpn-logo.png?w=135&amp;h=25" alt=""></th>
</tr>
</thead>
<tbody>
<tr>
<td>背景</td>
<td>PPTP 是一个基于 PPP 的很基本的协议。PPTP 是微软 Windows 平台第一个支持的 VPN 协议。PPTP 标准并没有实际描述加密和授权特性，并且依赖于 PPP 协议的隧道来实现安全功能。</td>
<td>L2TP 是一个在 IETF <a href="https://tools.ietf.org/html/rfc3193" target="_blank" rel="external">RFC 3193</a> 中被正式标准化的高级协议。推荐在需要安全加密的地方用来替代 PPTP。</td>
<td>OpenVPN 是一个高级的开源 VPN 解决方案，由 “OpenVPN technologies” 支持，并且已经成为开源网络领域里的事实标准。OpenVPN 使用成熟的 SSL/TLS 加密协议。</td>
</tr>
<tr>
<td>数据加密</td>
<td>PPP 负载是使用微软点对点协议（Microsoft’s Point-to-Point Encryption protocol，<a href="https://en.wikipedia.org/wiki/Microsoft_Point-to-Point_Encryption" target="_blank" rel="external">MPPE</a>）加密。MPPE 实现了 RSA <a href="https://en.wikipedia.org/wiki/RC4" target="_blank" rel="external">RC4</a> 加密算法，并使用最长 128 位密钥。</td>
<td>L2TP 负载使用标准的 IPSec 协议加密。在 <a href="https://tools.ietf.org/html/rfc4835" target="_blank" rel="external">RFC 4835</a> 中指定了使用 3DES 或 AES 加密算法作为保密方式。</td>
<td>OpenVPN 使用 <a href="https://en.wikipedia.org/wiki/OpenSSL" target="_blank" rel="external">OpenSSL</a> 库来提供加密。OpenSSL 支持好几种不同的加密算法，如：3DES，AES，RC5 等。</td>
</tr>
<tr>
<td>安装/配置</td>
<td>Windows 所有版本和大多数其他操作系统包括移动平台都内建了对 PPTP 的支持。PPTP 只需要一个用户名和密码，以及一个服务器地址，所以安装和配置相当简单。</td>
<td>从 2000/XP 起的所有 Windows 平台和 Mac OS X 10.3+ 都内建了 L2TP/IPSec 的支持。大多数现代的移动平台比如 iPhone 和 Android 也有内建的客户端。</td>
<td>OpenVPN 不包含在任何操作系统中，需要安装客户端软件，但安装也是相当简单，基本上 5 分钟可以完成。</td>
</tr>
<tr>
<td>速度</td>
<td>由于使用 128 位密钥，加密开销相比 OpenVPN 使用 256位密钥要小，所以速度感觉稍快一点，但这个差异微不足道。</td>
<td>L2TP/IPSec 将数据封装两次，所以相比其他竞争者效率稍低，速度也慢一些。</td>
<td>当使用默认的 UDP 模式，OpenVPN 的表现是最佳的。</td>
</tr>
<tr>
<td>端口</td>
<td>PPTP 使用 TCP 1723 端口和 GRE（协议 47）。通过限制 GRE 协议，PPTP 可以轻易地被封锁。</td>
<td>L2TP/IPSec 使用 UDP 500 端口用来初始化密钥交换，使用协议 50 用来传输 IPSec 加密的数据（ ESP ），使用 UDP 1701 端口用来初始化 L2TP 的配置，还使用 UDP 4500 端口来穿过 NAT。L2TP/IPSec 相比 OpenVPN 容易封锁，因为它依赖于固定的协议和端口。</td>
<td>OpenVPN 可以很容易的配置为使用任何端口运行，也可以使用 UDP 或 TCP 协议。为了顺利穿越限制性的防火墙，可以将 OpenVPN 配置成使用 TCP 443 端口，因为这样就无法和标准的 HTTPS 无法区分，从而极难被封锁。</td>
</tr>
<tr>
<td>稳定性/兼容性</td>
<td>PPTP 不如 OpenVPN 可靠，也不能像 OpenVPN 那样在不稳定网络中快速恢复。另外还有部分同 GRE 协议和一些路由器的兼容性问题。</td>
<td>L2TP/IPSec 比 OpenVPN 更复杂，为了使在 NAT 路由器下的设备可靠地使用，配置可以会更加困难。但是，只要服务器和客户端都支持 NAT 穿越，那么就没什么问题了。</td>
<td>无论是无线网络、蜂窝网络，还是丢包和拥塞经常发生的不可靠网络，OpenVPN 都非常稳定、快速。对于那些相当不可以的连接，OpenVPN 有一个 TCP 模式可以使用，但是要牺牲一点速度，因为将 TCP 封装在 TCP 时效率不高。</td>
</tr>
<tr>
<td>安全弱点</td>
<td>微软实现的 PPTP 有一个严重的安全问题（<a href="https://www.schneier.com/paper-pptpv2.html" target="_blank" rel="external">serious security vulnerabilities</a>）。对于词典攻击来说 MSCHAP-v2 是很脆弱的，并且 RC4 算法也会遭到“<a href="https://en.wikipedia.org/wiki/Bit-flipping_attack" target="_blank" rel="external">位翻转攻击（ bit-flipping attack ）</a>”。如果保密是重要的，微软也强烈建议升级到 IPSec。</td>
<td>IPSec 没有明显的漏洞，当和安全加密算法如 AES 一起使用时，被认为是很安全的。</td>
<td>OpenVPN 也没有明显漏洞，当和安全加密算法如 AES 一起使用时，也被认为是相当安全的。</td>
</tr>
<tr>
<td>客户端的兼容性</td>
<td>WindowsMac OS XLinuxApple iOSAndroidDD-WRT</td>
<td>WindowsMac OS XLinuxApple iOSAndroid</td>
<td>WindowsMac OS XLinux</td>
</tr>
<tr>
<td>结论</td>
<td>由于主要的安全漏洞，除了兼容性以外没有好的理由选择使用 PPTP。如果你的设备既不支持 L2TP/IPSec 又不支持 OpenVPN，那么 PPTP 是一个合理的选择。如果关心快速安装和简易配置，那么 L2TP/IPSec 值得考虑。</td>
<td>L2TP/IPSec 是优秀的，但相比 OpenVPN 的高效和杰出的稳定性要落后一点。如果你使用运行 iOS 或 Android 的移动设备，那么这就是最佳的选择，因为 OpenVPN 目前还不支持这些平台。另外，如果需要快速安装，L2TP/IPSec 也是一个较佳的选择。</td>
<td>对于所有的 Windows, Mac OS X 以及 Linux 桌面用户来说，OpenVPN 是最好的选择。OpenVPN 速度快，并且安全可信。但劣势是缺乏对移动设备的支持，另外还需要安装第三方客户端。</td>
</tr>
<tr>
<td>等级</td>
<td><img src="https://liweitianux.files.wordpress.com/2011/04/5stars.png?w=130&amp;h=25" alt=""></td>
</tr>
</tbody>
</table>
<p>对于VPN和其他一些加密的传输的协议来说，没有办法直接获取明文的请求信息，所以没有办法直接封锁，而是使用了监控的方式：</p>
<p><strong>暴力破解：</strong></p>
<blockquote>
<p>对于一些使用弱加密方式的协议来说，直接使用暴力破解检查传输内容。比如PPTP使用MPPE加密，但是MPPE是基于RC4，对于强大的防火墙背后的超级计算机集群，破解就是几秒钟的事情。</p>
<p>破解后明文中一旦包含了违禁内容，请求就会被封。而对应的IP可能会进入重点关怀列表。</p>
</blockquote>
<p><strong>特征检测：</strong></p>
<blockquote>
<p>要想成功翻墙都必须与对应的远程服务器建立连接，然后再用对应的协议进行数据处理并传输。<br>而问题就出在这里：翻墙工具和远程服务器建立连接时，如果表现的很独特，在一大堆流量里很显眼，就会轻易被GFW识别出从而直接阻断连接，而VPN（尤其是OPENVPN）和SSH这方面的问题尤其严重。</p>
</blockquote>
<p>流量监控:</p>
<blockquote>
<p>当一个VPN地址被大量人请求，并保持长时间连接时，就很容易引起关注。SSH接口有大量数据请求。一般会结合其他特征。</p>
</blockquote>
<p>深度包检测：</p>
<blockquote>
<p><strong>深度数据包检测</strong>（英语：Deep packet inspection，缩写为 DPI），又称<strong>完全数据包探测</strong>（complete packet inspection）或<strong>信息萃取</strong>（Information eXtraction，IX），是一种<a href="https://zh.wikipedia.org/wiki/%E7%94%B5%E8%84%91%E7%BD%91%E7%BB%9C" target="_blank" rel="external">电脑网络</a><a href="https://zh.wikipedia.org/wiki/%E5%B0%81%E5%8C%85%E8%BF%87%E6%BB%A4" target="_blank" rel="external">数据包过滤</a>技术，用来检查通过检测点之<a href="https://zh.wikipedia.org/wiki/%E5%B0%81%E5%8C%85" target="_blank" rel="external">数据包</a>的<a href="https://zh.wikipedia.org/wiki/%E8%B3%87%E6%96%99" target="_blank" rel="external">数据</a>部分（亦可能包含其<a href="https://zh.wikipedia.org/wiki/%E6%A8%99%E9%A0%AD" target="_blank" rel="external">标头</a>），以搜索不匹配规范之协议、<a href="https://zh.wikipedia.org/wiki/%E9%9B%BB%E8%85%A6%E7%97%85%E6%AF%92" target="_blank" rel="external">病毒</a>、<a href="https://zh.wikipedia.org/wiki/%E5%9E%83%E5%9C%BE%E9%83%B5%E4%BB%B6" target="_blank" rel="external">垃圾邮件</a>、入侵，或以预定之准则来决定数据包是否可通过或需被路由至其他不同目的地，亦或是为了收集统计数据之目的。</p>
</blockquote>
<p>下面可以通过一张图来说明特征检测、流量监控的原理：</p>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%881.04.43.png" alt=""></p>
<p>有一些天朝的屁民觉得翻墙很帅，妄图利用一些免费或者收费的VPN去浏览一些危险的网站，想要搞个大新闻，其实是不存在的，被钓鱼执法的可能性也不是没有，所以提醒大家最好不要使用不安全的VPN来访问一些不合适的网页：</p>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%881.08.55.png" alt=""></p>
<p>这就是封锁VPN的手段图了，所谓道高一尺，魔高一丈，ss和ssr在这里暂且先不提。</p>
<h2 id="Man-in-Middle-attack"><a href="#Man-in-Middle-attack" class="headerlink" title="Man in Middle attack"></a>Man in Middle attack</h2><p>Man-in-middle attack中文翻译过来也就是中间人攻击，是指攻击者与通讯的两端分别创建独立的联系，并交换其所收到的数据，使通讯的两端认为他们正在通过一个私密的连接与对方直接对话，但事实上整个会话都被攻击者完全控制。</p>
<p>在中间人攻击中，攻击者可以拦截通讯双方的通话并插入新的内容。在许多情况下这是很简单的（例如，在一个未加密的<code>Wi-Fi 无线接入点</code>的接受范围内的中间人攻击者，可以将自己作为一个中间人插入这个网络，进而监控或者伪造所有的网络请求）。</p>
<p>一个中间人攻击能成功的前提条件是攻击者能将自己伪装成每一个参与会话的终端，并且不被其他终端识破。中间人攻击是一个缺乏相互认证的攻击。大多数的加密协议都专门加入了一些特殊的认证方法以阻止中间人攻击。例如，<a href="https://zh.wikipedia.org/wiki/SSL" target="_blank" rel="external">SSL</a>协议可以验证参与通讯的一方或双方使用的证书是否是由权威的受信任的数字证书认证机构颁发，并且能执行双向身份认证。</p>
<h3 id="数字签名"><a href="#数字签名" class="headerlink" title="数字签名"></a>数字签名</h3><p>既然说到了证书就来举例子形象的说一下什么是数字签名和数字证书，这里需要首先知道ssh以及公私钥的基础知识。</p>
<ol>
<li>现在鲍勃和他的朋友们采用RSA算法加密的邮件进行通信，鲍勃将自己的公钥分给自己的朋友，他的朋友使用公钥对邮件加密，然后鲍勃在用自己的私钥解密，本来只要私钥没有被泄漏，这个邮件就是安全的。</li>
<li>现在鲍勃给朋友们回信，决定采用数字签名。他写完邮件之后使用hash函数，生成邮件的摘要(digest):</li>
</ol>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%881.41.22.png" alt=""></p>
<ol>
<li>然后鲍勃在使用私钥对这个摘要进行加密，这样就生成了数字签名，然后把这个签名连同邮件一起发送<br><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%881.43.19.png" alt=""></li>
<li>朋友收到信件之后使用公钥解密，得到了信件摘要，确定是鲍勃发送过来的，再对邮件本体使用hash函数，和摘要进行对比，如果一样则表示邮件没有被修改过。</li>
<li>这个时候问题来了，有一个恶趣味的同学想要伪装成鲍勃和他朋友通信，偷偷溜进了他朋友的电脑，将鲍勃的公钥换成了自己的公钥，给他朋友发消息，来搞一些大新闻。</li>
<li>但是跑得快的香港朋友一向拥有怀疑精神，就想了一个办法确认这个公钥是不是属于鲍勃，他要求鲍勃去找”证书中心”（certificate authority，简称CA），为公钥做认证。证书中心用自己的私钥，对鲍勃的公钥和一些相关信息一起加密，生成”数字证书”（Digital Certificate）。</li>
</ol>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%881.57.08.png" alt=""></p>
<ol>
<li>有了这个权威认证之后，鲍勃再发送邮件，只需要在签名的同时，附上数字证书即可。</li>
<li>朋友收到邮件之后，用CA的公钥解开数字证书，就可以拿到真正的鲍勃公钥，对比一下就可以证实了</li>
</ol>
<p>我们生活中最常用的数字证书的例子就是https协议，这个协议主要用于网页加密</p>
<ol>
<li>首先客户端向服务端发送了一个加密请求</li>
<li>服务器用自己的私钥加密网页以后，连同本身的数字证书，一起发送给客户端。</li>
<li>客户端（浏览器）的”证书管理器”，有”受信任的根证书颁发机构”列表。客户端会根据这张列表，查看解开数字证书的公钥是否在列表之内。</li>
<li>如果证书没有问题，但是数字证书记载的网址，与你正在浏览的网址不一致，就说明这张证书可能被冒用，浏览器会发出警告。</li>
</ol>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%882.08.36.png" alt=""></p>
<ol>
<li>如果这张数字证书不是由受信任的机构颁发的，浏览器会发出另一种警告。</li>
</ol>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-10-07%20%E4%B8%8A%E5%8D%882.09.32.png" alt=""></p>
<ol>
<li>确认可靠之后，客户端就会使用证书中的服务器公钥，对信息加密，然后和服务器之间进行加密数据交换</li>
</ol>
<h3 id="中间人攻击示例"><a href="#中间人攻击示例" class="headerlink" title="中间人攻击示例"></a>中间人攻击示例</h3><p>假设爱丽丝希望与鲍伯通信。同时，马洛里希望拦截窃会话以进行窃听并可能在某些时候传送给鲍伯一个虚假的消息。</p>
<p>首先，爱丽丝会向鲍勃索取他的公钥。如果Bob将他的公钥发送给Alice，并且此时马洛里能够拦截到这个公钥，就可以实施中间人攻击。马洛里发送给爱丽丝一个伪造的消息，声称自己是鲍伯，并且附上了马洛里自己的（而不是鲍伯的）。</p>
<p>爱丽丝收到公钥后相信这个公钥是鲍伯的，于是爱丽丝将她的消息用马洛里的公钥（爱丽丝以为是鲍伯的）加密，并将加密后的消息回给鲍伯。马洛里再次截获爱丽丝回给鲍伯的消息，并使用马洛里自己的私钥对消息进行解密，如果马洛里愿意，她也可以对消息进行修改，然后马洛里使用鲍伯原先发给爱丽丝的公钥对消息再次加密。当鲍伯收到新加密后的消息时，他会相信这是从爱丽丝那里发来的消息。</p>
<p>1.爱丽丝发送给鲍伯一条消息，却被马洛里截获：</p>
<blockquote>
<p><strong>爱丽丝</strong> “嗨，鲍勃，我是爱丽丝。给我你的公钥”<em> –&gt; <strong>马洛里</strong> <em>*鲍勃</em></em></p>
</blockquote>
<p>2.马洛里将这条截获的消息转送给鲍伯；此时鲍伯并无法分辨这条消息是否从真的爱丽丝那里发来的：</p>
<blockquote>
<p><strong>爱丽丝</strong> <strong>马洛里*</strong>“嗨，鲍勃，我是爱丽丝。给我你的公钥”<em> –&gt; <em>*鲍伯</em></em></p>
</blockquote>
<p>3.鲍伯回应爱丽丝的消息，并附上了他的公钥：</p>
<blockquote>
<p><strong>爱丽丝</strong> <strong>马洛里</strong>&lt;– <em>[鲍伯的公钥]</em>– <strong>鲍伯</strong></p>
</blockquote>
<p>4.马洛里用自己的密钥替换了消息中鲍伯的密钥，并将消息转发给爱丽丝，声称这是鲍伯的公钥：</p>
<blockquote>
<p><strong>爱丽丝</strong>&lt;– <em>[马洛里的公钥]</em>– <strong>马洛里</strong> <strong>鲍勃</strong></p>
</blockquote>
<p>5.爱丽丝用她以为是鲍伯的公钥加密了她的消息，以为只有鲍伯才能读到它：</p>
<blockquote>
<p><strong>爱丽丝</strong> “我们在公共汽车站见面！”–[使用马洛里的公钥加密]<em> –&gt; <strong>马洛里</strong> <em>*鲍勃</em></em></p>
</blockquote>
<p>6.然而，由于这个消息实际上是用马洛里的密钥加密的，所以马洛里可以解密它，阅读它，并在愿意的时候修改它。他使用鲍伯的密钥重新加密，并将重新加密后的消息转发给鲍伯：</p>
<blockquote>
<p><strong>爱丽丝</strong> <strong>马洛里</strong> “在家等我！–[使用鲍伯的公钥加密]–&gt; <strong>鲍伯</strong></p>
</blockquote>
<p>7.鲍勃认为，这条消息是经由安全的传输通道从爱丽丝那里传来的。</p>
<p>这个例子显示了爱丽丝和鲍伯需要某种方法来确定他们是真正拿到了属于对方的公钥，而不是拿到来自攻击者的公钥。否则，这类攻击一般都是可行的，在原理上，可以针对任何使用公钥——密钥技术的通讯消息发起攻击。幸运的是，有各种不同的技术可以帮助抵御MITM攻击。</p>
<h3 id="防御攻击"><a href="#防御攻击" class="headerlink" title="防御攻击"></a>防御攻击</h3><p>那么这种攻击应该如何去防御呢，其实也是有很多种方式的：</p>
<ul>
<li>延迟测试，例如使用复杂加密哈希函数进行计算以造成数十秒的延迟；如果双方通常情况下都要花费20秒来计算，并且整个通讯花费了60秒计算才到达对方，这就能表明存在第三方中间人。</li>
<li>更强力的相互认证，例如：<ul>
<li>密钥（通常是高信息熵的密钥，从而更安全），或</li>
<li>密码（通常是低的信息熵的密钥，从而降低安全性）</li>
</ul>
</li>
</ul>
<h3 id="中间人攻击的取证分析"><a href="#中间人攻击的取证分析" class="headerlink" title="中间人攻击的取证分析"></a>中间人攻击的取证分析</h3><p>从被怀疑是中间人攻击的链接中捕捉网络数据包并进行分析可以确定是否存在中间人攻击。在进行网络分析并对可疑的SSL中间人攻击进行取证时，重要的分析证据包括：</p>
<ul>
<li>远程服务器的IP地址</li>
<li>DNS域名解析服务器</li>
<li>X.509证书服务器<ul>
<li>证书是自签名证书吗？</li>
<li>证书是由信任的颁发机构颁发的吗？</li>
<li>证书是否已被吊销？</li>
<li>证书最近被更改过吗？</li>
<li>在互联网上的其他的客户端是否也得到了相同的证书？</li>
</ul>
</li>
</ul>
<h4 id="参考博客"><a href="#参考博客" class="headerlink" title="参考博客"></a>参考博客</h4><ul>
<li><a href="https://program-think.blogspot.com/2014/01/dns.html" target="_blank" rel="external">编程随想的博客</a></li>
<li><a href="http://blog.021xt.cc/archives/85" target="_blank" rel="external">上网限制和翻墙基本原理</a></li>
<li><a href="http://www.youdzone.com/signature.html" target="_blank" rel="external">什么是数字签名</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/10/07/GFW-中间人攻击/" data-id="cjgopnnqy001o99brgq2a45ii" class="article-share-link">Partager</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/">CTF</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/10/15/TCP-IP-四/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Récent</strong>
      <div class="article-nav-title">
        
          TCP/IP(四)
        
      </div>
    </a>
  
  
    <a href="/2017/10/05/iOS多线程之GCD/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Ancien</strong>
      <div class="article-nav-title">iOS多线程之GCD</div>
    </a>
  
</nav>

  
</article>



</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <h1 class="blog-title">Peterpan&#39;s Blog</h1>
    <h2 class="blog-subtitle">Mind over muscle.</h2>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
    </ul>
  </div>
</div>

  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-03-22%20%E4%B8%8B%E5%8D%8811.42.23.png">
    <h2 class="author">Peter pan</h2>
    <h3 class="description">the mark of an educated mind is to be able to entertain a thought without accepting it</h3>
    <div class="count-box">
      <a href="/archives"><div><strong>99</strong><br>文章</div></a>
      <a href="/categories"><div><strong>91</strong><br>分类</div></a>
      <a href="/tags"><div><strong>14</strong><br>标签</div></a>
    </div>



    <div class="social-link">
      
        <a class="hvr-bounce-in" href="http://github.com/Peterpan0927" target="_blank" title="Github">
          Github
        </a>
      
    </div>

    <div class="friend-link">
      <h2>友情链接</h2>
      
        <a class="hvr-bounce-in" href="https://www.imbajin.com" target="_blank" title="Jin">
          Jin
        </a>
      
        <a class="hvr-bounce-in" href="https://yinwang0.wordpress.com" target="_blank" title="Yinwang(English)">
          Yinwang(English)
        </a>
      
        <a class="hvr-bounce-in" href="http://www.yinwang.org" target="_blank" title="Yinwang(Chinese)">
          Yinwang(Chinese)
        </a>
      
    </div>
  </div>
</div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy;2017 - 2018 Peter pan<br>
      由<a href="http://hexo.io/" target="_blank">Hexo</a>强力驱动 | 
      主题-<a href="https://github.com/ShanaMaid/hexo-theme-shana">Shana</a>
      
    </div>
    
  </div>
</footer>
    </div>
    

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//apps.bdimg.com/libs/wow/0.1.6/wow.min.js"></script>
<script>
new WOW().init();
</script>   


  <link rel="stylesheet" href="/plugin/fancybox/jquery.fancybox.css">
  <script src="/plugin/fancybox/jquery.fancybox.pack.js"></script>



  <link rel="stylesheet" href="/plugin/galmenu/GalMenu.css">
  <script src="/plugin/galmenu/GalMenu.js"></script>
  <div class="GalMenu GalDropDown">
      <div class="circle" id="gal">
        <div class="ring">
          
            <a href="/" title="" class="menuItem">首页</a>
          
            <a href="/tags" title="" class="menuItem">标签</a>
          
            <a href="/about" title="" class="menuItem">音乐</a>
          
            <a href="/archives" title="" class="menuItem">归档</a>
          
            <a href="https://github.com/Peterpan0927" title="" class="menuItem">Github</a>
          
            <a href="ftp://118.89.38.168" title="" class="menuItem">FTP</a>
          
        </div>
        
          <audio id="audio" src="plugin/galmenu/wulusai.mp3"></audio>
        
      </div> 
</div>
<div id="overlay" style="opacity: 1; cursor: pointer;"></div>
  <script type="text/javascript">var items = document.querySelectorAll('.menuItem');
    for (var i = 0,
    l = items.length; i < l; i++) {
      items[i].style.left = (50 - 35 * Math.cos( - 0.5 * Math.PI - 2 * (1 / l) * i * Math.PI)).toFixed(4) + "%";
      items[i].style.top = (50 + 35 * Math.sin( - 0.5 * Math.PI - 2 * (1 / l) * i * Math.PI)).toFixed(4) + "%"
    }</script>
<script type="text/javascript">
  $(document).ready(function() {
    $('body').GalMenu({
      'menu': 'GalDropDown'
    })
  });
</script>

  <section class="hidden-xs"> 
  <ul class="cb-slideshow"> 
    <li><span>苟利</span></li> 
    <li><span>国家</span></li> 
    <li><span>生死以</span></li> 
    <li><span>岂能</span></li> 
    <li><span>祸福</span></li> 
    <li><span>趋避之</span></li> 
  </ul>
</section>
<script src="/js/script.js"></script>




  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("Ljd6bJFL9N4tWj6WnGcbYUd2-gzGzoHsz", "xDGMWtxNt0aReJDVkuYmSqBd");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.article-title').length > 1) {
        showTime(Counter);
      }
    });
  </script>





  </div>
</body>
</html>