<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>iOS多线程 | Peterpan&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="为了追求极致的性能，iOS中的多线程是必经之路">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS多线程">
<meta property="og:url" content="http://yoursite.com/2017/09/29/iOS多线程/index.html">
<meta property="og:site_name" content="Peterpan's Blog">
<meta property="og:description" content="为了追求极致的性能，iOS中的多线程是必经之路">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/thread.jpg">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-09-29%20%E4%B8%8B%E5%8D%881.51.24.png">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-09-29%20%E4%B8%8B%E5%8D%882.06.26.png">
<meta property="og:updated_time" content="2017-09-29T15:12:06.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS多线程">
<meta name="twitter:description" content="为了追求极致的性能，iOS中的多线程是必经之路">
<meta name="twitter:image" content="http://omunhj2f1.bkt.clouddn.com/thread.jpg">
  
    <link rel="alternative" href="/atom.xml" title="Peterpan&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/miaopasi.gif">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          rootUrl: '/',
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/miaopasi.gif" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/" title="Hi Mate">Peter pan</a></h1>
        </hgroup>

        
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="http://hackcode.ishoulu.com/scp/">運命の門の石</a></li>
                        
                            <li><a href="https://github.com/Peterpan0927">作ショーケース</a></li>
                        
                            <li><a href="http://konachan.com/">失楽園</a></li>
                        
                            <li><a href="/about">世界の音楽</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl mail" target="_blank" href="https://mail.qq.com/cgi-bin/frame_html?sid=_oJT_9NAAluUNmoy&r=19ceffb7525880fec0778e401ab5a0c5" title="mail">mail</a>
                            
                                <a class="fl github" target="_blank" href="https://github.com/Peterpan0927" title="github">github</a>
                            
                                <a class="fl zhihu" target="_blank" href="https://www.zhihu.com" title="zhihu">zhihu</a>
                            
                                <a class="fl weibo" target="_blank" href="https://passport.weibo.com/visitor/visitor?entry=miniblog&a=enter&url=http%3A%2F%2Fweibo.com%2F&domain=.weibo.com&sudaref=https%3A%2F%2Fwww.baidu.com%2Flink%3Furl%3DXJx2tZ7NciddPrWFwVpBgDI3XPGsiz4nrRDKFMkcfWu%26wd%3D%26eqid%3Dc1afc8ed00048e800000000358cf9830&ua=php-sso_sdk_client-0.6.23&_rand=1489999922.7477" title="weibo">weibo</a>
                            
                                <a class="fl google" target="_blank" href="#" title="google">google</a>
                            
                                <a class="fl twitter" target="_blank" href="#" title="twitter">twitter</a>
                            
                                <a class="fl linkedin" target="_blank" href="#" title="linkedin">linkedin</a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/ARC-分类-MRC和ARC转换和兼容/" style="font-size: 10px;">ARC 分类 MRC和ARC转换和兼容</a> <a href="/tags/CTF/" style="font-size: 20px;">CTF</a> <a href="/tags/Linux上的文件系统/" style="font-size: 10px;">Linux上的文件系统</a> <a href="/tags/Linux内核/" style="font-size: 10px;">Linux内核</a> <a href="/tags/Linux命令初认识/" style="font-size: 10px;">Linux命令初认识</a> <a href="/tags/Linux测试/" style="font-size: 10px;">Linux测试</a> <a href="/tags/Linux的前世今生/" style="font-size: 10px;">Linux的前世今生</a> <a href="/tags/TCP-IP/" style="font-size: 16.67px;">TCP/IP</a> <a href="/tags/TCP-IP协议/" style="font-size: 10px;">TCP/IP协议</a> <a href="/tags/TableView-cell/" style="font-size: 10px;">TableView cell</a> <a href="/tags/Web安全-前后端基础/" style="font-size: 10px;">Web安全  前后端基础</a> <a href="/tags/Xcode/" style="font-size: 10px;">Xcode</a> <a href="/tags/hash算法-cache服务器/" style="font-size: 10px;">hash算法 cache服务器</a> <a href="/tags/hexo-github/" style="font-size: 10px;">hexo github</a> <a href="/tags/iOS-OC/" style="font-size: 10px;">iOS OC</a> <a href="/tags/iOS-UI/" style="font-size: 10px;">iOS UI</a> <a href="/tags/iOS多线程/" style="font-size: 13.33px;">iOS多线程</a> <a href="/tags/shell编程和文本处理/" style="font-size: 10px;">shell编程和文本处理</a> <a href="/tags/中文编码解决/" style="font-size: 10px;">中文编码解决</a> <a href="/tags/交互式笔记本/" style="font-size: 10px;">交互式笔记本</a> <a href="/tags/代理设计的理解/" style="font-size: 10px;">代理设计的理解</a> <a href="/tags/内存管理-MRC/" style="font-size: 10px;">内存管理 MRC</a> <a href="/tags/动漫/" style="font-size: 10px;">动漫</a> <a href="/tags/图片拉伸-通知-虚拟键盘/" style="font-size: 10px;">图片拉伸 通知 虚拟键盘</a> <a href="/tags/基础介绍-正则匹配/" style="font-size: 10px;">基础介绍 正则匹配</a> <a href="/tags/基础框架/" style="font-size: 10px;">基础框架</a> <a href="/tags/应用程序启动原理/" style="font-size: 10px;">应用程序启动原理</a> <a href="/tags/成员变量和属性变量-真私有属性/" style="font-size: 10px;">成员变量和属性变量 真私有属性</a> <a href="/tags/数据库和HighCharts调用/" style="font-size: 10px;">数据库和HighCharts调用</a> <a href="/tags/无框架原生爬虫/" style="font-size: 10px;">无框架原生爬虫</a> <a href="/tags/权限管理和I-O重定向、管道/" style="font-size: 10px;">权限管理和I/O重定向、管道</a> <a href="/tags/樱花下落的速度是每秒五厘米么？/" style="font-size: 10px;">樱花下落的速度是每秒五厘米么？</a> <a href="/tags/汇编基础/" style="font-size: 10px;">汇编基础</a> <a href="/tags/沙盒和app主流框架/" style="font-size: 10px;">沙盒和app主流框架</a> <a href="/tags/简单微博-MVC实现/" style="font-size: 10px;">简单微博 MVC实现</a> <a href="/tags/类的本质-重写init-点语法/" style="font-size: 10px;">类的本质 重写init 点语法</a> <a href="/tags/网络安全/" style="font-size: 10px;">网络安全</a> <a href="/tags/网络服务器/" style="font-size: 10px;">网络服务器</a> <a href="/tags/网络硬件/" style="font-size: 10px;">网络硬件</a> <a href="/tags/较完善的App/" style="font-size: 10px;">较完善的App</a> <a href="/tags/非对称加密算法/" style="font-size: 10px;">非对称加密算法</a>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://imbajin.com">name</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">二次元、爱运动、爱交友、爱旅行、喜欢接触新鲜事物、迎接新的挑战，更爱游离于错综复杂的编码与逻辑中</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="Me">Peter pan</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/miaopasi.gif" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="Me">Peter pan</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="http://hackcode.ishoulu.com/scp/">運命の門の石</a></li>
                
                    <li><a href="https://github.com/Peterpan0927">作ショーケース</a></li>
                
                    <li><a href="http://konachan.com/">失楽園</a></li>
                
                    <li><a href="/about">世界の音楽</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="mail" target="_blank" href="https://mail.qq.com/cgi-bin/frame_html?sid=_oJT_9NAAluUNmoy&r=19ceffb7525880fec0778e401ab5a0c5" title="mail">mail</a>
                    
                        <a class="github" target="_blank" href="https://github.com/Peterpan0927" title="github">github</a>
                    
                        <a class="zhihu" target="_blank" href="https://www.zhihu.com" title="zhihu">zhihu</a>
                    
                        <a class="weibo" target="_blank" href="https://passport.weibo.com/visitor/visitor?entry=miniblog&a=enter&url=http%3A%2F%2Fweibo.com%2F&domain=.weibo.com&sudaref=https%3A%2F%2Fwww.baidu.com%2Flink%3Furl%3DXJx2tZ7NciddPrWFwVpBgDI3XPGsiz4nrRDKFMkcfWu%26wd%3D%26eqid%3Dc1afc8ed00048e800000000358cf9830&ua=php-sso_sdk_client-0.6.23&_rand=1489999922.7477" title="weibo">weibo</a>
                    
                        <a class="google" target="_blank" href="#" title="google">google</a>
                    
                        <a class="twitter" target="_blank" href="#" title="twitter">twitter</a>
                    
                        <a class="linkedin" target="_blank" href="#" title="linkedin">linkedin</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-iOS多线程" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/29/iOS多线程/" class="article-date">
      <time datetime="2017-09-29T07:50:54.000Z" itemprop="datePublished">2017-09-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      iOS多线程
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/消息循环-线程锁/">消息循环 线程锁</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS多线程/">iOS多线程</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>为了追求极致的性能，iOS中的多线程是必经之路</p>
<a id="more"></a>
<h1 id="多线程的基本概念（iOS）"><a href="#多线程的基本概念（iOS）" class="headerlink" title="多线程的基本概念（iOS）"></a>多线程的基本概念（iOS）</h1><p>再说多线程之前首先要普及一下同步和异步的概念，我们之前在写程序的时候，代码都是顺序执行的，一个线程中执行多个任务，一次处理一个。而异步则是多个人处理多个任务，任务同时执行。</p>
<h2 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h2><p>进程之间是独立的，每个进程都运行在其专用的受保护的内存空间中，通过活动监视器可以查看Mac系统中所开启的进程。</p>
<p>1个程序由一个或多个线程组成，线程是进程的基本执行单元，一个进程的所有任务都在线程中执行。但是事实上单核CPU并不能分别执行多个线程，而是采用了快速切换的方式，显现出一种同时执行的假象，就像我们看电影的时候只是在快速地播放图片而已。</p>
<p>但是有一点需要注意的就是如果线程的数目非常的多，cpu在n个线程之间切换，消耗大量的cpu资源，每个线程被调度的次数会降低，线程的执行效率也会降低，多线程的缺点在于其空间成本和时间成本，不是线程开的越多越好，吃鸡虽好也不能多吃诶。</p>
<p>同时多线程的优点也是十分的明显，可以适当提高程序的执行效率和资源的利用率(CPU&amp;内存，这么好的电脑自然要物尽其用)，线程上的任务在执行完之后也会自动销毁。</p>
<h4 id="主线程"><a href="#主线程" class="headerlink" title="主线程"></a>主线程</h4><p>一个程序运行后，默认会开启一个线程，成为主线程或者UI线程，主线程一般用来刷新UI界面，处理UI事件（点击，滚动，拖拽）。</p>
<p>要注意的是，不能在主线程上执行耗时的操作，不然这种操作会卡死线程，严重影响UI的流畅</p>
<h4 id="多线程的实现方案"><a href="#多线程的实现方案" class="headerlink" title="多线程的实现方案"></a>多线程的实现方案</h4><table>
<thead>
<tr>
<th>技术方案</th>
<th>简介</th>
<th>语言</th>
<th>线程生命周期</th>
<th>使用频率</th>
</tr>
</thead>
<tbody>
<tr>
<td>pthread</td>
<td>一套通用的多线程API</td>
<td>C</td>
<td>程序员管理</td>
<td>几乎不用</td>
</tr>
<tr>
<td>NSThread</td>
<td>可以直接操作线程对象，使用更加面向对象</td>
<td>OC</td>
<td>程序员管理</td>
<td>偶尔使用</td>
</tr>
<tr>
<td>GCD</td>
<td>替换NSThread等线程技术，充分利用设备的多核</td>
<td>C</td>
<td>自动管理</td>
<td>经常使用</td>
</tr>
<tr>
<td>NSOperation</td>
<td>基于GCD，并在此之上做了一些扩展，更加面向对象</td>
<td>OC</td>
<td>自动管理</td>
<td>经常使用</td>
</tr>
</tbody>
</table>
<h3 id="pthread"><a href="#pthread" class="headerlink" title="pthread"></a>pthread</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">//但是这个只是作为一个了解，一般在iOS的项目中是不会使用这种写法</div><div class="line"></div><div class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</div><div class="line">    NSLog(@&quot;%@&quot;, [NSThread currentThread]);</div><div class="line">    [self demo];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)demo&#123;</div><div class="line">    //参数1:pthread_t 线程的标识</div><div class="line">    //参数2:attr 线程的属性</div><div class="line">    //参数3:函数签名,void * 约等于OC中的id</div><div class="line">    //参数4:给函数参数</div><div class="line"></div><div class="line">    //__bridge:默认ARC下对OC对象有内存管理，不对C变量管理，桥接的作用是C变量在合适的时候释放</div><div class="line">    pthread_t PID;</div><div class="line">    NSString *str = @&quot;str&quot;;</div><div class="line">    int result =  pthread_create(&amp;PID, NULL, task, (__bridge void *)(str));</div><div class="line">    if(result == 0) NSLog(@&quot;OK&quot;);</div><div class="line">    else NSLog(@&quot;fail&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">//线程要运行的函数</div><div class="line">void * task (void * param)&#123;</div><div class="line">    NSString *str = (__bridge NSString *)(param);</div><div class="line">    NSLog(@&quot;task is running %@-------&gt;%@ \n&quot;, [NSThread currentThread], str);</div><div class="line">    return NULL;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="NSThread"><a href="#NSThread" class="headerlink" title="NSThread"></a>NSThread</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">- (void)demo&#123;</div><div class="line">    //参数1:对象</div><div class="line">    //参数2:方法</div><div class="line">    //参数3:方法的参数</div><div class="line">    NSThread *thread = [[NSThread alloc] initWithTarget:self selector:@selector(task) object:nil];</div><div class="line">    //开启线程</div><div class="line">    [thread start];</div><div class="line">  	//上述方法也可以使用一行代码搞定</div><div class="line">  	[NSThread detachNewThreadSelector:@selector(task) toTarget:self withObject:nil];</div><div class="line">  	//还有一种方法是隐式创建线程</div><div class="line">  	[self performSelectorInBackground:@selector(task) withObject:nil];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)task&#123;</div><div class="line">    NSLog(@&quot;task is running %@&quot;, [NSThread currentThread]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>线程的状态：</p>
<p><img src="http://omunhj2f1.bkt.clouddn.com/thread.jpg" alt="thread.jpg"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">//一些常用的方法介绍</div><div class="line"></div><div class="line">//阻塞进程</div><div class="line">[NSThread sleepForTimeInterval:1];</div><div class="line">[NSThread sleepUntilDate:[NSDate dateWithTimeIntervalSinceNow:2]];</div><div class="line">//手动杀死线程</div><div class="line">[NSThread exit];</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">//一些常用属性介绍</div><div class="line"></div><div class="line">//线程的名字</div><div class="line">thread.name = @&quot;thread&quot;;</div><div class="line">//优先级,取值范围为0.0-1.0，默认是0.5，1.0表示最高，这个优先级只是表示被CPU调用的几率大小，就算是0也是会被调用的。</div><div class="line">thread.threadPriority = 0;</div></pre></td></tr></table></figure>
<h3 id="关于原子属性"><a href="#关于原子属性" class="headerlink" title="关于原子属性"></a>关于原子属性</h3><p>如果是原子属性，那么在多个线程环  境下，只能有一个线程对你的属性进行赋值，读取无所谓</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@property (atomic, strong) NSObject *obj;</div></pre></td></tr></table></figure>
<p><code>atomic</code>: 原子操作（原子性是指事务的一个完整操作，操作成功就提交，反之就回滚. 原子操作就是指具有原子性的操作）在objective-c 属性设置里面默认的就是atomic，意思就是setter/getter函数是一个原子操作，如果多线程同时调用setter时，不会出现某一个线程执行完setter所有语句之前，另一个线程就开始执行setter，相当于函数头尾加了自旋锁. 这样的话并发访问性能会比较低.</p>
<p><code>nonatomic</code>: 非原子操作 一般不需要多线程支持的时候就用它，这样在并发访问的时候效率会比较高.   在objective-c里面通常对象类型都应该声明为非原子性的. iOS中程序启动的时候系统只会自动生成一个单一的主线程.程序在执行的时候一般情况下是在同一个线程里面对一个属性进行操作. 如果在程序中我们确定某一个属性会在多线程中被使用，并且需要做数据同步，就必须设置成原子性的，但也可以设置成非原子性的，然后自己在程序中用加锁之类的来做数据同步.通常说nonatomic 是提高在非多线程应用中的读写效率.</p>
<hr>
<h2 id="多线程中的锁"><a href="#多线程中的锁" class="headerlink" title="多线程中的锁"></a>多线程中的锁</h2><h4 id="线程安全的产生"><a href="#线程安全的产生" class="headerlink" title="线程安全的产生"></a>线程安全的产生</h4><p>一个很简单的例子就是线程内操作了一个线程外的非线程安全变量(如多个线程操作同一个全局变量)，就需要考虑到线程安全和同步，下面有个简单的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">- (void)getImageName:(NSMutableArray *)imageNames&#123;//假如每个进来的都是一个线程</div><div class="line">    /*1.imageNames是线程外的变量，这个时候就需要考虑线程安全，</div><div class="line">    因为，假如我们当前imageNames的个数是1，线程A和B同时进来发现个数是大于0的，</div><div class="line">    都会去执行remove操作，结果肯定会有一个线程崩溃掉。</div><div class="line">    */</div><div class="line">    /*2.NSMutableArray *array = [[NSMutableArray alloc]initWithArray:imageNames];</div><div class="line">    这里如果新生成一个array，下面也把imageNames换成array就不需要考虑线程安全，</div><div class="line">    但是这样array.count判断永远大于0，也就是永远等于imageNames.count</div><div class="line">     */</div><div class="line">    NSString *imageName;</div><div class="line">    if (imageNames.count&gt;0) &#123;</div><div class="line">        imageName = [imageNames lastObject];</div><div class="line">        [imageNames removeObject:imageName];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>那么这个时候问题就来了，怎么样才是合理的方案呢？下面就是锁的解决方案</p>
<h4 id="锁的概念"><a href="#锁的概念" class="headerlink" title="锁的概念"></a>锁的概念</h4><p>锁是最常用的同步工具。一段代码在同一时间只能允许被一个线程访问，比如线程A进入加锁代码之后由于已经加锁，另一个线程就无法访问，只有等待前一个线程执行完加锁代码解锁，这个加锁代码才能被另一个线程锁访问。</p>
<p>但是如果将过多的操作代码放入其中的话，一个线程执行的时候，另一个线程一直处于等待状态，这样就无法发挥多线程的作用了。</p>
<h4 id="NSLock"><a href="#NSLock" class="headerlink" title="NSLock"></a>NSLock</h4><p>在Cocoa程序中NSlock中实现了一个简单的互斥锁，实现了NSLocking  protocol。</p>
<p>lock:加锁、unlock：解锁、tryLock：尝试加锁，如果失败不会阻塞线程，而是直接返回。</p>
<p>NOlockBeforeDate:，在指定的date之前暂时阻塞线程（如果没有获取锁的话），如果到期还没有获取锁，则线程被唤醒，函数立即返回NO<br>使用tryLock并不能成功加锁，如果获取锁失败就不会执行加锁代码了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (void)getImageName:(NSMutableArray *)imageNames&#123;</div><div class="line">    NSString *imageName;</div><div class="line">    [lock lock];</div><div class="line">    if (imageNames.count &gt; 0) &#123;</div><div class="line">        imageName = [imageNames lastObject];</div><div class="line">        [imageNames removeObject:imageName];</div><div class="line">    &#125;</div><div class="line">    [lock unlock];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="synchronized代码块"><a href="#synchronized代码块" class="headerlink" title="@synchronized代码块"></a>@synchronized代码块</h4><p>一开始最早接触的线程锁就是@synchronized，代码简单，名字可以叫同步锁或者叫互斥锁。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (void)getIamgeName:(int)index&#123;</div><div class="line">    NSString *imageName;</div><div class="line">    @synchronized(self) &#123;</div><div class="line">        if (imageNames.count &gt; 0) &#123;</div><div class="line">            imageName = [imageNames lastObject];</div><div class="line">            [imageNames removeObject:imageName];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>将互斥锁和自旋锁相比较的话，被锁住后遭到其他线程访问其他线程的处理情况会不同：</p>
<blockquote>
<p>互斥锁：如果发现其他线程正在锁定代码，线程会进入休眠（就绪状态），等待其他线程打开之后才会被唤醒<br>自旋锁：如果发现其他线程正在锁定代码，线程会用死循环的方式，一直等待锁定的代码执行完成，更适合执行不耗时的代码。 </p>
</blockquote>
<p>⚠️：锁定一份代码只用一把锁，用多把锁是无效的</p>
<h4 id="条件信号量dispatch-semaphore-t"><a href="#条件信号量dispatch-semaphore-t" class="headerlink" title="条件信号量dispatch_semaphore_t"></a>条件信号量dispatch_semaphore_t</h4><p><code>dispatch_semaphore_t</code>GCD中信号量，也可以解决资源抢占问题,支持信号通知和信号等待。每当发送一个信号通知，则信号量+1；每当发送一个等待信号时信号量-1,；如果信号量为0则信号会处于等待状态，直到信号量大于0开始执行,这个从理解上的话可以类比一下MRC模式中的引用计数，但是还是有一些差别。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">#import &quot;TestViewController.h&quot;</div><div class="line"></div><div class="line">@interface TestViewController ()</div><div class="line">&#123;</div><div class="line">    dispatch_semaphore_t semaphore;</div><div class="line">&#125;</div><div class="line">@end</div><div class="line"></div><div class="line">@implementation TestViewController</div><div class="line"></div><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    [super viewDidLoad];</div><div class="line">    // Do any additional setup after loading the view.</div><div class="line">    semaphore = dispatch_semaphore_create(1);</div><div class="line">    /**</div><div class="line">     *  创建一个信号量为1的信号</div><div class="line">     *</div><div class="line">     */</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)getImageName:(NSMutableArray *)imageNames&#123;</div><div class="line">    NSString *imageName;</div><div class="line">    /**</div><div class="line">     *  semaphore：等待信号</div><div class="line">     DISPATCH_TIME_FOREVER：等待时间</div><div class="line">     wait之后信号量-1，为0</div><div class="line">     */</div><div class="line">    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</div><div class="line">    if (imageNames.count&gt;0) &#123;</div><div class="line">        imageName = [imageNames lastObject];</div><div class="line">        [imageNames removeObject:imageName];</div><div class="line">    &#125;</div><div class="line">    /**</div><div class="line">     *  发送一个信号通知，这时候信号量+1，为1</div><div class="line">     */</div><div class="line">    dispatch_semaphore_signal(semaphore);</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<h4 id="条件锁NSCondition"><a href="#条件锁NSCondition" class="headerlink" title="条件锁NSCondition"></a>条件锁NSCondition</h4><p>NSCondition同样实现了NSLocking协议，所以和NSLock一样，也有lock和unlock方法，可以当作NSLock来解决线程同步问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (void)getIamgeName:(NSMutableArray *)imageNames&#123;</div><div class="line">    NSString *imageName;</div><div class="line">    [lock lock];</div><div class="line">    if (imageNames.count&gt;0) &#123;</div><div class="line">        imageName = [imageNames lastObject];</div><div class="line">        [imageNames removeObject:imageName];</div><div class="line">    &#125;</div><div class="line">    [lock unlock];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h2 id="异步下载图片"><a href="#异步下载图片" class="headerlink" title="异步下载图片"></a>异步下载图片</h2><p>这里通过之前的多线程知识来模拟一个异步下载图片的demo，因为大家都知道主线程是用来刷新UI的，所以网络请求图片放在一个子线程中，然后通过线程间的通信回到主线程刷新UI：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">//重写此方法默认不会加载xib和sb</div><div class="line">-(void)loadView&#123;</div><div class="line">    UIScrollView *sc = [[UIScrollView alloc] initWithFrame: [UIScreen mainScreen].bounds];</div><div class="line">    self.scrollView = sc;</div><div class="line">    self.view = sc;</div><div class="line">    </div><div class="line">    UIImageView *imageView = [[UIImageView alloc] init];</div><div class="line">    self.testImageView = imageView;</div><div class="line">    [self.view addSubview:imageView];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    [super viewDidLoad];</div><div class="line">    //创建一个线程</div><div class="line">    NSThread *thread = [[NSThread alloc] initWithTarget:self selector:@selector(downloadImage) object:nil];</div><div class="line">    [thread start];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)downloadImage&#123;</div><div class="line">    NSLog(@&quot;downloading %@&quot;, [NSThread currentThread]);</div><div class="line">    NSURL *url = [NSURL URLWithString:@&quot;https://ss1.bdstatic.com/70cFuXSh_Q1YnxGkpoWK1HF6hhy/it/u=3751777155,630098310&amp;fm=27&amp;gp=0.jpg&quot;];</div><div class="line">    NSData *data = [NSData dataWithContentsOfURL:url];</div><div class="line">    UIImage *image = [UIImage imageWithData:data];</div><div class="line">    //线程间通信 子--&gt;主</div><div class="line">    [self performSelectorOnMainThread:@selector(updateUI:) withObject:image waitUntilDone:NO];</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)updateUI:(UIImage *)image&#123;</div><div class="line">    NSLog(@&quot;updateUI %@&quot;, [NSThread currentThread]);</div><div class="line">    self.testImageView.image = image;</div><div class="line">    </div><div class="line">    //根据图片的大小来调整位置</div><div class="line">    [self.testImageView sizeToFit];</div><div class="line">    [self.scrollView setContentSize:image.size];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h2 id="消息循环"><a href="#消息循环" class="headerlink" title="消息循环"></a>消息循环</h2><h4 id="RunLoop"><a href="#RunLoop" class="headerlink" title="RunLoop"></a>RunLoop</h4><pre><code>1. 概念：
</code></pre><p>每个程序都有一个RunLoop对象，主线程默认开启RunLoop，子线程默认不开启，要注意的是如果子线程启动了循环之后没有停止循环，就不会执行任何后续的代码，会形成一个死循环。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">//在子线程中要手动的开启消息循环，方法有几种：</div><div class="line">//这种方法因为在不同的机子上性能不同，所以不能将时间写死</div><div class="line">[[NSRunLoop currentRunLoop] runUntilDate:[NSDate dateWithTimeIntervalSinceNow:2]];</div><div class="line">//下面这种方法是使用全局变量来控制子线程中消息循环的开关</div><div class="line">NSRunLoop *theRL = [NSRunLoop currentLoop];</div><div class="line">while(shouldKeepRunning &amp;&amp; [theRL runMode:NSDefaultRunLoopMode beforeDate:[NSDate distantFuture]]);</div></pre></td></tr></table></figure>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-09-29%20%E4%B8%8B%E5%8D%881.51.24.png" alt="屏幕快照 2017-09-29 下午1.51.24.png"></p>
<pre><code>2. 作用：
</code></pre><ul>
<li>保证程序不退出。</li>
<li>负责监听所有事件，例如：手势触摸，时钟触发，网络加载数据完成等</li>
<li>如果没有时间发生，会让程序进入休眠状态</li>
</ul>
<ol>
<li>响应者链条事件监听过程</li>
</ol>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-09-29%20%E4%B8%8B%E5%8D%882.06.26.png" alt="屏幕快照 2017-09-29 下午2.06.26.png"></p>
<h4 id="时钟调度"><a href="#时钟调度" class="headerlink" title="时钟调度"></a>时钟调度</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">/**使用方法：</div><div class="line">1.创建消息</div><div class="line">2.把消息放入循环，并制定消息的运行模式</div><div class="line">3.在与循环的模式相匹配的时候，消息运行（NSRunLoopCommonModes包含所有的模式，所有在用户交互的时候，循环的模式时钟会被匹配，所以时钟仍然会被触发）</div><div class="line"></div><div class="line">*／</div><div class="line">/*</div><div class="line">        - (void)addTimer:(NSTimer *)timer forMode:(NSString *)mode;</div><div class="line">        </div><div class="line">        NSDefaultRunLoopMode: 时钟，网络。           发生用户交互的时候，时钟会被暂停</div><div class="line">        NSRunLoopCommonModes: 用户交互，响应级别高。   发生用户交互的时候，时钟仍然会触发，如果时钟触发方法非常耗时，</div><div class="line">                                                   使用此方式时用户操作会造成非常严重的卡顿。</div><div class="line">    */</div></pre></td></tr></table></figure>
<ul>
<li><p>以 NSRunLoopCommonModes 方式创建</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">// 调度时钟</div><div class="line">self.timer = [NSTimer timerWithTimeInterval:1.0 </div><div class="line">                                     target:self </div><div class="line">                                   selector:@selector(updateTimer) </div><div class="line">                                   userInfo:nil </div><div class="line">                                    repeats:YES];</div><div class="line"></div><div class="line">// 将时钟以 NSRunLoopCommonModes 模式添加到运行循环</div><div class="line">[[NSRunLoop currentRunLoop] addTimer:self.timer forMode:NSRunLoopCommonModes];</div></pre></td></tr></table></figure>
</li>
<li><p>以 NSDefaultRunLoopMode 方式创建</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">// 调度时钟</div><div class="line">/*</div><div class="line">    默认将时钟以 NSDefaultRunLoopMode 模式添加到运行循环</div><div class="line">*/</div><div class="line">self.timer = [NSTimer scheduledTimerWithTimeInterval:1.0 </div><div class="line">                                              target:self </div><div class="line">                                            selector:@selector(updateTimer) </div><div class="line">                                            userInfo:nil </div><div class="line">                                             repeats:YES];</div></pre></td></tr></table></figure>
</li>
<li><p>子线程运行循环</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</div><div class="line"></div><div class="line">    // 在子线程开启时钟，由于子线程的运行循环没有启动，所以没法监听时钟事件</div><div class="line">    self.timer = [NSTimer timerWithTimeInterval:1.0 </div><div class="line">                                         target:self </div><div class="line">                                       selector:@selector(updateTimer) </div><div class="line">                                       userInfo:nil </div><div class="line">                                        repeats:YES];</div><div class="line"></div><div class="line">    [[NSRunLoop currentRunLoop] addTimer:self.timer forMode:NSDefaultRunLoopMode];</div><div class="line"></div><div class="line">    // 启动子线程的运行循环，这句代码就是一个死循环！如果不停止运行循环，不会执行后续的任何代码</div><div class="line">    CFRunLoopRun();</div><div class="line"></div><div class="line">    // 停止子线程运行循环之前，不会执行添加到此处的任何代码</div><div class="line">&#125;);</div><div class="line"></div><div class="line">// 运行循环执行操作方法</div><div class="line">- (void)updateTimer &#123;</div><div class="line"></div><div class="line">    static int num = 0;</div><div class="line"></div><div class="line">    NSLog(@&quot;%d %@&quot;, num++, [NSThread currentThread]);</div><div class="line"></div><div class="line">    // 满足条件后，停止当前的运行循环</div><div class="line">    if (num == 8) &#123;</div><div class="line"></div><div class="line">        // 一旦停止了运行循环，后续代码能够执行，执行完毕后，线程被自动销毁</div><div class="line">        CFRunLoopStop(CFRunLoopGetCurrent());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>参考来源：<a href="http://www.jianshu.com/p/a9b900d38bff" target="_blank" rel="external">简书-iOS中的运行循环机制</a></p>

      
      
        <div class="page-reward">
          <p><a href="javascript:void(0)" onclick="dashangToggle()" class="dashang" title="打赏，支持一下">赏</a></p>
          <div class="hide_box"></div>
          <div class="shang_box">
            <a class="shang_close" href="javascript:void(0)" onclick="dashangToggle()" title="关闭">×</a>
            <div class="shang_tit">
              <p>纯属好玩</p>
            </div>
            <div class="shang_payimg">
              <img src="/img/alipayimg.jpg" alt="扫码支持" title="扫一扫" />
            </div>
              <div class="pay_explain">点击下方的图片，扫码打赏，你说多少就多少</div>
            <div class="shang_payselect">
              
                <div class="pay_item checked" data-id="alipay">
                  <span class="radiobox"></span>
                  <span class="pay_logo"><img src="/img/123.png" alt="支付宝" /></span>
                </div>
              
              
                <div class="pay_item" data-id="wechat">
                  <span class="radiobox"></span>
                  <span class="pay_logo"><img src="/img/wc.png" alt="微信" /></span>
                </div>
              
            </div>
            <div class="shang_info">
              <p>打开<span id="shang_pay_txt">支付宝</span>扫一扫，即可进行扫码打赏哦</p>
            </div>
          </div>
        </div>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
        <script type="text/javascript">
          $(".pay_item").click(function(){
            $(this).addClass('checked').siblings('.pay_item').removeClass('checked');
            var dataid=$(this).attr('data-id');
            $(".shang_payimg img").attr("src","/img/"+dataid+"img.jpg");
            $("#shang_pay_txt").text(dataid=="alipay"?"支付宝":"微信");
          });
          function dashangToggle(){
            $(".hide_box").fadeToggle();
            $(".shang_box").fadeToggle();
          }
        </script>
      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2017/09/29/iOS多线程/">iOS多线程</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 Peter pan 的个人博客">Peter pan</a></p>
        <p><span>发布时间:</span>2017年09月29日 - 15时50分</p>
        <p><span>最后更新:</span>2017年09月29日 - 23时12分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2017/09/29/iOS多线程/" title="iOS多线程">http://yoursite.com/2017/09/29/iOS多线程/</a>
            <span class="copy-path" data-clipboard-text="原文: http://yoursite.com/2017/09/29/iOS多线程/　　作者: Peter pan" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script src="/js/clipboard.min.js"></script>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



<nav id="article-nav">
  
    <a href="/2017/10/05/iOS多线程之GCD/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          iOS多线程之GCD
        
      </div>
    </a>
  
  
    <a href="/2017/09/25/CTF-SQL注入/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">CTF-SQL注入</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#多线程的基本概念（iOS）"><span class="toc-number">1.</span> <span class="toc-text">多线程的基本概念（iOS）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#线程"><span class="toc-number">1.1.</span> <span class="toc-text">线程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#主线程"><span class="toc-number">1.1.0.1.</span> <span class="toc-text">主线程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#多线程的实现方案"><span class="toc-number">1.1.0.2.</span> <span class="toc-text">多线程的实现方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pthread"><span class="toc-number">1.1.1.</span> <span class="toc-text">pthread</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NSThread"><span class="toc-number">1.1.2.</span> <span class="toc-text">NSThread</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关于原子属性"><span class="toc-number">1.1.3.</span> <span class="toc-text">关于原子属性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#多线程中的锁"><span class="toc-number">1.2.</span> <span class="toc-text">多线程中的锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#线程安全的产生"><span class="toc-number">1.2.0.1.</span> <span class="toc-text">线程安全的产生</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#锁的概念"><span class="toc-number">1.2.0.2.</span> <span class="toc-text">锁的概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NSLock"><span class="toc-number">1.2.0.3.</span> <span class="toc-text">NSLock</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#synchronized代码块"><span class="toc-number">1.2.0.4.</span> <span class="toc-text">@synchronized代码块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#条件信号量dispatch-semaphore-t"><span class="toc-number">1.2.0.5.</span> <span class="toc-text">条件信号量dispatch_semaphore_t</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#条件锁NSCondition"><span class="toc-number">1.2.0.6.</span> <span class="toc-text">条件锁NSCondition</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#异步下载图片"><span class="toc-number">1.3.</span> <span class="toc-text">异步下载图片</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#消息循环"><span class="toc-number">1.4.</span> <span class="toc-text">消息循环</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RunLoop"><span class="toc-number">1.4.0.1.</span> <span class="toc-text">RunLoop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#时钟调度"><span class="toc-number">1.4.0.2.</span> <span class="toc-text">时钟调度</span></a></li></ol></li></ol></li></ol></li></ol>
</div>
<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }
    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
        }
    })
    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
    }
</script>





<div class="bdsharebuttonbox">
	<a href="#" class="fx fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="fx fa-weixin bds_weixin" data-cmd="weixin" title="分享到微信"></a>
	<a href="#" class="fx fa-qq bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
	<a href="#" class="fx fa-facebook-official bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
	<a href="#" class="fx fa-twitter bds_twi" data-cmd="twi" title="分享到Twitter"></a>
	<a href="#" class="fx fa-linkedin bds_linkedin" data-cmd="linkedin" title="分享到linkedin"></a>
	<a href="#" class="fx fa-files-o bds_copy" data-cmd="copy" title="分享到复制网址"></a>
</div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>




    
        <section id="comments">
  <div id="disqus_thread"></div>
    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'peterpan980927'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>
    



    <div class="scroll" id="post-nav-button">
        
            <a href="/2017/10/05/iOS多线程之GCD/" title="上一篇: iOS多线程之GCD">
                <i class="fa fa-angle-left"></i>
            </a>
        
        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
        
            <a href="/2017/09/25/CTF-SQL注入/" title="下一篇: CTF-SQL注入">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>
    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/10/30/CTF-图像学基础/">CTF-图像学基础</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/29/PNG在隐写中的应用/">PNG在隐写中的应用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/28/CTF-密码学/">CTF-密码学</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/23/大话CTF/">大话CTF</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/15/TCP-IP-四/">TCP/IP(四)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/07/GFW-中间人攻击/">GFW&中间人攻击</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/05/iOS多线程之GCD/">iOS多线程之GCD</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/29/iOS多线程/">iOS多线程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/25/CTF-SQL注入/">CTF-SQL注入</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/18/CTF-安全杂项/">CTF-安全杂项</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/17/CTF-隐写术/">CTF-信息隐藏技术</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/14/Foundation框架/">Foundation框架</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/03/TCP-IP-三/">TCP/IP(三)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/31/iOS沙盒与模态/">iOS沙盒与模态</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/28/Linux运维学习Day6/">Linux运维学习Day6</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/27/TCP-IP-二/">TCP/IP(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/24/地狱少女/">地獄少女</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/24/OSI模型初探/">TCP/IP(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/16/DNS相关/">DNS相关</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/15/计算机网络硬件/">计算机网络硬件</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/15/Linux运维学习Day5/">Linux运维学习Day5</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/15/Linux运维学习Day4/">Linux运维学习Day4</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/15/Linux运维学习Day3/">Linux运维学习Day3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/15/Linux运维学习Day2/">Linux运维学习Day2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/15/Linux运维学习Day1/">Linux运维学习Day1</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/13/缓存服务器和一致性哈希/">缓存服务器和一致性哈希</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/13/iOS-UI-启动原理和导航控制器/">iOS-UI 启动原理和导航控制器</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/26/iOS成员变量和属性的关系/">iOS成员变量和属性的关系</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/26/ARC与分类/">ARC与分类</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/24/内存管理/">内存管理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/21/OC特有语法/">OC特有语法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/20/Xcode基本调试/">Xcode基本调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/15/iOS-UI基础-七/">iOS-UI基础(七)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/15/七牛图片自动上传/">七牛图片自动上传</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/14/CPU对于内存的读写/">CPU对于内存的读写</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/11/iOS-UI学习-六/">iOS-UI学习(六)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/03/iOS-UI学习-五/">iOS-UI学习(五)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/26/Web基础/">Web基础</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/23/iOS-UI学习-四/">iOS-UI学习(四)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/22/Linux进程/">Linux进程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/18/jupyter笔记本基本使用/">jupyter笔记本基本使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/18/iOS-UI学习-三/">iOS-UI学习(三)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/12/iOS-UI学习-二/">iOS-UI学习(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/12/iOS-UI学习/">iOS-UI学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/12/网络爬虫-二/">网络爬虫(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/12/网络爬虫/">网络爬虫</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/12/RSA密钥生成的过程-数学证明/">RSA密钥生成的过程(数学证明)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/12/土家购农村电商爬虫代码示例/">土家购农村电商爬虫代码示例</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/21/多终端同步hexo博客/">多终端同步hexo博客</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/20/hello-world/">页面教程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/20/秒速五厘米/">秒速五厘米</a></li></ul>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
    <script>
        $(".post-list").addClass("toc-article");
        $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
            }
        })
    </script>



    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2017 Peter pan
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/luuman/hexo-theme-spfk" target="_blank">spfk</a> by luuman
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >訪問者の量: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">読書の量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 24;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


  </div>
</body>
</html>