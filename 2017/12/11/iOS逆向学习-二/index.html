<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>iOS逆向学习(二) | Peterpan&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="iOS逆向工程中使用的一系列工具功能不同，主要是作为开发和调试的工作，这一次主要是介绍两种：class-dump和Theos，那么这这个工具是干什么的呢？">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS逆向学习(二)">
<meta property="og:url" content="http://yoursite.com/2017/12/11/iOS逆向学习-二/index.html">
<meta property="og:site_name" content="Peterpan's Blog">
<meta property="og:description" content="iOS逆向工程中使用的一系列工具功能不同，主要是作为开发和调试的工作，这一次主要是介绍两种：class-dump和Theos，那么这这个工具是干什么的呢？">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-12-11%20%E4%B8%8B%E5%8D%888.07.13.png">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-12-11%20%E4%B8%8B%E5%8D%8811.11.21.png">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/IMG_0056.PNG">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-12-11%20%E4%B8%8B%E5%8D%8811.38.13.png">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-12-13%20%E4%B8%8B%E5%8D%8810.12.05.png">
<meta property="og:image" content="http://omunhj2f1.bkt.clouddn.com/IMG_0062.PNG">
<meta property="og:updated_time" content="2018-03-13T16:00:22.857Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS逆向学习(二)">
<meta name="twitter:description" content="iOS逆向工程中使用的一系列工具功能不同，主要是作为开发和调试的工作，这一次主要是介绍两种：class-dump和Theos，那么这这个工具是干什么的呢？">
<meta name="twitter:image" content="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-12-11%20%E4%B8%8B%E5%8D%888.07.13.png">
  
    <link rel="alternate" href="/atom.xml" title="Peterpan&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/p1.png">
  
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/plugin/bganimation/bg.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <div class="outer">
        <div class="widget-wrap mobile-header">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-03-22%20%E4%B8%8B%E5%8D%8811.42.23.png">
    <h2 class="author">Peter pan</h2>
    <h3 class="description">the mark of an educated mind is to be able to entertain a thought without accepting it</h3>
    <div class="count-box">
      <a href="/archives"><div><strong>98</strong><br>文章</div></a>
      <a href="/categories"><div><strong>90</strong><br>分类</div></a>
      <a href="/tags"><div><strong>14</strong><br>标签</div></a>
    </div>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
    </ul>
  </div>
</div>

        <section id="main"><article id="post-iOS逆向学习-二" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/11/iOS逆向学习-二/" class="article-date">
  <time class="post-time" datetime="2017-12-11T04:24:51.000Z" itemprop="datePublished">
    <span class="post-month">12月</span><br/>
    <span class="post-day">11</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      iOS逆向学习(二)
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/上手实战-OSX工具集/">上手实战 OSX工具集</a>
  </div>

          
              
  &nbsp; | &nbsp;
  <div class="view-box">
    <span id="/2017/12/11/iOS逆向学习-二/" class="leancloud_visitors" data-flag-title="iOS逆向学习(二)">
      &nbsp;阅读次数<span class="leancloud-visitors-count"></span>
    </span>
  </div>


          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>iOS逆向工程中使用的一系列工具功能不同，主要是作为开发和调试的工作，这一次主要是介绍两种：<code>class-dump</code>和<code>Theos</code>，那么这这个工具是干什么的呢？</p>
<a id="more"></a>
<h1 id="class-dump"><a href="#class-dump" class="headerlink" title="class-dump"></a>class-dump</h1><p>这个工具从名字中我们大概也能猜出来这是一个去dump目标对象的class信息的工具。它利用的是OC的<code>runtime</code>特性，将存储于Mach-O文件中的头文件信息（@interface和@protocol信息）提取出来，并生成的对应的.h文件。官方的介绍其实是这样说的：</p>
<blockquote>
<p>This is a command-line utility for examining the Objective-C runtime information stored in Mach-O files. It generates declarations for the classes, categories and protocols. This is the same information provided by using ‘otool -ov’, but presented as normal Objective-C declarations, so it is much more compact and readable</p>
</blockquote>
<p>这个工具的用法比较简单，首先去<a href="http://stevenygard.com/projects/class-dump/" target="_blank" rel="external">官网</a>下载一个镜像，然后将dmg中的class-dump复制到<code>/usr/bin</code>目录下，然后给它赋予777的权限，运行之后就可以看到它的相关参数：</p>
<pre><code class="shell">peterpan in ~ λ class-dump
class-dump 3.5 (64 bit)
Usage: class-dump [options] &lt;mach-o-file&gt;

  where options are:
        -a             show instance variable offsets
        -A             show implementation addresses
        --arch &lt;arch&gt;  choose a specific architecture from a universal binary (ppc, ppc64, i386, x86_64, armv6, armv7, armv7s, arm64)
        -C &lt;regex&gt;     only display classes matching regular expression
        -f &lt;str&gt;       find string in method name
        -H             generate header files in current directory, or directory specified with -o
        -I             sort classes, categories, and protocols by inheritance (overrides -s)
        -o &lt;dir&gt;       output directory used for -H
        -r             recursively expand frameworks and fixed VM shared libraries
        -s             sort classes and categories by name
        -S             sort methods by name
        -t             suppress header in output, for testing
        --list-arches  list the arches in the file, then exit
        --sdk-ios      specify iOS SDK version (will look in /Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS&lt;version&gt;.sdk
        --sdk-mac      specify Mac OS X version (will look in /Developer/SDKs/MacOSX&lt;version&gt;.sdk
        --sdk-root     specify the full SDK root path (or use --sdk-ios/--sdk-mac for a shortcut)
</code></pre>
<p>class-dump的对象是Mach-O格式的二进制文件，如Framwwork的库文件和App的可执行文件。下面用Mac上的一个ShadowsocksX为例子：</p>
<pre><code class="shell">peterpan in ~ λ cd /Applications/ShadowsocksX.app/
peterpan in /Applications/ShadowsocksX.app λ ls
Contents
peterpan in /Applications/ShadowsocksX.app λ cd Contents
peterpan in /Applications/ShadowsocksX.app/Contents λ ls
Info.plist     MacOS          PkgInfo        Resources      _CodeSignature
peterpan in /Applications/ShadowsocksX.app/Contents λ plutil -p Info.plist | grep CFBundleExecutable
  &quot;CFBundleExecutable&quot; =&gt; &quot;ShadowsocksX&quot;
</code></pre>
<p>这个时候我们已经通过Xcode的命令行工具plutil找到了这个App的可执行文件，但是并没有在本目录下找到，而是在其中一个子目录下面，接下来我们就可以使用class-dump去提取App的头文件了：</p>
<pre><code class="shell">class-dump -s -S -H ShadowsocksX -o ~/path/to/headers/ShadowsocksX
</code></pre>
<p>接下来我们就会在目录下面找到我们所有的头文件了，经过对比之后，和源文件中的头文件是非常的相似的，除了一些参数类型被改成了id，类型名用arg1,arg2来表示之外，其他的基本都是一样的。通过这些头文件，那么闭源的App就会露出他们的马脚了：</p>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-12-11%20%E4%B8%8B%E5%8D%888.07.13.png" alt=""></p>
<p>但是到这种程度还远远没有结束，因为现在App工程越来越庞大，而且引用了很多的第三方代码，所以我们使用class-dump的时候就会dump出成百上千个头文件，其实对于工程师的水平也是一种考验。之所以选择的是这个App是因为从App Store上下载的App都是经过加密的，直接使用class-dump就会失效，就像一个硬硬的核桃里面包着果肉，我们用镊子是不可能夹的出来的，首先干嘛？对了，锤子砸开它，在逆向工程中俗称砸壳，这个之后再介绍，下面说一下另一个工具。</p>
<h1 id="Theos"><a href="#Theos" class="headerlink" title="Theos"></a>Theos</h1><p>这是一个越狱开发工具包。它与其他的越狱开发工具相比，最大的特点就是简单:不管是下载安装还是Logos的语法还是编译发布都比较省事，既然比较起来就要提到另一个也就是整合在Xcode中的iOSOpenDev，作为一个经常使用Xcode的iOS工程师，本来我是打算使用这种工具的，但是逆向工程接触底层的知识比较多，很多东西无法自动化，工具太智能反而会坏了自己的根基，所以按照作者推荐选择了整合度不算太高的Theos。</p>
<p>工具安装的废话就不说了，但是一步一步的每个模块安装还是比较浪费时间的，所以我找到了一个在github上写了一个自动化配置脚本的友人，这里分享一个<a href="https://github.com/DaSens/Theos-Script" target="_blank" rel="external">链接</a>，同时也分享一个<a href="https://pan.baidu.com/s/1kTvex0r" target="_blank" rel="external">iOSOpenDev</a>的，来自一个具有开源精神的朋友。</p>
<p>等到配置完成之后就可以开始创建工程了，启动NIC:</p>
<pre><code class="shell">/opt/theos/nic.pl
</code></pre>
<p>然后根据选项我们创建一个Tweak工程，然后按照要求输入一系列的参数，也就算是我们的一个基础的Tweak工程创建完毕了，接下来还是结合实例来讲一下比较形象一点，我是在手机上修改了锁屏界面，也就是会进行弹窗，那么我们看看整个流程应该如何的去操作：</p>
<p>首先修改我们的MakeFile，这个文件中指定工程用到的所有文件、框架、库等，将整个过程自动化</p>
<pre><code class="shell">THEOS_DEVICE_IP = 192.168.199.129
ARCHS = armv7 arm64
TARGET = iphone:latest:7.0

include /opt/theos/makefiles/common.mk

TWEAK_NAME = ios_test
ios_test_FILES = Tweak.xm
ios_test_FRAMEWORKS = UIKit

include $(THEOS_MAKE_PATH)/tweak.mk

after-install::
    install.exec &quot;killall -9 SpringBoard&quot;
</code></pre>
<p>上面的语句其实并不难，简单的讲解一下就是说导入一些框架和文件，指定一下SDK的版本，适配处理器架构，最后在tweak安装之后杀掉SpringBoard进程，好让CydiaSubstate在进程启动时加载对应的dylib。</p>
<p>除此之外我们在第一行的时候制定了目标IP，也就是我们需要安装deb包的目标机的IP地址，这个手机中的网络旁边的圆圈感叹号中就可以看到，接下来要修改的就是我们的Tweak文件：</p>
<pre><code class="objective-c">%hook SpringBoard

- (void)applicationDidFinishLaunching:(id)application{
  %orig;
  UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@&quot;Are you ok?&quot; message:nil delegate:self cancelButtonTitle:@&quot;OK&quot; otherButtonTitles:nil];
  [alert show];
  [alert release];
}

%end
</code></pre>
<p>这个Tweak也只是一个demo，显然也非常的简单，意思也就是说勾住SpringBoard类中的<code>applicationDidFinishLaunching:</code>函数，然后执行其中我们重写的OC语句，也就是弹出一个框，这两部做完之后剩下的就是打包然后编译安装了，在这个地方我们最快捷的一条龙服务就只需要一个命令:</p>
<pre><code class="shell">make package install
</code></pre>
<p>但是这期间会提示让你输入root密码，这显然是一种极其愚钝而又麻烦的做法，显然我们应该通过公钥免密登陆的方式才对，所以我们需要创建并且将之丢上去:</p>
<pre><code class="shell">#首先在我们的Mac上，如果有就跳过，没有就创建
ssh-keygen -t rsa
#一路回车，然后将我们的公钥给cp出来
cp ~/.ssh/id_rsa.pub ~/authorized_keys
#接下来要在我们要安装的iphone上生成
ssh-keygen
#一路回车之后我们通过scp将公钥丢上去
scp ~/authorized_keys root@Target_IP:/var/root/.ssh/authorized_keys
</code></pre>
<p>这个时候我们就可以免密码登录了，但是我在这样操作的时候曾经出过一个问题，那就是我配置完之后依然需要root密码才能登录，那么这就很奇怪，所以我猜测是因为权限的问题，于是我修改了root目录以及authorized_keys的权限，发现依旧不行，于是我通过调试最后才发现是因为<code>/private/var/root</code>的目录权限不对导致公钥不会生效:</p>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-12-11%20%E4%B8%8B%E5%8D%8811.11.21.png" alt=""></p>
<p>我们可以看到其实在iphone中/etc和/var只不过是个符号链接，其实/private文件夹才是大权在握，最后经过修改之后才可以免密码登录，实现我们的一条龙服务，最后安装成功的效果是这样的：</p>
<p><img src="http://omunhj2f1.bkt.clouddn.com/IMG_0056.PNG" alt=""></p>
<h1 id="好玩的功能发掘"><a href="#好玩的功能发掘" class="headerlink" title="好玩的功能发掘"></a>好玩的功能发掘</h1><p>那么进入终端之后还可以做哪些好玩的事情呢，我今天尝试了一下，发现<code>open</code>这个命令其实非常的有意思，首先我们要安装<code>open</code>这个命令，然后通过<code>Erica Utilities</code>得到<code>plutil</code>，接下来我们就可以将手机交给别人玩了，接下来我们就悄悄的溜进终端，进行我们的秘密行动：</p>
<pre><code class="shell">#首先我们可以通过命令查看当前的进程
ps -A
</code></pre>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-12-11%20%E4%B8%8B%E5%8D%8811.38.13.png" alt=""></p>
<p>原来在刷微博啊，那么我们首先来干扰一下他吧，我们来打开照相机，如果不知道ID的话首先就查看一下：</p>
<pre><code class="shell">iPhone:/Applications root# cd Camera.app/
iPhone:/Applications/Camera.app root# plutil Info.plist | grep CFBundleIdentifier
    CFBundleIdentifier = &quot;com.apple.camera&quot;;
</code></pre>
<p>知道了对应的ID之后的我们就可以通过open命令来打开它了：</p>
<pre><code class="shell">open com.apple.camera
</code></pre>
<p>这个时候小伙伴已经不知所措，接下来我们要做一件更坏的事情，那就是杀掉他之前的微博进程：</p>
<pre><code class="shell">#杀掉对应的进程的PID
kill 6957
</code></pre>
<p>那么这个时候小伙伴应该是一头雾水，感觉还是挺好玩的，如果有进一步的操作技巧应该会更有意思。</p>
<p>在这之后觉得似乎还是不过瘾，决定发掘一些更有意思的功能，于是我就想到了通过手机来控制电脑进行拍照，也就是说我可以站在一个旁观者的角度去悄悄的记录一些东西，所以我就写了一个shell脚本:</p>
<pre><code class="shell">#! /bin/zsh

function rand(){
  min=$1
  max=$(($2-$min+1))
  num=$(($RANDOM+1000000000))
  echo $(($num%$max+$min))
}

name=0
name=$(rand 400000 500000)
echo $name
imagesnap -q -w 2 snaphoto$name.png
scp ~/shellScript/snaphoto$name.png root@192.168.1.129:/var/mobile/Media/DCIM/100APPLE/
ps -fe | grep scp | grep -v grep
isDone=`echo $?`
if [ &quot;$isDone&quot; -ne &quot;0&quot; ];
then
  echo yes
  rm ~/shellScript/snaphoto$name.png
fi
</code></pre>
<p>这里就是通过调用facetime去进行拍照并且将照片即时上传到手机并且上传成功后删除本地照片，经过测试的结果发现整个过程大概只需要几秒：</p>
<p><img src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-12-13%20%E4%B8%8B%E5%8D%8810.12.05.png" alt=""></p>
<p>这个时候从我们的iphone上进行操作的话就只需要ssh连接到电脑上并执行这个脚本即可：</p>
<p><img src="http://omunhj2f1.bkt.clouddn.com/IMG_0062.PNG" alt=""></p>
<p>然后我们就可以通过iFile在相关目录下看到上传的照片了，但是由于每次照相的时候都会先开启一次FaceTime，这样其实不太好，所以还是要优化一下，另外一个问题就是在电脑锁屏的时候，拍摄出来的照片会不完整，整体亮度会特别低，导致看不清楚，会在之后的版本中优化，同时准备通过传感器来完成识别功能从而达到监测的效果，后期应该会选择云服务器作为资源存储:)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/11/iOS逆向学习-二/" data-id="cjgnci0tt005m6vbrxotfbqu0" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Re/">Re</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/12/14/反动态调试保护基础介绍/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Nieuwer</strong>
      <div class="article-nav-title">
        
          反动态调试保护基础介绍
        
      </div>
    </a>
  
  
    <a href="/2017/12/10/孔明/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Ouder</strong>
      <div class="article-nav-title">孔明的光环</div>
    </a>
  
</nav>

  
</article>



</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <h1 class="blog-title">Peterpan&#39;s Blog</h1>
    <h2 class="blog-subtitle">Mind over muscle.</h2>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
    </ul>
  </div>
</div>

  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="http://omunhj2f1.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-03-22%20%E4%B8%8B%E5%8D%8811.42.23.png">
    <h2 class="author">Peter pan</h2>
    <h3 class="description">the mark of an educated mind is to be able to entertain a thought without accepting it</h3>
    <div class="count-box">
      <a href="/archives"><div><strong>98</strong><br>文章</div></a>
      <a href="/categories"><div><strong>90</strong><br>分类</div></a>
      <a href="/tags"><div><strong>14</strong><br>标签</div></a>
    </div>



    <div class="social-link">
      
        <a class="hvr-bounce-in" href="http://github.com/Peterpan0927" target="_blank" title="Github">
          Github
        </a>
      
    </div>

    <div class="friend-link">
      <h2>友情链接</h2>
      
        <a class="hvr-bounce-in" href="https://www.imbajin.com" target="_blank" title="Jin">
          Jin
        </a>
      
        <a class="hvr-bounce-in" href="https://yinwang0.wordpress.com" target="_blank" title="Yinwang(English)">
          Yinwang(English)
        </a>
      
        <a class="hvr-bounce-in" href="http://www.yinwang.org" target="_blank" title="Yinwang(Chinese)">
          Yinwang(Chinese)
        </a>
      
    </div>
  </div>
</div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy;2017 - 2018 Peter pan<br>
      由<a href="http://hexo.io/" target="_blank">Hexo</a>强力驱动 | 
      主题-<a href="https://github.com/ShanaMaid/hexo-theme-shana">Shana</a>
      
    </div>
    
  </div>
</footer>
    </div>
    

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//apps.bdimg.com/libs/wow/0.1.6/wow.min.js"></script>
<script>
new WOW().init();
</script>   


  <link rel="stylesheet" href="/plugin/fancybox/jquery.fancybox.css">
  <script src="/plugin/fancybox/jquery.fancybox.pack.js"></script>



  <link rel="stylesheet" href="/plugin/galmenu/GalMenu.css">
  <script src="/plugin/galmenu/GalMenu.js"></script>
  <div class="GalMenu GalDropDown">
      <div class="circle" id="gal">
        <div class="ring">
          
            <a href="/" title="" class="menuItem">首页</a>
          
            <a href="/tags" title="" class="menuItem">标签</a>
          
            <a href="/about" title="" class="menuItem">音乐</a>
          
            <a href="/archives" title="" class="menuItem">归档</a>
          
            <a href="https://github.com/Peterpan0927" title="" class="menuItem">Github</a>
          
            <a href="ftp://118.89.38.168" title="" class="menuItem">FTP</a>
          
        </div>
        
          <audio id="audio" src="plugin/galmenu/wulusai.mp3"></audio>
        
      </div> 
</div>
<div id="overlay" style="opacity: 1; cursor: pointer;"></div>
  <script type="text/javascript">var items = document.querySelectorAll('.menuItem');
    for (var i = 0,
    l = items.length; i < l; i++) {
      items[i].style.left = (50 - 35 * Math.cos( - 0.5 * Math.PI - 2 * (1 / l) * i * Math.PI)).toFixed(4) + "%";
      items[i].style.top = (50 + 35 * Math.sin( - 0.5 * Math.PI - 2 * (1 / l) * i * Math.PI)).toFixed(4) + "%"
    }</script>
<script type="text/javascript">
  $(document).ready(function() {
    $('body').GalMenu({
      'menu': 'GalDropDown'
    })
  });
</script>

  <section class="hidden-xs"> 
  <ul class="cb-slideshow"> 
    <li><span>苟利</span></li> 
    <li><span>国家</span></li> 
    <li><span>生死以</span></li> 
    <li><span>岂能</span></li> 
    <li><span>祸福</span></li> 
    <li><span>趋避之</span></li> 
  </ul>
</section>
<script src="/js/script.js"></script>




  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("Ljd6bJFL9N4tWj6WnGcbYUd2-gzGzoHsz", "xDGMWtxNt0aReJDVkuYmSqBd");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.article-title').length > 1) {
        showTime(Counter);
      }
    });
  </script>





  </div>
</body>
</html>